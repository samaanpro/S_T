<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Train Alert Pro â€” SN</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='a' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23c9a84a'/%3E%3Cstop offset='100%25' style='stop-color:%23e0c77b'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='%230b0f12'/%3E%3Crect x='4' y='4' width='24' height='24' rx='4' fill='url(%23a)'/%3E%3Ctext x='16' y='22' font-family='Arial,sans-serif' font-size='14' font-weight='bold' text-anchor='middle' fill='%230b0f12'%3ESN%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='a' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23c9a84a'/%3E%3Cstop offset='100%25' style='stop-color:%23e0c77b'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='36' fill='%230b0f12'/%3E%3Crect x='20' y='20' width='140' height='140' rx='28' fill='url(%23a)'/%3E%3Ctext x='90' y='115' font-family='Arial,sans-serif' font-size='72' font-weight='bold' text-anchor='middle' fill='%230b0f12'%3ESN%3C/text%3E%3C/svg%3E">
<link rel="manifest" href="data:application/json,{%22name%22:%22Train%20Alert%20Pro%22,%22short_name%22:%22TrainAlert%22,%22icons%22:[{%22src%22:%22data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22}],%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%230b0f12%22,%22theme_color%22:%22%23c9a84a%22}">
<style>
:root{
  --bg-0:#0b0f12; --bg-1:#111417; --card:#121417;
  --muted:#b8b8b8; --gold:#c9a84a; --gold-2:#e0c77b;
  --accent:#6fa7d6; --glass: rgba(255,255,255,0.03); --text:#e8e8e8;
  --success:#4caf50; --warning:#ff9800; --danger:#f44336;
  --gradient-1: linear-gradient(135deg, var(--gold), var(--gold-2));
  --gradient-2: linear-gradient(180deg, var(--bg-0), var(--bg-1));
  --shadow-1: 0 4px 20px rgba(0,0,0,0.15);
  --shadow-2: 0 8px 30px rgba(0,0,0,0.25);
  --shadow-gold: 0 8px 26px rgba(201,168,74,0.35);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --select-bg: rgba(255,255,255,0.02);
  --select-border: rgba(255,255,255,0.08);
  --select-hover: rgba(255,255,255,0.05);
  --select-focus: rgba(201,168,74,0.2);
}
[data-theme="light"]{
  --bg-0:#f6f7f8; --bg-1:#fdfdfd; --card:#ffffff;
  --muted:#6b7280; --gold:#b8860b; --gold-2:#d9b667; --accent:#0b66b3; --text:#06121a;
  --gradient-2: linear-gradient(180deg, #f6f7f8, #fdfdfd);
  --select-bg: rgba(0,0,0,0.02);
  --select-border: rgba(0,0,0,0.08);
  --select-hover: rgba(0,0,0,0.05);
  --select-focus: rgba(184,134,11,0.2);
}
*{box-sizing:border-box; margin:0; padding:0}
html,body{height:100%; font-family:Inter,system-ui,Segoe UI,Roboto,"Noto Sans",Arial; -webkit-font-smoothing:antialiased; background:var(--gradient-2); color:var(--text); overflow-x:hidden}
body{position:relative}
.container{max-width:1200px;margin:14px auto;padding:12px}
.card{background:linear-gradient(180deg,var(--glass), rgba(255,255,255,0.01));border-radius:16px;padding:16px;box-shadow:var(--shadow-2); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.05); transition:var(--transition)}
.card:hover{transform: translateY(-2px); box-shadow:0 12px 40px rgba(0,0,0,0.3)}
.header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 6px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px;background:var(--gradient-1);color:#08120b;box-shadow:var(--shadow-gold); position:relative; overflow:hidden}
.logo::after{content:""; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform:rotate(45deg); animation:shimmer 3s infinite}
@keyframes shimmer{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}100%{transform:translateX(100%) translateY(100%) rotate(45deg)}}
.title{font-weight:800;font-size:20px; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
.subtitle{font-size:13px;color:var(--muted)}
.layout{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:12px;align-items:start}
@media(max-width:1000px){ 
  .layout{grid-template-columns:1fr; grid-template-rows:1fr auto} 
  .left-col{order:1} 
  .right-col{order:2; height:40vh} 
}
.left-col{height:78vh;overflow:auto;border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02); position:relative}
.left-col::before{content:""; position:absolute; top:0; left:0; right:0; height:2px; background:var(--gradient-1); border-radius:12px 12px 0 0}
.controls-row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.input-group {
  position: relative;
  flex: 1;
}
.input-group label {
  display: block;
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 6px;
  font-weight: 600;
}
.input-field {
  width: 100%;
  padding: 14px 40px 14px 16px;
  border-radius: 14px;
  border: 2px solid var(--select-border);
  background: var(--select-bg);
  color: var(--text);
  font-size: 15px;
  font-weight: 500;
  transition: var(--transition);
  backdrop-filter: blur(8px);
  appearance: none;
  cursor: pointer;
  position: relative;
}
.input-field:hover {
  background: var(--select-hover);
  border-color: var(--gold);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(201,168,74,0.15);
}
.input-field:focus {
  outline: none;
  border-color: var(--gold);
  background: var(--select-hover);
  box-shadow: 0 0 0 4px var(--select-focus);
}
.input-field::placeholder {
  color: var(--muted);
  opacity: 0.7;
}
.select-wrapper {
  position: relative;
  width: 100%;
}
.select-wrapper::after {
  content: "â–¼";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gold);
  font-size: 12px;
  pointer-events: none;
  transition: var(--transition);
}
.select-wrapper:hover::after {
  color: var(--gold-2);
  transform: translateY(-50%) scale(1.1);
}
.select-wrapper:focus-within::after {
  transform: translateY(-50%) rotate(180deg);
}
.btn{padding:12px 16px;border-radius:12px;border:0;background:var(--gradient-1);color:#07120b;font-weight:800;cursor:pointer;box-shadow:var(--shadow-gold); transition:var(--transition); position:relative; overflow:hidden}
.btn::before{content:""; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(255,255,255,0.3); transform:translate(-50%, -50%); transition:width 0.6s, height 0.6s}
.btn:active::before{width:300px; height:300px}
.btn:hover{transform: translateY(-2px); box-shadow:0 12px 30px rgba(201,168,74,0.25)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text);font-weight:700; box-shadow:none}
.btn.ghost:hover{background:rgba(255,255,255,0.05); border-color:var(--gold)}
.route-info{margin-top:10px;font-size:13px;color:var(--muted); padding:10px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.03)}
.timeline{display:flex;flex-direction:column;gap:10px;margin-top:12px; position:relative}
.timeline::before{content:""; position:absolute; top:0; bottom:0; right:24px; width:2px; background:linear-gradient(180deg, var(--gold), transparent); z-index:0}
.station{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01);transition:var(--transition); position:relative; z-index:1}
.station:hover{transform: translateX(-3px); background:rgba(255,255,255,0.03); border-color:rgba(255,255,255,0.08)}
.station .rail{width:16px;flex-shrink:0;display:flex;align-items:flex-start;justify-content:center}
.station .dot{width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,0.05);box-shadow:0 6px 14px rgba(0,0,0,0.2);transition:var(--transition); position:relative}
.station .dot::after{content:""; position:absolute; top:50%; left:50%; width:6px; height:6px; border-radius:50%; background:var(--bg-0); transform:translate(-50%, -50%); opacity:0; transition:opacity 0.3}
.station .meta{flex:1;display:flex;flex-direction:column}
.station .name{font-weight:700; font-size:15px}
.station .small{font-size:13px;color:var(--muted)}
@keyframes pulse {
  0%{ box-shadow: 0 0 0 0 rgba(201,168,74,0.4); transform:scale(1); }
  50%{ box-shadow: 0 0 0 10px rgba(201,168,74,0); transform:scale(1.05); }
  100%{ box-shadow: 0 0 0 0 rgba(201,168,74,0); transform:scale(1); }
}
@keyframes glow {
  0%, 100%{ box-shadow: 0 0 5px rgba(201,168,74,0.5); }
  50%{ box-shadow: 0 0 20px rgba(201,168,74,0.8), 0 0 30px rgba(201,168,74,0.4); }
}
.station.active{background:var(--gradient-1);color:#07120b;transform:scale(1.03);box-shadow:var(--shadow-gold); border-color:transparent}
.station.active .dot{background:#fff; box-shadow:0 6px 18px rgba(201,168,74,0.3); animation:pulse 1.5s infinite ease-in-out}
.station.active .dot::after{opacity:1}
.station.next{border-style:dashed; border-color:var(--gold); background:rgba(201,168,74,0.05)}
.station.next .dot{background:var(--gold-2); animation:glow 2s infinite}
.right-col{border-radius:12px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.005), rgba(255,255,255,0.01)); box-shadow:var(--shadow-1)}
.map{height:78vh; position:relative}
.map::after{content:""; position:absolute; bottom:0; left:0; right:0; height:3px; background:var(--gradient-1)}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:13px; padding:10px; background:rgba(255,255,255,0.02); border-radius:10px}
.loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--gradient-2);z-index:9999; backdrop-filter: blur(10px)}
.loader-box{background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.01));padding:24px;border-radius:16px;display:flex;gap:16px;align-items:center;box-shadow:var(--shadow-2); border:1px solid rgba(255,255,255,0.05)}
.spinner{width:60px;height:60px;border-radius:50%;border:6px solid rgba(255,255,255,0.06);border-top-color:var(--gold);animation:spin 1s linear infinite; position:relative}
.spinner::after{content:""; position:absolute; top:6px; left:6px; right:6px; bottom:6px; border-radius:50%; border:3px solid transparent; border-bottom-color:var(--gold-2); animation:spin 0.6s linear infinite reverse}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:600px){ 
  .logo{width:48px;height:48px;font-size:18px} 
  .left-col{padding:10px; height:55vh} 
  .map{height:40vh} 
  .layout{gap:8px}
  .container{margin:8px auto;padding:8px}
  .input-field { padding: 12px 36px 12px 14px; font-size: 14px; }
}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.8);color:#fff;padding:12px 18px;border-radius:12px;z-index:99999; backdrop-filter: blur(10px); box-shadow:var(--shadow-2); animation:slideUp 0.3s ease-out}
@keyframes slideUp{from{transform:translateX(-50%) translateY(100%); opacity:0} to{transform:translateX(-50%) translateY(0); opacity:1}}
.hidden{display:none!important}
.status-indicator{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:20px; font-size:12px; font-weight:600}
.status-indicator.online{background:rgba(76,175,80,0.2); color:var(--success)}
.status-indicator.offline{background:rgba(244,67,54,0.2); color:var(--danger)}
.status-indicator::before{content:""; width:8px; height:8px; border-radius:50%; background:currentColor}
.status-indicator.online::before{animation:blink 2s infinite}
@keyframes blink{0%, 100%{opacity:1} 50%{opacity:0.3}}
.floating-action{position:fixed; bottom:20px; right:20px; width:56px; height:56px; border-radius:50%; background:var(--gradient-1); color:#07120b; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow:var(--shadow-gold); cursor:pointer; z-index:100; transition:var(--transition)}
.floating-action:hover{transform:scale(1.1); box-shadow:0 12px 30px rgba(201,168,74,0.4)}
.floating-action:active{transform:scale(0.95)}
.progress-bar{height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; margin-top:8px}
.progress-bar .progress{height:100%; background:var(--gradient-1); width:0%; transition:width 0.3s}
.notification-badge{position:absolute; top:-5px; right:-5px; width:20px; height:20px; border-radius:50%; background:var(--danger); color:white; font-size:11px; font-weight:700; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.2)}

/* Custom select dropdown styling */
.custom-select {
  position: relative;
  width: 100%;
}

.custom-select select {
  width: 100%;
  padding: 14px 40px 14px 16px;
  border-radius: 14px;
  border: 2px solid var(--select-border);
  background: var(--select-bg);
  color: var(--text);
  font-size: 15px;
  font-weight: 500;
  transition: var(--transition);
  backdrop-filter: blur(8px);
  appearance: none;
  cursor: pointer;
  position: relative;
}

.custom-select select:hover {
  background: var(--select-hover);
  border-color: var(--gold);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(201,168,74,0.15);
}

.custom-select select:focus {
  outline: none;
  border-color: var(--gold);
  background: var(--select-hover);
  box-shadow: 0 0 0 4px var(--select-focus);
}

.custom-select::before {
  content: "ğŸ“";
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  pointer-events: none;
  transition: var(--transition);
  z-index: 1;
}

.custom-select::after {
  content: "â–¼";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gold);
  font-size: 12px;
  pointer-events: none;
  transition: var(--transition);
  z-index: 1;
}

.custom-select:hover::after {
  color: var(--gold-2);
  transform: translateY(-50%) scale(1.1);
}

.custom-select select:focus + .custom-select::after {
  transform: translateY(-50%) rotate(180deg);
}

/* Enhanced option styling */
.custom-select option {
  background: var(--card);
  color: var(--text);
  padding: 12px 16px;
  border: none;
  font-weight: 500;
}

.custom-select option:hover {
  background: var(--select-hover);
}

/* Animation for select focus */
@keyframes selectGlow {
  0% { box-shadow: 0 0 0 0 var(--select-focus); }
  50% { box-shadow: 0 0 0 8px var(--select-focus); }
  100% { box-shadow: 0 0 0 0 var(--select-focus); }
}

.custom-select select:focus {
  animation: selectGlow 0.5s ease-out;
}

/* Dark mode specific enhancements */
[data-theme="dark"] .custom-select::before {
  filter: brightness(1.2);
}

/* Light mode specific enhancements */
[data-theme="light"] .custom-select::before {
  filter: brightness(0.8);
}

/* Mobile optimizations */
@media (max-width: 600px) {
  .custom-select select {
    padding: 12px 36px 12px 14px;
    font-size: 14px;
  }
  
  .custom-select::before {
    right: 12px;
    font-size: 14px;
  }
  
  .custom-select::after {
    left: 14px;
    font-size: 11px;
  }
}
</style>
</head>
<body data-theme="dark">
  <div id="loading" class="loading" aria-hidden="false">
    <div class="loader-box">
      <div class="spinner" aria-hidden="true"></div>
      <div>
        <div style="font-weight:800;font-size:20px">Train Alert Pro</div>
        <div style="color:var(--muted)">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€” Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©</div>
        <div class="progress-bar" style="margin-top:12px">
          <div class="progress" id="loadingProgress"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card" role="application" aria-label="Train Alert Pro">
      <div class="header">
        <div class="brand">
          <div class="logo">SN</div>
          <div>
            <div class="title">Train Alert Pro</div>
            <div class="subtitle">Ø®Ø· Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ© â†” Ø£Ø³ÙˆØ§Ù† â€” Created by Samaan Nady</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="status-indicator online" id="connectionStatus">Ù…ØªØµÙ„</div>
          <div class="small" id="notifStatus">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ØºÙŠØ± Ù…Ø¹Ø·Ù„Ø©</div>
          <button id="themeBtn" class="btn ghost" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ÙˆØ¶Ø¹</button>
        </div>
      </div>

      <div class="layout">
        <div class="left-col" id="leftCol">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:900">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø­Ù„Ø©</div>
              <div class="route-info small">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø«Ù… Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ÙˆØµÙˆÙ„</div>
            </div>
            <div style="text-align:center">
              <div style="font-weight:800;color:var(--gold)">ğŸš† SN</div>
              <div class="small" style="color:var(--muted)">Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</div>
            </div>
          </div>

          <div class="controls-row" style="margin-top:12px">
            <div class="input-group">
              <input id="waInput" class="input-field" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" aria-label="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨"/>
            </div>
            <div class="input-group">
              <input id="emailInput" class="input-field" placeholder="Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" aria-label="Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"/>
            </div>
          </div>

          <div class="controls-row" style="margin-top:10px">
            <div class="input-group">
              <label>Ù…Ù† (Ù…Ø­Ø·Ø© Ø§Ù„Ù‚ÙŠØ§Ù…)</label>
              <div class="custom-select">
                <select id="startSelect" aria-label="Ù…Ø­Ø·Ø© Ø§Ù„Ù‚ÙŠØ§Ù…"></select>
              </div>
            </div>
            <div class="input-group">
              <label>Ø¥Ù„Ù‰ (Ù…Ø­Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„)</label>
              <div class="custom-select">
                <select id="destSelect" aria-label="Ù…Ø­Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„"></select>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="beginBtn" class="btn" style="flex:1">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹ ğŸš€</button>
            <button id="simBtn" class="btn ghost" style="width:140px">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
            <button id="stopBtn" class="btn ghost" style="width:110px">Ø¥ÙŠÙ‚Ø§Ù</button>
          </div>

          <div id="routeInfo" class="route-info"></div>
          <div class="progress-bar">
            <div class="progress" id="routeProgress"></div>
          </div>
          <div id="timeline" class="timeline" aria-live="polite"></div>
        </div>
        <div class="right-col">
          <div id="map" class="map" role="region" aria-label="Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³Ø§Ø±"></div>
        </div>
      </div>

      <div class="footer">
        <div>Ù…Ø¬Ø§Ù†Ø§Ù‹ 100% â€¢ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ â€¢ ØªØµÙ…ÙŠÙ… Ø°Ù‡Ø¨ÙŠ/Ø±Ù…Ø§Ø¯ÙŠ</div>
        <div>ğŸš† <strong>Samaan Nady</strong></div>
      </div>
    </div>
  </div>

  <div class="floating-action" id="floatingBtn" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©">
    âš™ï¸
    <div class="notification-badge hidden" id="notificationBadge">0</div>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Enhanced Service Worker for background operation and cross-tab communication
const swCode = `
const CACHE_NAME = 'train-alert-pro-v1';
const URLS_TO_CACHE = [
  '/',
  'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
  'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
];

// Install event - cache resources
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        return cache.addAll(URLS_TO_CACHE);
      })
  );
});

// Fetch event - serve from cache when offline
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        // Cache hit - return response
        if (response) {
          return response;
        }
        return fetch(event.request);
      }
    )
  );
});

// Background sync
self.addEventListener('sync', event => {
  if (event.tag === 'sync-positions') {
    event.waitUntil(syncPositions());
  }
});

// Cross-tab communication
self.addEventListener('message', event => {
  if (event.data && event.data.type === 'TAB_UPDATED') {
    // Broadcast to all other tabs
    event.waitUntil(
      self.clients.matchAll().then(clients => {
        clients.forEach(client => {
          if (client.id !== event.source.id) {
            client.postMessage({
              type: 'OTHER_TAB_UPDATED',
              data: event.data.data
            });
          }
        });
      })
    );
  }
});

function syncPositions() {
  return new Promise((resolve, reject) => {
    // This would sync stored positions to a server
    // For now, we'll just resolve
    resolve();
  });
}
`;

// Register Service Worker
if ('serviceWorker' in navigator) {
  const blob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(blob);
  
  navigator.serviceWorker.register(swUrl)
    .then(reg => {
      console.log('Service Worker registered');
      
      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    })
    .catch(err => {
      console.log('Service Worker registration failed: ', err);
    });
}

/* Stations EXACT ORDER provided by you */
const STATIONS = [
  { name:"Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", lat:31.2001, lng:29.9187 },
  { name:"Ø³ÙŠØ¯ÙŠ Ø¬Ø§Ø¨Ø±", lat:31.2058, lng:29.9417 },
  { name:"Ø¯Ù…Ù†Ù‡ÙˆØ±", lat:31.0364, lng:30.4707 },
  { name:"Ø·Ù†Ø·Ø§", lat:30.7866, lng:31.0004 },
  { name:"Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", lat:30.0444, lng:31.2357 },
  { name:"ØµØ¹ÙŠØ¯ Ù…ØµØ±", lat:29.9668, lng:31.2500 }, // generic center for "ØµØ¹ÙŠØ¯ Ù…ØµØ±"
  { name:"Ø§Ù„Ø¬ÙŠØ²Ø©", lat:30.0131, lng:31.2089 },
  { name:"Ø§Ù„ÙˆØ§Ø³Ø·ÙŠ", lat:27.6950, lng:30.9200 }, // approx (Ø§Ù„ÙˆØ§Ø³Ø·ÙŠ Ù‚Ø±Ø¨ Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ)
  { name:"Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ", lat:29.0668, lng:31.0988 },
  { name:"Ù…ØºØ§ØºØ©", lat:27.9231, lng:30.8400 }, // approx maghagha/Ù…Ù†ÙŠØ§ region
  { name:"Ø§Ù„Ù…Ù†ÙŠØ§", lat:28.1010, lng:30.7485 },
  { name:"Ù…Ù„ÙˆÙŠ", lat:28.7120, lng:30.8150 },
  { name:"Ø¯ÙŠØ±ÙˆØ·", lat:27.3000, lng:31.4000 },
  { name:"Ø§Ø³ÙŠÙˆØ·", lat:27.1783, lng:31.1858 },
  { name:"Ø·Ù…Ø§", lat:26.9500, lng:31.8000 }, // approximate coordinate for Ø·Ù…Ø§
  { name:"Ø·Ù‡Ø·Ø§", lat:26.5700, lng:31.6700 },
  { name:"Ø³ÙˆÙ‡Ø§Ø¬", lat:26.5560, lng:31.6956 },
  { name:"Ø¬Ø±Ø¬Ø§", lat:26.2165, lng:31.5294 },
  { name:"Ø§Ù„Ø¨Ù„ÙŠÙ†Ø§", lat:26.2500, lng:32.3000 }, // approximate
  { name:"Ù†Ø¬Ø¹ Ø­Ù…Ø§Ø¯ÙŠ", lat:26.1803, lng:31.6958 },
  { name:"Ù‚Ù†Ø§", lat:26.1553, lng:32.7160 },
  { name:"Ù‚ÙˆØµ", lat:25.9470, lng:32.7180 }, // adjusted
  { name:"Ø§Ù„Ø§Ù‚ØµØ±", lat:25.6872, lng:32.6396 },
  { name:"Ø§Ø±Ù…Ù†Øª", lat:25.6637, lng:32.5636 },
  { name:"Ø§Ø³Ù†Ø§", lat:25.2990, lng:32.6420 },
  { name:"Ø§Ù„Ø³Ø¨Ø§Ø¹ÙŠØ©", lat:25.0500, lng:32.7000 }, // approximate
  { name:"Ø§Ø¯ÙÙˆ", lat:24.9739, lng:32.8758 },
  { name:"Ø³Ù„ÙˆØ§", lat:24.8000, lng:32.9000 }, // approximate (Ø³Ù„ÙˆÙ‰/Ø³Ù„ÙˆÙ‰)
  { name:"ÙƒÙ„Ø§Ø¨Ø´Ø©", lat:24.5660, lng:32.9000 }, // approximate
  { name:"ÙƒÙˆÙ… Ø§Ù…Ø¨Ùˆ", lat:24.4599, lng:32.9450 },
  { name:"Ø¯Ø±Ø§Ùˆ", lat:24.3500, lng:32.8610 },
  { name:"Ø§Ø³ÙˆØ§Ù†", lat:24.0890, lng:32.8998 }
];

/* State */
let map, routeLine, userMarker, trainMarker;
let watchId = null, simId = null;
let lastPos = null, lastTs = null;
let audioCtx = null, ringTimer = null;
let preWarnedAt = null, arrivedFlag = false;
let routeIndices = []; // indices between start and dest in order
let wakeLock = null;
let isOnline = navigator.onLine;
let notificationCount = 0;
let backgroundSyncSupported = 'serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype;
let tabId = Date.now().toString(); // Unique ID for this tab
let isMainTab = false; // Flag to indicate if this is the main tracking tab
let trackingState = {
  active: false,
  startIdx: 0,
  destIdx: STATIONS.length - 1,
  wa: '',
  email: ''
};

// Cross-tab communication using BroadcastChannel
let broadcastChannel = null;
if ('BroadcastChannel' in window) {
  broadcastChannel = new BroadcastChannel('train-alert-pro');
  
  broadcastChannel.onmessage = event => {
    if (event.data.type === 'TRACKING_STATE_UPDATE') {
      // Update local state with data from another tab
      trackingState = event.data.state;
      
      // If tracking is active in another tab, update UI accordingly
      if (trackingState.active && !isMainTab) {
        updateUIFromTrackingState();
        showToast('Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¹Ù…Ù„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±');
      }
    } else if (event.data.type === 'POSITION_UPDATE') {
      // Update position from another tab
      if (!isMainTab) {
        updatePosition(
          event.data.lat,
          event.data.lng,
          event.data.accuracy,
          event.data.ts
        );
      }
    }
  };
}

// Enhanced Web Worker for background processing
const workerCode = `
let stations = [];
let routeIndices = [];

self.onmessage = function(e) {
  switch(e.data.type) {
    case 'SETUP':
      stations = e.data.stations;
      routeIndices = e.data.routeIndices;
      break;
    case 'CALCULATE_POSITION':
      const { lat, lng, startIdx, destIdx } = e.data;
      const nearest = findNearestStation(lat, lng);
      const inRoutePos = routeIndices.indexOf(nearest.idx);
      
      let remaining = 0;
      if(inRoutePos !== -1) {
        remaining = routeIndices.length - 1 - inRoutePos;
      } else {
        remaining = Math.abs(destIdx - nearest.idx);
      }
      
      const remainingKm = haversineKm(lat, lng, stations[destIdx].lat, stations[destIdx].lng);
      
      self.postMessage({
        type: 'POSITION_RESULT',
        nearest: nearest,
        inRoutePos: inRoutePos,
        remaining: remaining,
        remainingKm: remainingKm
      });
      break;
  }
};

function findNearestStation(lat, lng) {
  let min = Infinity, idx = 0;
  stations.forEach((s, i) => {
    const d = haversineKm(lat, lng, s.lat, s.lng);
    if(d < min) {
      min = d;
      idx = i;
    }
  });
  return { idx, distKm: min };
}

function haversineKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}
`;
const blob = new Blob([workerCode], { type: 'application/javascript' });
const worker = new Worker(URL.createObjectURL(blob));

worker.onmessage = function(e) {
  if (e.data.type === 'POSITION_RESULT') {
    // Update UI with worker calculation results
    const { nearest, inRoutePos, remaining, remainingKm } = e.data;
    
    // Update route info
    const nearestStation = STATIONS[nearest.idx];
    document.getElementById('routeInfo').textContent = 
      `Ø£Ù‚Ø±Ø¨: ${nearestStation.name} Â· Ù…ØªØ¨Ù‚ÙŠ: ${remaining} Ù…Ø­Ø·Ø© Â· ${remainingKm.toFixed(2)} ÙƒÙ…`;
  }
};

/* Connection status monitoring */
window.addEventListener('online', () => {
  isOnline = true;
  updateConnectionStatus();
  showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
});

window.addEventListener('offline', () => {
  isOnline = false;
  updateConnectionStatus();
  showToast('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†ØªØŒ ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„');
});

function updateConnectionStatus() {
  const statusEl = document.getElementById('connectionStatus');
  if (isOnline) {
    statusEl.textContent = 'Ù…ØªØµÙ„';
    statusEl.className = 'status-indicator online';
  } else {
    statusEl.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
    statusEl.className = 'status-indicator offline';
  }
}

/* Helpers */
function toRad(v){ return v * Math.PI / 180; }
function haversineKm(lat1,lon1,lat2,lon2){
  const R = 6371;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}
function formatETA(sec){
  if(!isFinite(sec) || sec<=0) return 'â€”';
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
  return h>0? `${h}h ${m}m` : `${m}m`;
}
function showToast(msg, ms=3000){ 
  const t = document.getElementById('toast'); 
  t.textContent = msg; 
  t.classList.remove('hidden'); 
  setTimeout(()=> t.classList.add('hidden'), ms); 
}

/* Audio & vibration */
function ensureAudio(){ 
  if(!audioCtx){ 
    try{ 
      audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 
    }catch(e){ 
      audioCtx = null; 
    } 
  } 
}
function playBeep(freq=880,dur=200){ 
  try{ 
    ensureAudio(); 
    if(!audioCtx){ 
      navigator.vibrate && navigator.vibrate(150); 
      return; 
    } 
    const o = audioCtx.createOscillator(); 
    const g = audioCtx.createGain(); 
    o.type='sine'; 
    o.frequency.value=freq; 
    g.gain.value=0.0001; 
    o.connect(g); 
    g.connect(audioCtx.destination); 
    const now = audioCtx.currentTime; 
    g.gain.setValueAtTime(0.0001, now); 
    g.gain.exponentialRampToValueAtTime(0.12, now+0.02); 
    g.gain.exponentialRampToValueAtTime(0.0001, now+(dur/1000)); 
    o.start(now); 
    o.stop(now+(dur/1000)); 
    navigator.vibrate && navigator.vibrate([160,80,160]); 
  }catch(e){ 
    navigator.vibrate && navigator.vibrate(200); 
  } 
}
function startRing(){ 
  if(ringTimer) return; 
  playBeep(440,300); 
  ringTimer = setInterval(()=>playBeep(440,300),800); 
}
function stopRing(){ 
  if(ringTimer){ 
    clearInterval(ringTimer); 
    ringTimer = null; 
  } 
}

/* Map init with performance optimizations */
function initMap(){
  map = L.map('map', { 
    preferCanvas:true, 
    zoomControl:true,
    updateWhenZooming: false,
    updateWhenIdle: true,
    worldCopyJump: true
  }).setView([STATIONS[Math.floor(STATIONS.length/2)].lat, STATIONS[Math.floor(STATIONS.length/2)].lng], 7);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom:19,
    updateWhenIdle: true,
    updateWhenZooming: false,
    reuseTiles: true
  }).addTo(map);
  
  const latlngs = STATIONS.map(s=>[s.lat,s.lng]);
  routeLine = L.polyline(latlngs, { color: '#c9a84a', weight:4, opacity:0.95 }).addTo(map);
  
  // Use canvas markers for better performance
  STATIONS.forEach((s,i)=> {
    const marker = L.circleMarker([s.lat,s.lng], { 
      radius:5, 
      fillColor:'#c9a84a', 
      color:'#fff', 
      weight:0, 
      fillOpacity:1 
    }).addTo(map);
    
    // Only bind tooltip to visible markers
    if (i < 10 || i > STATIONS.length - 10) {
      marker.bindTooltip(`${i+1}. ${s.name}`);
    }
  });
  
  trainMarker = L.marker([STATIONS[0].lat, STATIONS[0].lng], { title:'Ù‚Ø·Ø§Ø±' }).addTo(map);
  userMarker = L.circleMarker([STATIONS[0].lat, STATIONS[0].lng], { 
    radius:7, 
    fillColor:'#ff5a5f', 
    color:'#fff', 
    weight:1, 
    fillOpacity:1 
  }).addTo(map);
  
  map.fitBounds(latlngs);
  
  // Optimize map rendering
  map._onResize = function() {
    if (this._timer) clearTimeout(this._timer);
    this._timer = setTimeout(L.bind(this._resetView, this), 100);
  };
}

// Throttled functions for better performance
function throttle(func, limit) {
  let inThrottle;
  return function() {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  }
}

function setUserMarker(lat,lng){ 
  if(userMarker) userMarker.setLatLng([lat,lng]); 
  else userMarker = L.circleMarker([lat,lng]).addTo(map); 
}
function setTrainMarker(lat,lng){ 
  if(trainMarker) trainMarker.setLatLng([lat,lng]); 
  else trainMarker = L.marker([lat,lng]).addTo(map); 
}

// Throttled panTo for better performance
const panTo = throttle(function(lat,lng){ 
  if (map) {
    map.panTo([lat,lng]);
  }
}, 200);

/* Build selects & timeline */
function buildSelects(){
  const startSel = document.getElementById('startSelect'), destSel = document.getElementById('destSelect');
  startSel.innerHTML=''; destSel.innerHTML='';
  STATIONS.forEach((s,i)=>{
    const o1 = document.createElement('option'); o1.value = i; o1.textContent = `${i+1} - ${s.name}`; startSel.appendChild(o1);
    const o2 = document.createElement('option'); o2.value = i; o2.textContent = `${i+1} - ${s.name}`; destSel.appendChild(o2);
  });
  startSel.value = 0; destSel.value = STATIONS.length - 1;
}
function buildRoute(){
  const start = +document.getElementById('startSelect').value;
  const dest = +document.getElementById('destSelect').value;
  routeIndices = [];
  if(start === dest) routeIndices = [start];
  else if(start < dest) for(let i=start;i<=dest;i++) routeIndices.push(i);
  else for(let i=start;i>=dest;i--) routeIndices.push(i);
  
  // Update tracking state
  trackingState.startIdx = start;
  trackingState.destIdx = dest;
  
  renderTimeline();
  const latlngs = routeIndices.map(i=>[STATIONS[i].lat, STATIONS[i].lng]);
  if(latlngs.length) map.fitBounds(latlngs, { padding:[60,60] });
  document.getElementById('routeInfo').textContent = `Ø§Ù„Ù…Ø³Ø§Ø±: ${STATIONS[start].name} â†’ ${STATIONS[dest].name} Â· Ù…Ø­Ø·Ø§Øª: ${routeIndices.length}`;
  
  // Update worker with new route
  worker.postMessage({
    type: 'SETUP',
    stations: STATIONS,
    routeIndices: routeIndices
  });
}
function renderTimeline(){
  const t = document.getElementById('timeline'); 
  t.innerHTML = '';
  
  // Use document fragment for better performance
  const fragment = document.createDocumentFragment();
  
  routeIndices.forEach((idx,pos)=>{
    const s = STATIONS[idx];
    const el = document.createElement('div'); 
    el.className = 'station'; 
    el.dataset.idx = idx;
    el.innerHTML = `<div class="rail"><div class="dot"></div></div><div class="meta"><div class="name">${s.name}</div><div class="small">#${idx+1}</div></div><div style="font-weight:800;color:var(--muted)">${pos+1}</div>`;
    fragment.appendChild(el);
  });
  
  t.appendChild(fragment);
}

/* Nearest finder */
function findNearestStation(lat,lng){
  let min = Infinity, idx = 0;
  STATIONS.forEach((s,i)=>{
    const d = haversineKm(lat,lng,s.lat,s.lng);
    if(d < min){ min = d; idx = i; }
  });
  return { idx, distKm:min };
}

/* Core update position with performance optimizations */
let lastNearestIdx = -1;
let updateQueue = [];
let processingUpdate = false;

function updatePosition(lat,lng,accuracy,ts = Date.now()){
  // Queue updates to prevent overwhelming the UI
  updateQueue.push({ lat, lng, accuracy, ts });
  
  if (!processingUpdate) {
    processUpdateQueue();
  }
}

function processUpdateQueue() {
  if (updateQueue.length === 0) {
    processingUpdate = false;
    return;
  }
  
  processingUpdate = true;
  const { lat, lng, accuracy, ts } = updateQueue.pop();
  
  // Use requestAnimationFrame for smoother updates
  requestAnimationFrame(() => {
    setUserMarker(lat,lng);
    setTrainMarker(lat,lng);
    panTo(lat,lng);

    const nearest = findNearestStation(lat,lng);
    const nearestGlobal = nearest.idx;
    const inRoutePos = routeIndices.indexOf(nearestGlobal);

    // Batch DOM updates
    const stationsToUpdate = [];
    document.querySelectorAll('.station').forEach(el => { 
      const idx = parseInt(el.dataset.idx);
      el.classList.remove('active','next'); 
      el.querySelector('.dot').style.background = 'rgba(255,255,255,0.05)';
      stationsToUpdate.push({ el, idx });
    });

    if(inRoutePos !== -1){
      const curIdx = routeIndices[inRoutePos];
      const curEl = document.querySelector(`.station[data-idx="${curIdx}"]`);
      if(curEl){ 
        curEl.classList.add('active'); 
        curEl.querySelector('.dot').style.background = '#fff'; 
      }
      const nextPos = inRoutePos + 1;
      if(nextPos < routeIndices.length){
        const nextIdx = routeIndices[nextPos];
        const nextEl = document.querySelector(`.station[data-idx="${nextIdx}"]`);
        if(nextEl){ 
          nextEl.classList.add('next'); 
          nextEl.querySelector('.dot').style.background = 'var(--gold-2)'; 
        }
      }
      // Update progress bar
      const progress = ((inRoutePos + 1) / routeIndices.length) * 100;
      document.getElementById('routeProgress').style.width = `${progress}%`;
    } else {
      const elg = document.querySelector(`.station[data-idx="${nearestGlobal}"]`);
      if(elg){ 
        elg.classList.add('next'); 
        elg.querySelector('.dot').style.background = 'var(--gold-2)'; 
      }
    }

    // remaining stops
    let remaining = 0;
    if(inRoutePos !== -1) remaining = routeIndices.length - 1 - inRoutePos;
    else { const dest = +document.getElementById('destSelect').value; remaining = Math.abs(dest - nearestGlobal); }

    const destIndex = +document.getElementById('destSelect').value;
    const remainingKm = haversineKm(lat,lng, STATIONS[destIndex].lat, STATIONS[destIndex].lng);

    // speed
    let speedKmh = 0;
    if(lastPos && lastTs){
      const dkm = haversineKm(lastPos.lat,lastPos.lng,lat,lng);
      const dt = (ts - lastTs)/1000;
      if(dt > 0) speedKmh = (dkm/dt)*3600;
    }
    const effSpeed = speedKmh > 3 ? speedKmh : 60;
    const etaSec = (remainingKm / effSpeed) * 3600;
    
    // Update route info
    document.getElementById('routeInfo').textContent = 
      `Ø£Ù‚Ø±Ø¨: ${STATIONS[nearestGlobal].name} Â· Ù…ØªØ¨Ù‚ÙŠ: ${remaining} Ù…Ø­Ø·Ø© Â· ${remainingKm.toFixed(2)} km Â· Ø³Ø±Ø¹Ø©: ${speedKmh>0.2?speedKmh.toFixed(1)+' km/h':'â€”'} Â· ETA: ${formatETA(etaSec)}`;

    // Send data to worker for background processing
    if (worker) {
      worker.postMessage({
        type: 'CALCULATE_POSITION',
        lat, lng,
        startIdx: +document.getElementById('startSelect').value,
        destIdx: destIndex
      });
    }

    // Broadcast position update to other tabs
    if (broadcastChannel && isMainTab) {
      broadcastChannel.postMessage({
        type: 'POSITION_UPDATE',
        lat, lng, accuracy, ts
      });
    }

    // pre-warn: remaining == 2
    if(remaining === 2 && preWarnedAt !== nearestGlobal){
      preWarnedAt = nearestGlobal;
      preWarnAction(STATIONS[nearestGlobal], remainingKm);
    }

    // arrival
    if((remaining === 0 || remainingKm <= 0.6) && !arrivedFlag){
      arrivedFlag = true;
      arrivalAction(STATIONS[destIndex]);
    } else if(!(remaining === 0 || remainingKm <= 0.6)){
      arrivedFlag = false;
    }

    lastPos = { lat, lng }; lastTs = ts;
    
    // Process next update in queue
    setTimeout(() => processUpdateQueue(), 50);
  });
}

/* Actions */
function preWarnAction(station, km){
  playBeep(1200,160);
  navigator.vibrate && navigator.vibrate([200,80,200]);
  notify(`${station.name} â€” Ù‚Ø¨Ù„ Ù…Ø­Ø·ØªÙŠÙ†`, `ØªØ¨Ù‚Ù‰ Ø­ÙˆØ§Ù„ÙŠ ${km.toFixed(2)} ÙƒÙ…`);
  incrementNotificationCount();
  // Enhanced pulse animation
  const el = document.querySelector(`.station[data-idx="${STATIONS.indexOf(station)}"]`);
  if(el) {
    el.animate([
      {transform:'scale(1)', boxShadow:'0 0 0 0 rgba(201,168,74,0.4)'},
      {transform:'scale(1.05)', boxShadow:'0 0 20px 10px rgba(201,168,74,0)'},
      {transform:'scale(1)', boxShadow:'0 0 0 0 rgba(201,168,74,0)'}
    ],{duration:1000});
  }
}
function arrivalAction(station){
  startRing();
  navigator.vibrate && navigator.vibrate([300,120,300,120,300]);
  notify(`ÙˆØµÙ„Øª ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹: ${station.name}`, 'ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØªØ¹Ù„Ù‚Ø§ØªÙƒ ÙˆØ§Ù†Ø²Ù„ Ø¨Ø£Ù…Ø§Ù†');
  incrementNotificationCount();
  setTimeout(()=> {
    const ok = confirm(`ÙˆØµÙ„Øª Ø¥Ù„Ù‰ ${station.name}. Ø§Ø¶ØºØ· OK Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡.`);
    if(ok){ stopRing(); arrivedFlag = false; }
  }, 700);
}
function notify(title, body){
  if('Notification' in window && Notification.permission === 'granted'){
    try{ 
      const n = new Notification(title, { 
        body,
        icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
        badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
        tag: 'train-alert',
        requireInteraction: true
      }); 
      setTimeout(()=>n.close(),7000); 
    }catch(e){}
  } else { 
    showToast(title + (body? ' â€” ' + body : '')); 
  }
}

function incrementNotificationCount() {
  notificationCount++;
  const badge = document.getElementById('notificationBadge');
  badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
  badge.classList.remove('hidden');
}

/* Geolocation & simulation */
function startTracking(){
  if(!('geolocation' in navigator)){ 
    alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); 
    return; 
  }
  
  // Set this tab as the main tracking tab
  isMainTab = true;
  trackingState.active = true;
  
  // Broadcast tracking state to other tabs
  if (broadcastChannel) {
    broadcastChannel.postMessage({
      type: 'TRACKING_STATE_UPDATE',
      state: trackingState
    });
  }
  
  if('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied'){
    Notification.requestPermission().then(p => {
      document.getElementById('notifStatus').textContent = 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ' + (p==='granted'?'Ù…ÙØ¹Ù„Ø©':'Ù…ÙˆÙ‚ÙˆÙØ©');
      if (p === 'granted') {
        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      }
    });
  } else {
    document.getElementById('notifStatus').textContent = 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ' + (Notification.permission==='granted'?'Ù…ÙØ¹Ù„Ø©':'Ù…ÙˆÙ‚ÙˆÙØ©');
  }

  try{ 
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 
    if(audioCtx.state === 'suspended') audioCtx.resume(); 
  }catch(e){}

  // try Wake Lock to keep screen awake while tracking (best-effort)
  tryWakeLock();

  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(p => {
    updatePosition(p.coords.latitude, p.coords.longitude, p.coords.accuracy, p.timestamp || Date.now());
    
    // Store position for background sync
    if (backgroundSyncSupported) {
      storePositionForSync({
        lat: p.coords.latitude,
        lng: p.coords.longitude,
        accuracy: p.coords.accuracy,
        timestamp: p.timestamp || Date.now()
      });
    }
  }, err => {
    console.warn('geo error', err);
    showToast('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.');
  }, { 
    enableHighAccuracy:true, 
    maximumAge:1000, 
    timeout:20000 
  });
}

function stopTracking(){
  if(watchId){ 
    navigator.geolocation.clearWatch(watchId); 
    watchId = null; 
  }
  stopSimulation();
  stopRing();
  releaseWakeLock();
  
  // Update tracking state
  trackingState.active = false;
  
  // Broadcast tracking state to other tabs
  if (broadcastChannel) {
    broadcastChannel.postMessage({
      type: 'TRACKING_STATE_UPDATE',
      state: trackingState
    });
  }
  
  // Reset main tab flag
  isMainTab = false;
}

/* Simulation */
function startSimulation(){
  stopSimulation();
  const start = +document.getElementById('startSelect').value;
  const dest = +document.getElementById('destSelect').value;
  let idx = start;
  let dir = dest >= start ? 1 : -1;
  let t = 0;
  simId = setInterval(()=>{
    const a = STATIONS[idx];
    const b = STATIONS[idx + dir];
    if(!a || !b){ 
      clearInterval(simId); 
      simId = null; 
      return; 
    }
    const lat = a.lat + (b.lat - a.lat) * t;
    const lng = a.lng + (b.lng - a.lng) * t;
    updatePosition(lat,lng,10,Date.now());
    setTrainMarker(lat,lng);
    panTo(lat,lng);
    const segDist = haversineKm(a.lat,a.lng,b.lat,b.lng);
    const speedKmPerSec = 60/3600;
    const delta = (speedKmPerSec * 1) / (segDist || 0.001);
    t += delta;
    if(t >= 1){ 
      t = 0; 
      idx += dir; 
      if((dir === 1 && idx > dest) || (dir === -1 && idx < dest)){ 
        clearInterval(simId); 
        simId = null; 
      } 
    }
  }, 1000);
}
function stopSimulation(){ 
  if(simId){ 
    clearInterval(simId); 
    simId = null; 
  } 
}

/* Wake Lock best-effort */
async function tryWakeLock(){
  if('wakeLock' in navigator && !wakeLock){
    try{
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', ()=>{ 
        wakeLock = null; 
        console.log('Wake lock released'); 
      });
      console.log('Wake lock acquired');
    }catch(e){ 
      console.warn('WakeLock failed', e); 
    }
  }
}
async function releaseWakeLock(){
  try{ 
    if(wakeLock){ 
      await wakeLock.release(); 
      wakeLock = null; 
    } 
  }catch(e){}
}

/* Background Sync */
function storePositionForSync(position) {
  if (!('indexedDB' in window)) return;
  
  const request = indexedDB.open('trainAlertDB', 1);
  
  request.onerror = function(event) {
    console.error('IndexedDB error:', event.target.error);
  };
  
  request.onupgradeneeded = function(event) {
    const db = event.target.result;
    if (!db.objectStoreNames.contains('positions')) {
      db.createObjectStore('positions', { keyPath: 'timestamp' });
    }
  };
  
  request.onsuccess = function(event) {
    const db = event.target.result;
    const transaction = db.transaction(['positions'], 'readwrite');
    const store = transaction.objectStore('positions');
    store.add(position);
  };
}

function registerBackgroundSync() {
  if (!backgroundSyncSupported) return;
  
  navigator.serviceWorker.ready.then(registration => {
    return registration.sync.register('sync-positions');
  }).then(() => {
    console.log('Background sync registered');
  }).catch(err => {
    console.error('Background sync registration failed:', err);
  });
}

/* Update UI from tracking state */
function updateUIFromTrackingState() {
  // Update selects
  document.getElementById('startSelect').value = trackingState.startIdx;
  document.getElementById('destSelect').value = trackingState.destIdx;
  
  // Update inputs
  document.getElementById('waInput').value = trackingState.wa;
  document.getElementById('emailInput').value = trackingState.email;
  
  // Rebuild route
  buildRoute();
}

/* UI wiring & persistence */
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', cur === 'light' ? 'dark' : 'light');
  localStorage.setItem('theme', cur === 'light' ? 'dark' : 'light');
});

document.getElementById('startSelect').addEventListener('change', buildRoute);
document.getElementById('destSelect').addEventListener('change', buildRoute);

document.getElementById('beginBtn').addEventListener('click', ()=>{
  const wa = document.getElementById('waInput').value.trim();
  const em = document.getElementById('emailInput').value.trim();
  
  // Validate inputs
  if (wa && !/^[\d\s\+\-\(\)]+$/.test(wa)) {
    showToast('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­');
    return;
  }
  
  if (em && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)) {
    showToast('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
    return;
  }
  
  // Update tracking state
  trackingState.wa = wa;
  trackingState.email = em;
  
  if (wa) localStorage.setItem('ta_phone', wa);
  if (em) localStorage.setItem('ta_email', em);
  
  buildRoute();
  startTracking();
  registerBackgroundSync();
});

document.getElementById('stopBtn').addEventListener('click', ()=> stopTracking());

document.getElementById('simBtn').addEventListener('click', ()=> {
  if(simId){ 
    stopSimulation(); 
    document.getElementById('simBtn').textContent = 'ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©'; 
  } else { 
    buildRoute(); 
    startSimulation(); 
    document.getElementById('simBtn').textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©'; 
  }
});

document.getElementById('waInput').addEventListener('change', (e)=> {
  const value = e.target.value.trim();
  if (value && /^[\d\s\+\-\(\)]+$/.test(value)) {
    localStorage.setItem('ta_phone', value);
    trackingState.wa = value;
  } else if (value) {
    showToast('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­');
  }
});

document.getElementById('emailInput').addEventListener('change', (e)=> {
  const value = e.target.value.trim();
  if (value && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
    localStorage.setItem('ta_email', value);
    trackingState.email = value;
  } else if (value) {
    showToast('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
  }
});

// Floating button for quick settings
document.getElementById('floatingBtn').addEventListener('click', () => {
  const badge = document.getElementById('notificationBadge');
  badge.classList.add('hidden');
  notificationCount = 0;
  
  // Create a simple settings panel
  const settingsPanel = document.createElement('div');
  settingsPanel.className = 'card';
  settingsPanel.style.position = 'fixed';
  settingsPanel.style.bottom = '80px';
  settingsPanel.style.right = '20px';
  settingsPanel.style.width = '300px';
  settingsPanel.style.zIndex = '1000';
  settingsPanel.innerHTML = `
    <h3 style="margin-bottom: 10px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
    <div style="margin-bottom: 10px">
      <label style="display: flex; align-items: center; gap: 8px">
        <input type="checkbox" id="soundEnabled" checked>
        <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</span>
      </label>
    </div>
    <div style="margin-bottom: 10px">
      <label style="display: flex; align-items: center; gap: 8px">
        <input type="checkbox" id="vibrationEnabled" checked>
        <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²</span>
      </label>
    </div>
    <div style="margin-bottom: 10px">
      <label style="display: flex; align-items: center; gap: 8px">
        <input type="checkbox" id="notificationsEnabled" checked>
        <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
      </label>
    </div>
    <button id="closeSettings" class="btn" style="width: 100%">Ø¥ØºÙ„Ø§Ù‚</button>
  `;
  
  document.body.appendChild(settingsPanel);
  
  document.getElementById('closeSettings').addEventListener('click', () => {
    document.body.removeChild(settingsPanel);
  });
  
  // Save settings
  document.getElementById('soundEnabled').addEventListener('change', (e) => {
    localStorage.setItem('soundEnabled', e.target.checked);
  });
  
  document.getElementById('vibrationEnabled').addEventListener('change', (e) => {
    localStorage.setItem('vibrationEnabled', e.target.checked);
  });
  
  document.getElementById('notificationsEnabled').addEventListener('change', (e) => {
    localStorage.setItem('notificationsEnabled', e.target.checked);
  });
});

/* Init app */
function init(){
  // Simulate loading progress
  let progress = 0;
  const loadingInterval = setInterval(() => {
    progress += 10;
    document.getElementById('loadingProgress').style.width = `${progress}%`;
    if (progress >= 100) {
      clearInterval(loadingInterval);
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
      }, 500);
    }
  }, 100);
  
  // Load saved theme
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  
  buildSelects();
  initMap();
  const savedPhone = localStorage.getItem('ta_phone') || '';
  const savedEmail = localStorage.getItem('ta_email') || '';
  document.getElementById('waInput').value = savedPhone;
  document.getElementById('emailInput').value = savedEmail;
  
  // Update tracking state with saved values
  trackingState.wa = savedPhone;
  trackingState.email = savedEmail;
  
  buildRoute();
  
  // Setup worker with initial data
  worker.postMessage({
    type: 'SETUP',
    stations: STATIONS,
    routeIndices: routeIndices
  });
  
  // mobile: auto-scroll active into view
  const obs = new MutationObserver(()=> {
    const active = document.querySelector('.station.active');
    if(active && window.innerWidth <= 900) active.scrollIntoView({ behavior:'smooth', block:'center' });
  });
  obs.observe(document.getElementById('timeline'), { childList:true, subtree:true, attributes:true, attributeFilter:['class'] });
  
  // Update connection status
  updateConnectionStatus();
  
  // Update notification status
  document.getElementById('notifStatus').textContent = 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ' + (Notification.permission === 'granted' ? 'Ù…ÙØ¹Ù„Ø©' : (Notification.permission==='denied'?'Ù…Ø±ÙÙˆØ¶Ø©':'ØºÙŠØ± Ù…Ø¹Ø·Ù„Ø©'));
  
  // Check if app was launched from notification
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(registration => {
      registration.getNotifications().then(notifications => {
        if (notifications.length > 0) {
          showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©');
        }
      });
    });
  }
  
  // Listen for messages from service worker
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'SYNC_COMPLETE') {
      showToast('ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    }
  });
}

window.addEventListener('load', init);

// Prevent accidental back navigation when tracking is active
window.addEventListener('beforeunload', (e) => {
  if (watchId) {
    e.preventDefault();
    e.returnValue = 'Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¹Ù…Ù„ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
    return e.returnValue;
  }
});

// Handle visibility change to continue tracking when tab is not visible
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && trackingState.active) {
    showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¹Ù…Ù„');
    
    // If tracking is active but this is not the main tab, update UI
    if (!isMainTab) {
      updateUIFromTrackingState();
    }
  }
});

// Handle page focus to ensure proper tab state
window.addEventListener('focus', () => {
  if (trackingState.active && !isMainTab) {
    updateUIFromTrackingState();
    showToast('Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¹Ù…Ù„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±');
  }
});
</script>
</body>
</html>