<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Train Alert Pro ‚Äî SN</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='a' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23c9a84a'/%3E%3Cstop offset='100%25' style='stop-color:%23e0c77b'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='6' fill='%230b0f12'/%3E%3Crect x='4' y='4' width='24' height='24' rx='4' fill='url(%23a)'/%3E%3Ctext x='16' y='22' font-family='Arial,sans-serif' font-size='14' font-weight='bold' text-anchor='middle' fill='%230b0f12'%3ESN%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='a' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23c9a84a'/%3E%3Cstop offset='100%25' style='stop-color:%23e0c77b'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='36' fill='%230b0f12'/%3E%3Crect x='20' y='20' width='140' height='140' rx='28' fill='url(%23a)'/%3E%3Ctext x='90' y='115' font-family='Arial,sans-serif' font-size='72' font-weight='bold' text-anchor='middle' fill='%230b0f12'%3ESN%3C/text%3E%3C/svg%3E">
<link rel="manifest" href="data:application/json,{%22name%22:%22Train%20Alert%20Pro%22,%22short_name%22:%22TrainAlert%22,%22icons%22:[{%22src%22:%22data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22}],%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%230b0f12%22,%22theme_color%22:%22%23c9a84a%22}">

<!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿ™ÿ®ÿ© Leaflet ŸÑŸÑÿÆÿ±ÿßÿ¶ÿ∑ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
:root{
  --bg-0:#0b0f12; --bg-1:#111417; --card:#121417;
  --muted:#b8b8b8; --gold:#c9a84a; --gold-2:#e0c77b;
  --accent:#6fa7d6; --glass: rgba(255,255,255,0.03); --text:#e8e8e8;
  --success:#4caf50; --warning:#ff9800; --danger:#f44336;
  --gradient-1: linear-gradient(135deg, var(--gold), var(--gold-2));
  --gradient-2: linear-gradient(180deg, var(--bg-0), var(--bg-1));
  --shadow-1: 0 4px 20px rgba(0,0,0,0.15);
  --shadow-2: 0 8px 30px rgba(0,0,0,0.25);
  --shadow-gold: 0 8px 26px rgba(201,168,74,0.35);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --select-bg: rgba(255,255,255,0.02);
  --select-border: rgba(255,255,255,0.08);
  --select-hover: rgba(255,255,255,0.05);
  --select-focus: rgba(201,168,74,0.2);
}
[data-theme="light"]{
  --bg-0:#f6f7f8; --bg-1:#fdfdfd; --card:#ffffff;
  --muted:#6b7280; --gold:#b8860b; --gold-2:#d9b667; --accent:#0b66b3; --text:#06121a;
  --gradient-2: linear-gradient(180deg, #f6f7f8, #fdfdfd);
  --select-bg: rgba(0,0,0,0.02);
  --select-border: rgba(0,0,0,0.08);
  --select-hover: rgba(0,0,0,0.05);
  --select-focus: rgba(184,134,11,0.2);
}
*{box-sizing:border-box; margin:0; padding:0}
html,body{height:100%; font-family:Inter,system-ui,Segoe UI,Roboto,"Noto Sans",Arial; -webkit-font-smoothing:antialiased; background:var(--gradient-2); color:var(--text); overflow-x:hidden}
body{position:relative}

/* Main Header */
.main-header {
  background: linear-gradient(135deg, var(--bg-0), var(--bg-1));
  padding: 15px 0;
  box-shadow: var(--shadow-1);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-brand {
  display: flex;
  align-items: center;
  gap: 15px;
}

.header-logo {
  width: 50px;
  height: 50px;
  position: relative;
}

.logo-sn {
  width: 100%;
  height: 100%;
  background: var(--gradient-1);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-gold);
}

.logo-sn::before {
  content: "";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
  transform: rotate(45deg);
  animation: shimmer 3s infinite;
}

.logo-sn .sn-text {
  font-weight: 900;
  font-size: 20px;
  color: #07120b;
  position: relative;
  z-index: 2;
}

.logo-sn .train-icon {
  position: absolute;
  bottom: 2px;
  right: 2px;
  font-size: 10px;
  color: #07120b;
  opacity: 0.8;
}

.header-title {
  font-weight: 800;
  font-size: 24px;
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header-nav {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.nav-link {
  color: var(--text);
  text-decoration: none;
  padding: 8px 16px;
  border-radius: 8px;
  transition: var(--transition);
  font-weight: 600;
  font-size: 14px;
}

.nav-link:hover {
  background: rgba(255,255,255,0.05);
}

.nav-link.about {
  background: rgba(201,168,74,0.1);
  color: var(--gold);
}

.container{max-width:1200px;margin:14px auto;padding:12px}
.card{background:linear-gradient(180deg,var(--glass), rgba(255,255,255,0.01));border-radius:16px;padding:16px;box-shadow:var(--shadow-2); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.05); transition:var(--transition)}
.card:hover{transform: translateY(-2px); box-shadow:0 12px 40px rgba(0,0,0,0.3)}
.header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 6px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px;background:var(--gradient-1);color:#08120b;box-shadow:var(--shadow-gold); position:relative; overflow:hidden}
.logo::after{content:""; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform:rotate(45deg); animation:shimmer 3s infinite}
@keyframes shimmer{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}100%{transform:translateX(100%) translateY(100%) rotate(45deg)}}
.title{font-weight:800;font-size:20px; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
.subtitle{font-size:13px;color:var(--muted)}
.layout{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:12px;align-items:start}
.layout.no-map{grid-template-columns:1fr}
@media(max-width:1000px){ 
  .layout{grid-template-columns:1fr; grid-template-rows:1fr auto} 
  .left-col{order:1} 
  .right-col{order:2; height:40vh} 
}
.left-col{height:78vh;overflow:auto;border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02); position:relative}
.left-col::before{content:""; position:absolute; top:0; left:0; right:0; height:2px; background:var(--gradient-1); border-radius:12px 12px 0 0}
.controls-row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.input-group {
  position: relative;
  flex: 1;
}
.input-group label {
  display: block;
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 6px;
  font-weight: 600;
}
.input-field {
  width: 100%;
  padding: 14px 40px 14px 16px;
  border-radius: 14px;
  border: 2px solid var(--select-border);
  background: var(--select-bg);
  color: var(--text);
  font-size: 15px;
  font-weight: 500;
  transition: var(--transition);
  backdrop-filter: blur(8px);
  appearance: none;
  cursor: pointer;
  position: relative;
}
.input-field:hover {
  background: var(--select-hover);
  border-color: var(--gold);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(201,168,74,0.15);
}
.input-field:focus {
  outline: none;
  border-color: var(--gold);
  background: var(--select-hover);
  box-shadow: 0 0 0 4px var(--select-focus);
}
.input-field::placeholder {
  color: var(--muted);
  opacity: 0.7;
}
.select-wrapper {
  position: relative;
  width: 100%;
}
.select-wrapper::after {
  content: "‚ñº";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gold);
  font-size: 12px;
  pointer-events: none;
  transition: var(--transition);
}
.select-wrapper:hover::after {
  color: var(--gold-2);
  transform: translateY(-50%) scale(1.1);
}
.select-wrapper:focus-within::after {
  transform: translateY(-50%) rotate(180deg);
}
.btn{padding:12px 16px;border-radius:12px;border:0;background:var(--gradient-1);color:#07120b;font-weight:800;cursor:pointer;box-shadow:var(--shadow-gold); transition:var(--transition); position:relative; overflow:hidden}
.btn::before{content:""; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(255,255,255,0.3); transform:translate(-50%, -50%); transition:width 0.6s, height 0.6s}
.btn:active::before{width:300px; height:300px}
.btn:hover{transform: translateY(-2px); box-shadow:0 12px 30px rgba(201,168,74,0.25)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text);font-weight:700; box-shadow:none}
.btn.ghost:hover{background:rgba(255,255,255,0.05); border-color:var(--gold)}
.route-info{margin-top:10px;font-size:13px;color:var(--muted); padding:10px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.03)}
.timeline{display:flex;flex-direction:column;gap:10px;margin-top:12px; position:relative}
.timeline::before{content:""; position:absolute; top:0; bottom:0; right:24px; width:2px; background:linear-gradient(180deg, var(--gold), transparent); z-index:0}
.station{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01);transition:var(--transition); position:relative; z-index:1}
.station:hover{transform: translateX(-3px); background:rgba(255,255,255,0.03); border-color:rgba(255,255,255,0.08)}
.station .rail{width:16px;flex-shrink:0;display:flex;align-items:flex-start;justify-content:center}
.station .dot{width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,0.05);box-shadow:0 6px 14px rgba(0,0,0,0.2);transition:var(--transition); position:relative}
.station .dot::after{content:""; position:absolute; top:50%; left:50%; width:6px; height:6px; border-radius:50%; background:var(--bg-0); transform:translate(-50%, -50%); opacity:0; transition:opacity 0.3}
.station .meta{flex:1;display:flex;flex-direction:column}
.station .name{font-weight:700; font-size:15px}
.station .small{font-size:13px;color:var(--muted)}
@keyframes pulse {
  0%{ box-shadow: 0 0 0 0 rgba(201,168,74,0.4); transform:scale(1); }
  50%{ box-shadow: 0 0 0 10px rgba(201,168,74,0); transform:scale(1.05); }
  100%{ box-shadow: 0 0 0 0 rgba(201,168,74,0); transform:scale(1); }
}
@keyframes glow {
  0%, 100%{ box-shadow: 0 0 5px rgba(201,168,74,0.5); }
  50%{ box-shadow: 0 0 20px rgba(201,168,74,0.8), 0 0 30px rgba(201,168,74,0.4); }
}
.station.active{background:var(--gradient-1);color:#07120b;transform:scale(1.03);box-shadow:var(--shadow-gold); border-color:transparent}
.station.active .dot{background:#fff; box-shadow:0 6px 18px rgba(201,168,74,0.3); animation:pulse 1.5s infinite ease-in-out}
.station.active .dot::after{opacity:1}
.station.next{border-style:dashed; border-color:var(--gold); background:rgba(201,168,74,0.05)}
.station.next .dot{background:var(--gold-2); animation:glow 2s infinite}
.station.passed .dot{background:var(--success); box-shadow:0 6px 18px rgba(76,175,80,0.3)}
.station.passed .dot::after{opacity:1; background:var(--bg-0)}
.station.warning{border-style:dashed; border-color:var(--warning); background:rgba(255,152,0,0.1)}
.station.warning .dot{background:var(--warning); animation:glow 2s infinite}
.right-col{border-radius:12px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.005), rgba(255,255,255,0.01)); box-shadow:var(--shadow-1); display:none}
.right-col.active{display:block}
.map{height:78vh; position:relative}
.map::after{content:""; position:absolute; bottom:0; left:0; right:0; height:3px; background:var(--gradient-1)}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:13px; padding:10px; background:rgba(255,255,255,0.02); border-radius:10px}
.loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--gradient-2);z-index:9999; backdrop-filter: blur(10px)}
.loader-box{background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.01));padding:24px;border-radius:16px;display:flex;gap:16px;align-items:center;box-shadow:var(--shadow-2); border:1px solid rgba(255,255,255,0.05)}
.spinner{width:60px;height:60px;border-radius:50%;border:6px solid rgba(255,255,255,0.06);border-top-color:var(--gold);animation:spin 1s linear infinite; position:relative}
.spinner::after{content:""; position:absolute; top:6px; left:6px; right:6px; bottom:6px; border-radius:50%; border:3px solid transparent; border-bottom-color:var(--gold-2); animation:spin 0.6s linear infinite reverse}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:600px){ 
  .logo{width:48px;height:48px;font-size:18px} 
  .left-col{padding:10px; height:55vh} 
  .map{height:40vh} 
  .layout{gap:8px}
  .container{margin:8px auto;padding:8px}
  .input-field { padding: 12px 36px 12px 14px; font-size: 14px; }
  .header-content {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
  
  .header-nav {
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  
  .status-indicators {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    width: 100%;
  }
  
  .status-indicators > div {
    flex: 1;
    min-width: 120px;
    justify-content: center;
  }
}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.8);color:#fff;padding:12px 18px;border-radius:12px;z-index:99999; backdrop-filter: blur(10px); box-shadow:var(--shadow-2); animation:slideUp 0.3s ease-out}
@keyframes slideUp{from{transform:translateX(-50%) translateY(100%); opacity:0} to{transform:translateX(-50%) translateY(0); opacity:1}}
.hidden{display:none!important}
.status-indicator{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:20px; font-size:12px; font-weight:600}
.status-indicator.online{background:rgba(76,175,80,0.2); color:var(--success)}
.status-indicator.offline{background:rgba(244,67,54,0.2); color:var(--danger)}
.status-indicator::before{content:""; width:8px; height:8px; border-radius:50%; background:currentColor}
.status-indicator.online::before{animation:blink 2s infinite}
@keyframes blink{0%, 100%{opacity:1} 50%{opacity:0.3}}
.floating-action{position:fixed; bottom:20px; right:20px; width:56px; height:56px; border-radius:50%; background:var(--gradient-1); color:#07120b; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow:var(--shadow-gold); cursor:pointer; z-index:100; transition:var(--transition)}
.floating-action:hover{transform:scale(1.1); box-shadow:0 12px 30px rgba(201,168,74,0.4)}
.floating-action:active{transform:scale(0.95)}
.progress-bar{height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; margin-top:8px}
.progress-bar .progress{height:100%; background:var(--gradient-1); width:0%; transition:width 0.3s}
.notification-badge{position:absolute; top:-5px; right:-5px; width:20px; height:20px; border-radius:50%; background:var(--danger); color:white; font-size:11px; font-weight:700; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.2)}

/* Custom select dropdown styling */
.custom-select {
  position: relative;
  width: 100%;
}

.custom-select select {
  width: 100%;
  padding: 14px 40px 14px 16px;
  border-radius: 14px;
  border: 2px solid var(--select-border);
  background: var(--select-bg);
  color: var(--text);
  font-size: 15px;
  font-weight: 500;
  transition: var(--transition);
  backdrop-filter: blur(8px);
  appearance: none;
  cursor: pointer;
  position: relative;
}

.custom-select select:hover {
  background: var(--select-hover);
  border-color: var(--gold);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(201,168,74,0.15);
}

.custom-select select:focus {
  outline: none;
  border-color: var(--gold);
  background: var(--select-hover);
  box-shadow: 0 0 0 4px var(--select-focus);
}

.custom-select::before {
  content: "üìç";
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  pointer-events: none;
  transition: var(--transition);
  z-index: 1;
}

.custom-select::after {
  content: "‚ñº";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gold);
  font-size: 12px;
  pointer-events: none;
  transition: var(--transition);
  z-index: 1;
}

.custom-select:hover::after {
  color: var(--gold-2);
  transform: translateY(-50%) scale(1.1);
}

.custom-select select:focus + .custom-select::after {
  transform: translateY(-50%) rotate(180deg);
}

/* Enhanced option styling */
.custom-select option {
  background: var(--card);
  color: var(--text);
  padding: 12px 16px;
  border: none;
  font-weight: 500;
}

.custom-select option:hover {
  background: var(--select-hover);
}

/* Animation for select focus */
@keyframes selectGlow {
  0% { box-shadow: 0 0 0 0 var(--select-focus); }
  50% { box-shadow: 0 0 0 8px var(--select-focus); }
  100% { box-shadow: 0 0 0 0 var(--select-focus); }
}

.custom-select select:focus {
  animation: selectGlow 0.5s ease-out;
}

/* Dark mode specific enhancements */
[data-theme="dark"] .custom-select::before {
  filter: brightness(1.2);
}

/* Light mode specific enhancements */
[data-theme="light"] .custom-select::before {
  filter: brightness(0.8);
}

/* Mobile optimizations */
@media (max-width: 600px) {
  .custom-select select {
    padding: 12px 36px 12px 14px;
    font-size: 14px;
  }
  
  .custom-select::before {
    right: 12px;
    font-size: 14px;
  }
  
  .custom-select::after {
    left: 14px;
    font-size: 11px;
  }
}

/* Map control button */
.map-control {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background: var(--gradient-1);
  color: #07120b;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
  box-shadow: var(--shadow-gold);
  transition: var(--transition);
}

.map-control:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(201,168,74,0.3);
}

/* Map container improvements */
.map-container {
  position: relative;
  height: 100%;
  width: 100%;
}

/* Sidebar menu */
.sidebar {
  position: fixed;
  top: 0;
  right: -350px;
  width: 350px;
  height: 100%;
  background: var(--card);
  box-shadow: var(--shadow-2);
  z-index: 1000;
  transition: var(--transition);
  padding: 20px;
  overflow-y: auto;
}

.sidebar.active {
  right: 0;
}

.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sidebar-section {
  margin-bottom: 25px;
}

.sidebar-section h3 {
  margin-bottom: 15px;
  color: var(--gold);
  font-size: 16px;
}

.sidebar-option {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.sidebar-option:last-child {
  border-bottom: none;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255,255,255,0.1);
  transition: .4s;
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--gold);
}

input:checked + .toggle-slider:before {
  transform: translateX(26px);
}

.notifications-list {
  max-height: 200px;
  overflow-y: auto;
}

.notification-item {
  padding: 10px;
  margin-bottom: 8px;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  border-left: 3px solid var(--gold);
  font-size: 13px;
}

.notification-time {
  font-size: 11px;
  color: var(--muted);
  margin-top: 4px;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
  display: none;
}

.overlay.active {
  display: block;
}

/* Tracking button */
.tracking-btn {
  width: 100%;
  padding: 14px;
  margin-top: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-weight: 800;
  font-size: 16px;
}

.tracking-btn.active {
  background: var(--danger);
  box-shadow: 0 8px 20px rgba(244,67,54,0.3);
}

.tracking-btn.active:hover {
  background: #d32f2f;
  box-shadow: 0 10px 25px rgba(244,67,54,0.4);
}

/* About modal */
.about-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  z-index: 1001;
  box-shadow: var(--shadow-2);
  display: none;
}

.about-modal.active {
  display: block;
}

.about-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.about-content {
  line-height: 1.6;
}

.about-content h3 {
  color: var(--gold);
  margin: 15px 0 10px;
}

.about-content p {
  margin-bottom: 10px;
  color: var(--muted);
}

.about-features {
  list-style: none;
  margin: 15px 0;
}

.about-features li {
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  display: flex;
  align-items: center;
  gap: 10px;
}

.about-features li:before {
  content: "‚úì";
  color: var(--success);
  font-weight: bold;
}

.performance-info {
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  padding: 15px;
  margin: 15px 0;
  border-left: 3px solid var(--success);
}

.performance-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.stat-item {
  text-align: center;
  padding: 8px;
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
}

.stat-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--gold);
}

.stat-label {
  font-size: 11px;
  color: var(--muted);
}

/* Responsive improvements */
@media (max-width: 768px) {
  .sidebar {
    width: 300px;
  }
  
  .about-modal {
    padding: 20px;
  }
  
  .performance-stats {
    grid-template-columns: 1fr;
  }
}

/* Network status */
.network-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(76,175,80,0.1);
  color: var(--success);
}

.network-status.weak {
  background: rgba(255,152,0,0.1);
  color: var(--warning);
}

.network-status.offline {
  background: rgba(244,67,54,0.1);
  color: var(--danger);
}

.network-status::before {
  content: "";
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
}

/* Map error styling */
.map-error {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  z-index: 1000;
  max-width: 80%;
}

.map-error button {
  margin-top: 10px;
  padding: 8px 15px;
  background: var(--gold);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

/* Tutorial steps */
.tutorial-steps {
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  padding: 15px;
  margin-top: 10px;
  border-left: 3px solid var(--gold);
}

.tutorial-step {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.tutorial-step:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.step-number {
  background: var(--gradient-1);
  color: #07120b;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 12px;
  flex-shrink: 0;
}

.step-content {
  flex: 1;
}

.step-title {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
  font-size: 13px;
}

.step-description {
  color: var(--muted);
  font-size: 12px;
  line-height: 1.4;
}

/* Copy button */
.copy-btn {
  background: rgba(201,168,74,0.2);
  border: 1px solid var(--gold);
  color: var(--gold);
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.copy-btn:hover {
  background: rgba(201,168,74,0.3);
  transform: translateY(-1px);
}

.copy-btn.copied {
  background: rgba(76,175,80,0.2);
  border-color: var(--success);
  color: var(--success);
}

/* Urgent notification styling */
.urgent-telegram {
  animation: urgentPulse 1s infinite;
}

@keyframes urgentPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* Test notification animation */
.test-notification-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  border-radius: 16px;
  padding: 25px;
  max-width: 350px;
  width: 90%;
  z-index: 1003;
  box-shadow: var(--shadow-2);
  display: none;
  text-align: center;
  animation: slideDown 0.5s ease-out;
}

.test-notification-modal.active {
  display: block;
}

.test-notification-modal h3 {
  color: var(--gold);
  margin-bottom: 15px;
  font-size: 20px;
}

.test-notification-modal .test-icon {
  font-size: 50px;
  margin-bottom: 15px;
  animation: bounce 1s infinite;
}

.test-notification-modal p {
  margin-bottom: 20px;
  color: var(--text);
  font-size: 14px;
}

.test-progress {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  height: 6px;
  overflow: hidden;
  margin: 15px 0;
}

.test-progress-bar {
  height: 100%;
  background: var(--gradient-1);
  width: 0%;
  transition: width 0.3s ease;
}

.test-status {
  font-size: 12px;
  color: var(--muted);
  margin-top: 10px;
}

/* Responsive improvements */
@media (max-width: 768px) {
  .test-notification-modal {
    padding: 20px;
    width: 95%;
  }
}

/* Local notification status */
.local-notification-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(76,175,80,0.1);
  color: var(--success);
}

.local-notification-status.disabled {
  background: rgba(244,67,54,0.1);
  color: var(--danger);
}

.local-notification-status::before {
  content: "üîî";
}

/* Notification permission modal */
.notification-permission-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.notification-permission-content {
  background: var(--card);
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 100%;
  box-shadow: var(--shadow-2);
  text-align: center;
}

.notification-permission-header {
  margin-bottom: 20px;
}

.notification-permission-header h2 {
  color: var(--gold);
  margin-bottom: 10px;
  font-size: 24px;
}

.notification-permission-header p {
  color: var(--text);
  font-size: 16px;
  line-height: 1.5;
}

.notification-permission-steps {
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  padding: 20px;
  margin: 20px 0;
  text-align: right;
}

.notification-permission-steps h3 {
  color: var(--gold);
  margin-bottom: 15px;
  text-align: center;
}

.notification-permission-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.notification-permission-buttons button {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: var(--transition);
}

.notification-permission-buttons .allow-btn {
  background: var(--gradient-1);
  color: #07120b;
}

.notification-permission-buttons .allow-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(201,168,74,0.3);
}

.notification-permission-buttons .later-btn {
  background: transparent;
  border: 2px solid var(--muted);
  color: var(--muted);
}

.notification-permission-buttons .later-btn:hover {
  background: rgba(255,255,255,0.05);
  border-color: var(--text);
  color: var(--text);
}

.notification-permission-status {
  margin-top: 15px;
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  display: none;
}

.notification-permission-status.error {
  background: rgba(244,67,54,0.1);
  border: 1px solid var(--danger);
  color: var(--danger);
}

.notification-permission-status.success {
  background: rgba(76,175,80,0.1);
  border: 1px solid var(--success);
  color: var(--success);
}

.notification-permission-status.info {
  background: rgba(0,136,204,0.1);
  border: 1px solid #0088cc;
  color: #0088cc;
}

/* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ */
@media (max-width: 600px) {
  .notification-permission-content {
    padding: 20px;
  }
  
  .notification-permission-buttons {
    flex-direction: column;
  }
}

/* Notification toast improvements */
.notification-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  box-shadow: var(--shadow-2);
  z-index: 10001;
  display: flex;
  align-items: center;
  gap: 12px;
  max-width: 350px;
  transform: translateX(400px);
  transition: transform 0.3s ease-out;
  border-left: 4px solid var(--gold);
}

.notification-toast.show {
  transform: translateX(0);
}

.notification-toast-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.notification-toast-content {
  flex: 1;
}

.notification-toast-title {
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--text);
}

.notification-toast-body {
  font-size: 14px;
  color: var(--muted);
}

.notification-toast-close {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 18px;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: var(--transition);
}

.notification-toast-close:hover {
  background: rgba(255,255,255,0.1);
  color: var(--text);
}

/* Notification permission banner */
.notification-banner {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--gradient-1);
  color: #07120b;
  padding: 12px;
  text-align: center;
  z-index: 10002;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: var(--shadow-1);
  transform: translateY(-100%);
  transition: transform 0.3s ease-out;
}

.notification-banner.show {
  transform: translateY(0);
}

.notification-banner-text {
  font-weight: 600;
}

.notification-banner-button {
  background: rgba(7,18,11,0.2);
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
}

.notification-banner-button:hover {
  background: rgba(7,18,11,0.3);
}

/* Notification settings panel */
.notification-settings-panel {
  background: rgba(255,255,255,0.03);
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
}

.notification-settings-title {
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--gold);
  display: flex;
  align-items: center;
  gap: 8px;
}

.notification-setting {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.notification-setting:last-child {
  border-bottom: none;
}

.notification-setting-label {
  font-size: 14px;
  color: var(--text);
}

.notification-setting-description {
  font-size: 12px;
  color: var(--muted);
  margin-top: 2px;
}

/* Notification history */
.notification-history {
  margin-top: 15px;
}

.notification-history-title {
  font-weight: 700;
  margin-bottom: 10px;
  color: var(--gold);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.clear-notifications-btn {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.clear-notifications-btn:hover {
  color: var(--danger);
}

.notification-history-item {
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 8px;
  font-size: 13px;
  border-left: 3px solid var(--gold);
}

.notification-history-time {
  font-size: 11px;
  color: var(--muted);
  margin-top: 4px;
}

.notification-history-empty {
  text-align: center;
  color: var(--muted);
  font-size: 13px;
  padding: 15px;
}

/* GPS Status Indicator */
.gps-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(76,175,80,0.1);
  color: var(--success);
}

.gps-status.weak {
  background: rgba(255,152,0,0.1);
  color: var(--warning);
}

.gps-status.offline {
  background: rgba(244,67,54,0.1);
  color: var(--danger);
}

.gps-status::before {
  content: "üìç";
}

/* Station proximity indicator */
.proximity-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(201,168,74,0.1);
  color: var(--gold);
}

.proximity-indicator.warning {
  background: rgba(255,152,0,0.1);
  color: var(--warning);
}

.proximity-indicator.arrival {
  background: rgba(244,67,54,0.1);
  color: var(--danger);
  animation: urgentPulse 1s infinite;
}

.proximity-indicator::before {
  content: "üöâ";
}

/* Debug panel */
.debug-panel {
  background: rgba(255,255,255,0.03);
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
  font-family: monospace;
  font-size: 12px;
}

.debug-info {
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}

.debug-label {
  color: var(--muted);
}

.debug-value {
  color: var(--text);
  font-weight: 600;
}

/* Notification test panel */
.test-notification-panel {
  background: rgba(255,255,255,0.03);
  border-radius: 12px;
  padding: 15px;
  margin-top: 15px;
}

.test-notification-title {
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--gold);
  display: flex;
  align-items: center;
  gap: 8px;
}

.test-notification-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.test-notification-btn {
  flex: 1;
  min-width: 120px;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
  background: var(--gradient-1);
  color: #07120b;
}

.test-notification-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(201,168,74,0.15);
}

.test-notification-btn.warning {
  background: var(--warning);
  color: #fff;
}

.test-notification-btn.arrival {
  background: var(--danger);
  color: #fff;
}

/* Enhanced notification styles for better visibility */
.enhanced-notification {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  border-radius: 16px;
  padding: 30px;
  max-width: 400px;
  width: 90%;
  z-index: 10004;
  box-shadow: var(--shadow-2);
  display: none;
  text-align: center;
  animation: slideDown 0.5s ease-out;
  border: 2px solid var(--gold);
}

.enhanced-notification.active {
  display: block;
}

.enhanced-notification h2 {
  color: var(--gold);
  margin-bottom: 15px;
  font-size: 24px;
}

.enhanced-notification p {
  margin-bottom: 20px;
  color: var(--text);
  font-size: 16px;
  line-height: 1.5;
}

.enhanced-notification .notification-icon {
  font-size: 60px;
  margin-bottom: 20px;
  animation: bounce 1s infinite;
}

.enhanced-notification .notification-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.enhanced-notification .notification-btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: var(--transition);
}

.enhanced-notification .primary-btn {
  background: var(--gradient-1);
  color: #07120b;
}

.enhanced-notification .secondary-btn {
  background: transparent;
  border: 2px solid var(--muted);
  color: var(--muted);
}

.enhanced-notification .primary-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(201,168,74,0.3);
}

.enhanced-notification .secondary-btn:hover {
  background: rgba(255,255,255,0.05);
  border-color: var(--text);
  color: var(--text);
}

/* Arrival notification modal */
.arrival-notification-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  border-radius: 16px;
  padding: 30px;
  max-width: 450px;
  width: 90%;
  z-index: 10005;
  box-shadow: var(--shadow-2);
  display: none;
  text-align: center;
  animation: slideDown 0.5s ease-out;
  border: 3px solid var(--danger);
}

.arrival-notification-modal.active {
  display: block;
}

.arrival-notification-modal h2 {
  color: var(--danger);
  margin-bottom: 15px;
  font-size: 26px;
  font-weight: 900;
}

.arrival-notification-modal p {
  margin-bottom: 20px;
  color: var(--text);
  font-size: 16px;
  line-height: 1.5;
}

.arrival-notification-modal .arrival-icon {
  font-size: 80px;
  margin-bottom: 20px;
  animation: urgentPulse 1s infinite;
}

.arrival-notification-modal .arrival-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.arrival-notification-modal .arrival-btn {
  padding: 12px 24px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: var(--transition);
}

.arrival-notification-modal .confirm-btn {
  background: var(--danger);
  color: white;
  box-shadow: 0 4px 15px rgba(244,67,54,0.3);
}

.arrival-notification-modal .confirm-btn:hover {
  background: #d32f2f;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(244,67,54,0.4);
}

.arrival-notification-modal .cancel-btn {
  background: transparent;
  border: 2px solid var(--muted);
  color: var(--muted);
}

.arrival-notification-modal .cancel-btn:hover {
  background: rgba(255,255,255,0.05);
  border-color: var(--text);
  color: var(--text);
}

/* Service Worker status indicator */
.sw-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(76,175,80,0.1);
  color: var(--success);
}

.sw-status.disabled {
  background: rgba(244,67,54,0.1);
  color: var(--danger);
}

.sw-status::before {
  content: "üîÑ";
}

/* Background sync status */
.sync-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(76,175,80,0.1);
  color: var(--success);
}

.sync-status.pending {
  background: rgba(255,152,0,0.1);
  color: var(--warning);
}

.sync-status.failed {
  background: rgba(244,67,54,0.1);
  color: var(--danger);
}

.sync-status::before {
  content: "üîÑ";
}

/* Offline indicator */
.offline-indicator {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: var(--danger);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: none;
  z-index: 10005;
  animation: slideUp 0.3s ease-out;
}

.offline-indicator.show {
  display: flex;
  align-items: center;
  gap: 8px;
}

.offline-indicator::before {
  content: "üì°";
}

/* Battery status indicator */
.battery-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(76,175,80,0.1);
  color: var(--success);
}

.battery-status.low {
  background: rgba(255,152,0,0.1);
  color: var(--warning);
}

.battery-status.critical {
  background: rgba(244,67,54,0.1);
  color: var(--danger);
}

.battery-status::before {
  content: "üîã";
}

/* Performance optimizations for mobile */
@media (max-width: 768px) {
  .card {
    padding: 12px;
  }
  
  .header {
    padding: 6px 4px;
  }
  
  .controls-row {
    gap: 6px;
  }
  
  .input-group {
    margin-bottom: 8px;
  }
  
  .btn {
    padding: 10px 14px;
    font-size: 14px;
  }
  
  .station {
    padding: 10px;
  }
  
  .station .name {
    font-size: 14px;
  }
  
  .station .small {
    font-size: 12px;
  }
}

/* Animation for slide down */
@keyframes slideDown {
  from {
    transform: translate(-50%, -70%);
    opacity: 0;
  }
  to {
    transform: translate(-50%, -50%);
    opacity: 1;
  }
}

/* Animation for bounce */
@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-20px);
  }
}

/* Animation for urgent pulse */
@keyframes urgentPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* Animation for glow */
@keyframes glow {
  0%, 100% { 
    box-shadow: 0 8px 30px rgba(201,168,74,0.3), 0 0 20px rgba(201,168,74,0.2);
  }
  50% { 
    box-shadow: 0 8px 40px rgba(201,168,74,0.5), 0 0 30px rgba(201,168,74,0.4);
  }
}

/* Persistent arrival notification */
.arrival-notification.persistent {
  animation: persistentGlow 1.5s infinite;
}

@keyframes persistentGlow {
  0%, 100% { 
    box-shadow: 0 8px 30px rgba(201,168,74,0.3), 0 0 20px rgba(201,168,74,0.2);
  }
  50% { 
    box-shadow: 0 8px 40px rgba(201,168,74,0.5), 0 0 30px rgba(201,168,74,0.4);
  }
}

/* Loading screen improvements */
.loading-text {
  font-size: 18px;
  font-weight: 700;
  color: var(--gold);
  margin-top: 10px;
}

.loading-subtitle {
  font-size: 14px;
  color: var(--muted);
  margin-top: 5px;
}

.loading-site-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-top: 15px;
  padding: 8px 16px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.loading-site-name::before {
  content: "üåê";
}

/* GPS improvement styles */
.gps-improvement-panel {
  background: rgba(255,152,0,0.1);
  border: 1px solid var(--warning);
  border-radius: 12px;
  padding: 15px;
  margin-top: 10px;
}

.gps-improvement-title {
  color: var(--warning);
  font-weight: 700;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.gps-improvement-title::before {
  content: "‚ö†Ô∏è";
}

.gps-improvement-tips {
  list-style: none;
  margin: 0;
  padding: 0;
}

.gps-improvement-tips li {
  padding: 5px 0;
  font-size: 13px;
  color: var(--text);
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.gps-improvement-tips li::before {
  content: "‚Ä¢";
  color: var(--warning);
  font-weight: bold;
  margin-right: 4px;
}

.gps-status-improving {
  animation: gpsImproving 2s infinite;
}

@keyframes gpsImproving {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÇŸàŸäÿ© */
.high-volume-notification {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.9);
  z-index: 10006;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.3s ease-out;
}

.high-volume-notification.active {
  display: flex;
}

.high-volume-content {
  background: var(--card);
  border-radius: 16px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  text-align: center;
  box-shadow: var(--shadow-2);
  border: 3px solid var(--danger);
  animation: slideDown 0.5s ease-out;
}

.high-volume-icon {
  font-size: 100px;
  margin-bottom: 20px;
  animation: urgentPulse 1s infinite;
}

.high-volume-title {
  color: var(--danger);
  font-size: 28px;
  font-weight: 900;
  margin-bottom: 15px;
}

.high-volume-body {
  color: var(--text);
  font-size: 18px;
  line-height: 1.5;
  margin-bottom: 25px;
}

.high-volume-actions {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.high-volume-btn {
  padding: 15px 30px;
  border-radius: 10px;
  border: none;
  font-weight: 700;
  font-size: 18px;
  cursor: pointer;
  transition: var(--transition);
}

.high-volume-confirm {
  background: var(--danger);
  color: white;
  box-shadow: 0 4px 15px rgba(244,67,54,0.3);
}

.high-volume-confirm:hover {
  background: #d32f2f;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(244,67,54,0.4);
}

.high-volume-dismiss {
  background: transparent;
  border: 2px solid var(--muted);
  color: var(--muted);
}

.high-volume-dismiss:hover {
  background: rgba(255,255,255,0.05);
  border-color: var(--text);
  color: var(--text);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ© ŸÑŸÑŸàÿµŸàŸÑ */
.arrival-dialog-simple {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 10008;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.arrival-dialog-simple.show {
  opacity: 1;
  visibility: visible;
}

.arrival-dialog-content-simple {
  background: var(--card);
  border-radius: 20px;
  max-width: 400px;
  width: 90%;
  box-shadow: var(--shadow-2);
  border: 3px solid var(--danger);
  overflow: hidden;
  transform: scale(0.8);
  transition: transform 0.3s ease;
}

.arrival-dialog-simple.show .arrival-dialog-content-simple {
  transform: scale(1);
}

.arrival-header-simple {
  background: var(--gradient-1);
  padding: 25px 20px;
  text-align: center;
  position: relative;
}

.arrival-logo-simple {
  margin: 0 auto 15px;
  width: 100px;
  height: 100px;
}

.arrival-logo-simple .logo-sn-simple {
  width: 100%;
  height: 100%;
  background: var(--gradient-1);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-gold);
  animation: pulse 1.5s infinite ease-in-out;
}

.arrival-logo-simple .sn-text-simple {
  font-weight: 900;
  font-size: 40px;
  color: #07120b;
  position: relative;
  z-index: 2;
}

.arrival-logo-simple .train-icon-simple {
  position: absolute;
  bottom: 8px;
  right: 8px;
  font-size: 20px;
  color: #07120b;
  opacity: 0.8;
}

.arrival-title-simple {
  color: #07120b;
  font-size: 32px;
  font-weight: 900;
  margin: 0;
}

.arrival-body-simple {
  padding: 30px 25px;
  text-align: center;
}

.station-name-simple {
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}

.arrival-time-simple {
  font-size: 18px;
  color: var(--muted);
  margin-bottom: 20px;
}

.arrival-message-simple {
  background: rgba(244, 67, 54, 0.1);
  border: 1px solid var(--danger);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
}

.arrival-message-simple p {
  margin: 8px 0;
  font-size: 18px;
  color: var(--text);
}

.arrival-message-simple p:first-child {
  font-weight: 700;
  color: var(--danger);
  font-size: 20px;
}

.arrival-btn-simple {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 18px 25px;
  border-radius: 12px;
  border: none;
  font-weight: 700;
  font-size: 18px;
  cursor: pointer;
  transition: var(--transition);
  background: var(--danger);
  color: white;
  box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
}

.arrival-btn-simple:hover {
  background: #d32f2f;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
}

.arrival-btn-simple:active {
  transform: translateY(0);
}

/* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ */
@media (max-width: 600px) {
  .arrival-dialog-content-simple {
    width: 95%;
    margin: 20px;
  }
  
  .arrival-logo-simple {
    width: 80px;
    height: 80px;
  }
  
  .arrival-logo-simple .sn-text-simple {
    font-size: 32px;
  }
  
  .arrival-title-simple {
    font-size: 28px;
  }
  
  .station-name-simple {
    font-size: 24px;
  }
  
  .arrival-body-simple {
    padding: 25px 20px;
  }
  
  .arrival-btn-simple {
    padding: 16px 20px;
    font-size: 16px;
  }
}
</style>
</head>
<body data-theme="dark">
  <div id="loading" class="loading" aria-hidden="false">
    <div class="loader-box">
      <div class="spinner" aria-hidden="true"></div>
      <div>
        <div style="font-weight:800;font-size:20px">Train Alert Pro</div>
        <div class="loading-subtitle">ÿ¨ÿßÿ±Ÿç ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ‚Äî ÿßŸÜÿ™ÿ∏ÿ± ŸÑÿ≠ÿ∏ÿ©</div>
        <div class="loading-site-name">TrainAlertPro.com</div>
        <div class="progress-bar" style="margin-top:12px">
          <div class="progress" id="loadingProgress"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Permission Banner -->
  <div class="notification-banner" id="notificationBanner">
    <div class="notification-banner-text">üîî ŸÑŸÑÿßÿ≥ÿ™ŸÅÿßÿØÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÖŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div>
    <button class="notification-banner-button" id="notificationBannerButton">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ¢ŸÜ</button>
  </div>

  <!-- Notification Toast -->
  <div class="notification-toast" id="notificationToast">
    <div class="notification-toast-icon" id="notificationToastIcon">üîî</div>
    <div class="notification-toast-content">
      <div class="notification-toast-title" id="notificationToastTitle">ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±</div>
      <div class="notification-toast-body" id="notificationToastBody">ŸÜÿµ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±</div>
    </div>
    <button class="notification-toast-close" id="notificationToastClose">‚úï</button>
  </div>

  <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© -->
  <div class="notification-permission-modal" id="notificationPermissionModal">
    <div class="notification-permission-content">
      <div class="notification-permission-header">
        <h2>üîî ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©</h2>
        <p>ŸÑŸÑÿßÿ≥ÿ™ŸÅÿßÿØÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÖŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ Train Alert Proÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</p>
      </div>
      
      <div class="notification-permission-steps">
        <h3>ŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©:</h3>
        
        <div class="tutorial-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <div class="step-title">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸàÿ±Ÿäÿ©</div>
            <div class="step-description">ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ŸÅŸàÿ±Ÿäÿ© ÿπŸÜÿØ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</div>
          </div>
        </div>
        
        <div class="tutorial-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <div class="step-title">ÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™</div>
            <div class="step-description">ÿ™ÿπŸÖŸÑ ÿ≠ÿ™Ÿâ ÿ®ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</div>
          </div>
        </div>
        
        <div class="tutorial-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <div class="step-title">ŸÖÿ¨ÿßŸÜŸäÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ</div>
            <div class="step-description">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÉÿßŸÑŸäŸÅ ÿ•ÿ∂ÿßŸÅŸäÿ©</div>
          </div>
        </div>
        
        <div class="tutorial-step">
          <div class="step-number">4</div>
          <div class="step-content">
            <div class="step-title">ÿÆÿµŸàÿµŸäÿ© ŸÉÿßŸÖŸÑÿ©</div>
            <div class="step-description">ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ™ÿ®ŸÇŸâ ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ŸÉ ŸÅŸÇÿ∑</div>
          </div>
        </div>
      </div>
      
      <div class="notification-permission-status" id="notificationPermissionStatus"></div>
      
      <div class="notification-permission-buttons">
        <button id="allowNotificationsBtn" class="allow-btn">ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</button>
        <button id="laterNotificationsBtn" class="later-btn">ŸÑÿßÿ≠ŸÇÿßŸã</button>
      </div>
    </div>
  </div>

  <!-- High Volume Notification Modal -->
  <div class="high-volume-notification" id="highVolumeNotification">
    <div class="high-volume-content">
      <div class="high-volume-icon">üöâ</div>
      <h2 class="high-volume-title" id="highVolumeTitle">ŸÑŸÇÿØ ŸàÿµŸÑÿ™!</h2>
      <p class="high-volume-body" id="highVolumeBody">ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸÅŸä ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸàÿ¨Ÿáÿ©</p>
      <div class="high-volume-actions">
        <button id="highVolumeConfirm" class="high-volume-btn high-volume-confirm">ŸÖŸàÿßŸÅŸÇ - ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ™ÿ®ÿπ</button>
        <button id="highVolumeDismiss" class="high-volume-btn high-volume-dismiss">ÿ™ÿ¨ÿßŸáŸÑ</button>
      </div>
    </div>
  </div>

  <!-- Arrival Notification Modal -->
  <div class="arrival-notification-modal" id="arrivalNotificationModal">
    <div class="arrival-icon">üöâ</div>
    <h2 id="arrivalNotificationTitle">ŸÑŸÇÿØ ŸàÿµŸÑÿ™!</h2>
    <p id="arrivalNotificationBody">ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸÅŸä ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸàÿ¨Ÿáÿ©</p>
    <div class="arrival-actions">
      <button id="confirmArrivalBtn" class="arrival-btn confirm-btn">ŸÖŸàÿßŸÅŸÇ - ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ™ÿ®ÿπ</button>
      <button id="cancelArrivalBtn" class="arrival-btn cancel-btn">ÿ™ÿ¨ÿßŸáŸÑ</button>
    </div>
  </div>

  <!-- Main Header -->
  <header class="main-header">
    <div class="header-content">
      <div class="header-brand">
        <div class="header-logo">
          <div class="logo-sn">
            <div class="sn-text">SN</div>
            <div class="train-icon">üöÜ</div>
          </div>
        </div>
        <div class="header-title">Train Alert Pro</div>
      </div>
      <nav class="header-nav">
        <a href="#" class="nav-link about" id="aboutLink">ÿ≠ŸàŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</a>
        <div class="status-indicators">
          <div class="network-status" id="networkStatus">ÿßÿ™ÿµÿßŸÑ ŸÖŸÖÿ™ÿßÿ≤</div>
          <div class="gps-status" id="gpsStatus">GPS ÿ¨ŸäÿØ</div>
          <div class="battery-status" id="batteryStatus">ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ© ÿ¨ŸäÿØÿ©</div>
          <div class="local-notification-status" id="localNotificationStatus">ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div>
        </div>
      </nav>
    </div>
  </header>

  <!-- Test Notification Modal -->
  <div class="test-notification-modal" id="testNotificationModal">
    <div class="test-icon">üì±</div>
    <h3>ÿ¨ÿßÿ±Ÿä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</h3>
    <p>ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ•ÿ¥ÿπÿßÿ± ŸÖÿ≠ŸÑŸä ŸÖÿπ ÿ±ŸÜŸäŸÜ ÿßŸÑŸáÿßÿ™ŸÅ</p>
    <div class="test-progress">
      <div class="test-progress-bar" id="testProgressBar"></div>
    </div>
    <div class="test-status" id="testStatus">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...</div>
    <button id="closeTestModal" class="btn" style="margin-top: 15px">ÿ•ÿ∫ŸÑÿßŸÇ</button>
  </div>

  <!-- About Modal -->
  <div class="about-modal" id="aboutModal">
    <div class="about-header">
      <h2>ÿ≠ŸàŸÑ Train Alert Pro</h2>
      <button id="closeAbout" class="btn ghost" style="padding: 8px">‚úï</button>
    </div>
    <div class="about-content">
      <p><strong>ÿßŸÑÿ≠ŸÑ ÿßŸÑÿ£ŸÖÿ´ŸÑ ŸÑÿ™ÿ™ÿ®ÿπ ÿ±ÿ≠ŸÑÿßÿ™ ÿßŸÑŸÇÿ∑ÿßÿ±ÿßÿ™ ŸÅŸä ŸÖÿµÿ±</strong></p>
      <p>Train Alert Pro ŸäŸÖÿ´ŸÑ ŸÜŸÇŸÑÿ© ŸÜŸàÿπŸäÿ© ŸÅŸä ŸÖÿ¨ÿßŸÑ ÿ™ÿ™ÿ®ÿπ ÿ≠ÿ±ŸÉÿ© ÿßŸÑŸÇÿ∑ÿßÿ±ÿßÿ™ÿå ÿ≠Ÿäÿ´ Ÿäÿ¨ŸÖÿπ ÿ®ŸäŸÜ ÿßŸÑÿØŸÇÿ© ÿßŸÑÿπÿßŸÑŸäÿ© Ÿàÿ≥ŸáŸàŸÑÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä ŸÖŸÜÿµÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖÿ™ŸÉÿßŸÖŸÑÿ©.</p>
      
      <h3>ÿßŸÑÿ±ÿ§Ÿäÿ© ŸàÿßŸÑÿ™Ÿàÿ¨Ÿá</h3>
      <p>ŸÜÿ≠ŸÜ ŸÜÿ§ŸÖŸÜ ÿ®ÿ£ŸÜ ÿ™ŸÉŸÜŸàŸÑŸàÿ¨Ÿäÿß ÿßŸÑŸÜŸÇŸÑ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÅŸä ŸÖÿ™ŸÜÿßŸàŸÑ ÿßŸÑÿ¨ŸÖŸäÿπ. ŸÖŸÜ ÿÆŸÑÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿå ŸÜÿ≥ÿπŸâ ÿ•ŸÑŸâ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑÿ≥ŸÅÿ± ÿ®ÿßŸÑŸÇÿ∑ÿßÿ± Ÿàÿ¨ÿπŸÑŸáÿß ÿ£ŸÉÿ´ÿ± ÿ≥ŸÑÿßÿ≥ÿ© ŸàŸÖŸàÿ´ŸàŸÇŸäÿ©.</p>
      
      <h3>ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ™ŸÇŸÜŸäÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©</h3>
      <ul class="about-features">
        <li>ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÅÿπŸÑŸä ÿ®ÿØŸÇÿ© ÿπÿßŸÑŸäÿ©</li>
        <li>ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ∞ŸÉŸäÿ© ŸÇÿ®ŸÑ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿßÿ™</li>
        <li>ÿÆÿ±Ÿäÿ∑ÿ© ÿ™ŸÅÿßÿπŸÑŸäÿ© ŸÖÿ™ŸÉÿßŸÖŸÑÿ© ŸÖÿπ ŸÜÿ∏ÿßŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàÿßŸÇÿπ</li>
        <li>Ÿàÿßÿ¨Ÿáÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπÿ±ÿ®Ÿäÿ© ŸÖÿµŸÖŸÖÿ© ÿ®ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÖÿπÿßŸäŸäÿ±</li>
        <li>ÿπŸÖŸÑ ŸÉÿßŸÖŸÑ ŸÅŸä ÿ∏ŸÑ ÿ∏ÿ±ŸàŸÅ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑÿ∂ÿπŸäŸÅ</li>
        <li>ÿ™ÿµŸÖŸäŸÖ ŸÖÿ™ÿ¨ÿßŸàÿ® ŸäÿπŸÖŸÑ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©</li>
        <li>ŸÜÿ∏ÿßŸÖ ÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿ≠ŸÑŸä ÿ¢ŸÖŸÜ ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™</li>
        <li>ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ŸÖŸÜÿÆŸÅÿ∂ ŸÑŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ© ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</li>
        <li>ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸàÿ±Ÿäÿ© ŸÖÿ≠ŸÑŸäÿ© ÿ®ÿØŸàŸÜ ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ</li>
        <li>ÿØÿπŸÖ Service Worker ŸÑŸÑÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™</li>
        <li>ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ© ÿßŸÑŸÖŸàÿßÿµŸÅÿßÿ™</li>
      </ul>

      <div class="performance-info">
        <h4>ŸÉŸÅÿßÿ°ÿ© ÿßŸÑÿ£ÿØÿßÿ°</h4>
        <p>ÿ™ŸÖ ÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÑŸÑÿπŸÖŸÑ ÿ®ŸÉŸÅÿßÿ°ÿ© ÿ≠ÿ™Ÿâ ŸÖÿπ ÿ≥ÿ±ÿπÿßÿ™ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ÿ©ÿå ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿØŸÇÿ© ÿßŸÑÿ™ÿ™ÿ®ÿπ Ÿàÿ≥ÿ±ÿπÿ© ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©.</p>
        <div class="performance-stats">
          <div class="stat-item">
            <div class="stat-value">&lt; 100KB</div>
            <div class="stat-label">ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">99.8%</div>
            <div class="stat-label">ŸÖŸàÿ´ŸàŸÇŸäÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">0.5s</div>
            <div class="stat-label">ÿ≥ÿ±ÿπÿ© ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">24/7</div>
            <div class="stat-label">ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä</div>
          </div>
        </div>
      </div>
      
      <h3>ŸÅÿ±ŸäŸÇ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±</h3>
      <p><strong>Samaan Nady</strong> - ŸÖÿµŸÖŸÖ ŸàŸÖÿ∑Ÿàÿ± Ÿàÿßÿ¨Ÿáÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</p>
      <p>ŸÖÿ™ÿÆÿµÿµ ŸÅŸä ÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿ™ŸÇŸÜŸäÿ© ÿßŸÑŸÖÿ®ÿ™ŸÉÿ±ÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ¨ŸÖÿπ ÿ®ŸäŸÜ ÿßŸÑÿ¨ŸÖÿßŸÑ ÿßŸÑÿ®ÿµÿ±Ÿä ŸàÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑŸÅÿßÿ¶ŸÇ. Ÿäÿ™ŸÖŸäÿ≤ ÿ®ÿÆÿ®ÿ±ÿ© Ÿàÿßÿ≥ÿπÿ© ŸÅŸä ÿ™ÿ∑ŸàŸäÿ± ÿ™ÿ∑ÿ®ŸäŸÇÿßÿ™ ÿßŸÑŸàŸäÿ® ÿßŸÑÿ™ŸÇÿØŸÖŸäÿ© (PWA) ŸàÿßŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿ™Ÿä ÿ™ÿπŸÖŸÑ ŸÅŸä ÿ∏ÿ±ŸàŸÅ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑŸÖÿ≠ÿØŸàÿØ.</p>
      
      <h3>ÿßŸÑÿ™ŸÇŸÜŸäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©</h3>
      <p>Ÿäÿπÿ™ŸÖÿØ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿπŸÑŸâ ÿ£ÿ≠ÿØÿ´ ÿ™ŸÇŸÜŸäÿßÿ™ ÿßŸÑŸàŸäÿ® ÿ®ŸÖÿß ŸÅŸä ÿ∞ŸÑŸÉ Service Workers ŸÑŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ§ŸÇÿ™ÿå IndexedDB ŸÑŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸäÿå ŸàWeb Workers ŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿØŸàŸÜ ÿßŸÑÿ™ÿ£ÿ´Ÿäÿ± ÿπŸÑŸâ ÿ£ÿØÿßÿ° ÿßŸÑŸàÿßÿ¨Ÿáÿ©.</p>
    </div>
  </div>

  <!-- Sidebar Menu -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑÿßÿ¥ÿπÿßÿ±ÿßÿ™</h2>
      <button id="closeSidebar" class="btn ghost" style="padding: 8px">‚úï</button>
    </div>
    
    <div class="sidebar-section">
      <h3>ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</h3>
      
      <div class="sidebar-option">
        <span>Ÿàÿ∂ÿπ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©</span>
        <label class="toggle-switch">
          <input type="checkbox" id="mapToggleSetting">
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="sidebar-option">
        <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</span>
        <label class="toggle-switch">
          <input type="checkbox" id="notificationsToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="sidebar-option">
        <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™</span>
        <label class="toggle-switch">
          <input type="checkbox" id="soundToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="sidebar-option">
        <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßŸáÿ™ÿ≤ÿßÿ≤</span>
        <label class="toggle-switch">
          <input type="checkbox" id="vibrationToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="sidebar-option">
        <span>ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä</span>
        <label class="toggle-switch">
          <input type="checkbox" id="darkModeToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="sidebar-option">
        <span>Ÿàÿ∂ÿπ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
        <label class="toggle-switch">
          <input type="checkbox" id="dataSaverToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="sidebar-option">
        <span>Ÿàÿ∂ÿπ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©</span>
        <label class="toggle-switch">
          <input type="checkbox" id="batterySaverToggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    
    <div class="sidebar-section">
      <h3>ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©</h3>
      
      <div class="notification-settings-panel">
        <div class="notification-settings-title">
          <span>‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</span>
        </div>
        
        <div class="notification-setting">
          <div>
            <div class="notification-setting-label">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©</div>
            <div class="notification-setting-description">ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="localNotificationsToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="notification-setting">
          <div>
            <div class="notification-setting-label">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ</div>
            <div class="notification-setting-description">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="arrivalNotificationsToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="notification-setting">
          <div>
            <div class="notification-setting-label">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±</div>
            <div class="notification-setting-description">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÇÿ®ŸÑ ŸÖÿ≠ÿ∑ÿ™ŸäŸÜ ŸÖŸÜ ÿßŸÑŸàÿµŸàŸÑ</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="warningNotificationsToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="notification-setting">
          <div>
            <div class="notification-setting-label">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ≥ÿ™ŸÖÿ±ÿ©</div>
            <div class="notification-setting-description">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ™ŸÉÿ±ÿ±ÿ© ÿπŸÜÿØ ÿßŸÑŸàÿµŸàŸÑ</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="continuousNotificationsToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="notification-setting">
          <div>
            <div class="notification-setting-label">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿπÿ≤ÿ≤ÿ©</div>
            <div class="notification-setting-description">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ£ŸÉÿ®ÿ± Ÿàÿ£Ÿàÿ∂ÿ≠ ŸÑŸÑÿ≥ŸÅÿ±</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="enhancedNotificationsToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="notification-setting">
          <div>
            <div class="notification-setting-label">ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿµŸàÿ™Ÿäÿ© ÿπÿßŸÑŸäÿ©</div>
            <div class="notification-setting-description">ÿµŸàÿ™ ÿπÿßŸÑŸä ÿ¨ÿØÿßŸã ÿπŸÜÿØ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="highVolumeNotificationsToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div style="margin-top: 10px; display: flex; gap: 8px">
        <button id="testLocalNotificationsBtn" class="btn" style="flex: 1; padding: 8px">ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</button>
      </div>
      
      <div class="tutorial-steps">
        <div class="tutorial-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <div class="step-title">ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div>
            <div class="step-description">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div>
          </div>
        </div>
        <div class="tutorial-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <div class="step-title">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div>
            <div class="step-description">ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠</div>
          </div>
        </div>
        <div class="tutorial-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <div class="step-title">ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div>
            <div class="step-description">ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÑŸÑÿ™ÿ£ŸÉÿØ</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="sidebar-section">
      <h3>ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h3>
      <div class="test-notification-panel">
        <div class="test-notification-title">
          <span>üß™ ÿßÿÆÿ™ÿ®ÿßÿ± ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</span>
        </div>
        <div class="test-notification-buttons">
          <button id="testNormalNotificationBtn" class="test-notification-btn">ÿπÿßÿØŸä</button>
          <button id="testWarningNotificationBtn" class="test-notification-btn warning">ÿ™ÿ≠ÿ∞Ÿäÿ±</button>
          <button id="testArrivalNotificationBtn" class="test-notification-btn arrival">ŸàÿµŸàŸÑ</button>
          <button id="testHighVolumeNotificationBtn" class="test-notification-btn" style="background: var(--danger); color: white;">ÿµŸàÿ™ ÿπÿßŸÑŸä</button>
          <button id="testEnhancedNotificationBtn" class="test-notification-btn" style="background: var(--accent); color: white;">ŸÖÿπÿ≤ÿ≤</button>
        </div>
      </div>
    </div>
    
    <div class="sidebar-section">
      <h3>ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h3>
      <div class="notification-history">
        <div class="notification-history-title">
          <span>ÿ¢ÿÆÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</span>
          <button class="clear-notifications-btn" id="clearNotificationsBtn">ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ</button>
        </div>
        <div id="notificationHistoryList">
          <div class="notification-history-empty">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ÿπÿØ</div>
        </div>
      </div>
    </div>
    
    <div class="sidebar-section">
      <h3>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ™ÿ®ÿπ</h3>
      <div id="trackingStatusInfo">
        <p>ÿßŸÑÿ™ÿ™ÿ®ÿπ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</p>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ</h3>
      <div class="debug-panel">
        <div class="debug-info">
          <span class="debug-label">ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ≠ÿßŸÑŸä:</span>
          <span class="debug-value" id="debugCurrentLocation">ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±</span>
        </div>
        <div class="debug-info">
          <span class="debug-label">ÿ£ŸÇÿ±ÿ® ŸÖÿ≠ÿ∑ÿ©:</span>
          <span class="debug-value" id="debugNearestStation">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span>
        </div>
        <div class="debug-info">
          <span class="debug-label">ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ŸÑŸÑŸÖÿ≠ÿ∑ÿ©:</span>
          <span class="debug-value" id="debugDistanceToStation">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span>
        </div>
        <div class="debug-info">
          <span class="debug-label">ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:</span>
          <span class="debug-value" id="debugRemainingStations">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span>
        </div>
        <div class="debug-info">
          <span class="debug-label">ÿØŸÇÿ© GPS:</span>
          <span class="debug-value" id="debugGpsAccuracy">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span>
        </div>
        <div class="debug-info">
          <span class="debug-label">ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´:</span>
          <span class="debug-value" id="debugLastUpdate">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span>
        </div>
        <div class="debug-info">
          <span class="debug-label">Service Worker:</span>
          <span class="debug-value" id="debugServiceWorker">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span>
        </div>
        <div class="debug-info">
          <span class="debug-label">ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©:</span>
          <span class="debug-value" id="debugBatteryLevel">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ</h3>
      <div id="systemStatus">
        <p>üü¢ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜÿ∏ŸÖÿ© ÿ™ÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿ∑ÿ®ŸäÿπŸä</p>
        <p class="small">ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: <span id="lastUpdateTime">--:--:--</span></p>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="overlay"></div>

  <div class="container">
    <div class="card" role="application" aria-label="Train Alert Pro">
      <div class="header">
        <div class="brand">
          <div class="logo">SN</div>
          <div>
            <div class="title">Train Alert Pro</div>
            <div class="subtitle">ÿÆÿ∑ ÿßŸÑÿ•ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ© ‚Üî ÿ£ÿ≥ŸàÿßŸÜ ‚Äî ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÇÿ∑ÿßÿ±ÿßÿ™ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸä</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="status-indicator online" id="connectionStatus">ŸÖÿ™ÿµŸÑ</div>
          <div class="proximity-indicator" id="proximityIndicator" style="display:none">ÿ®ÿπŸäÿØ ÿπŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿ©</div>
          <button id="menuBtn" class="btn ghost" title="ÿßŸÑŸÇÿßÿ¶ŸÖÿ©">‚ò∞</button>
        </div>
      </div>

      <div class="layout" id="layout">
        <div class="left-col" id="leftCol">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:900">ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ±ÿ≠ŸÑÿ©</div>
              <div class="route-info small">ÿßÿÆÿ™ÿ± ŸÜŸÇÿ∑ÿ© ÿßŸÑŸÇŸäÿßŸÖ ŸàÿßŸÑŸàÿµŸàŸÑ</div>
            </div>
            <div style="text-align:center">
              <div style="font-weight:800;color:var(--gold)">üöÜ SN</div>
            </div>
          </div>

          <div class="controls-row" style="margin-top:12px">
            <div class="input-group">
              <label>ŸÖŸÜ (ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸÇŸäÿßŸÖ)</label>
              <div class="custom-select">
                <select id="startSelect" aria-label="ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸÇŸäÿßŸÖ"></select>
              </div>
            </div>
            <div class="input-group">
              <label>ÿ•ŸÑŸâ (ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸàÿµŸàŸÑ)</label>
              <div class="custom-select">
                <select id="destSelect" aria-label="ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸàÿµŸàŸÑ"></select>
              </div>
            </div>
          </div>

          <button id="trackingBtn" class="btn tracking-btn">
            <span id="trackingIcon">üöÄ</span>
            <span id="trackingText">ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ™ÿ®ÿπ</span>
          </button>

          <div id="routeInfo" class="route-info"></div>
          <div class="progress-bar">
            <div class="progress" id="routeProgress"></div>
          </div>
          <div id="timeline" class="timeline" aria-live="polite"></div>
        </div>
        <div class="right-col" id="rightCol">
          <div class="map-container">
            <div id="map" class="map" role="region" aria-label="ÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÖÿ≥ÿßÿ±"></div>
            <div id="mapError" class="map-error hidden">
              <p>ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©</p>
              <button id="retryMapBtn">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
            </div>
            <button id="mapControlBtn" class="map-control">üó∫Ô∏è</button>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>ŸÖÿ¨ÿßŸÜÿßŸã 100% ‚Ä¢ ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸä ‚Ä¢ ÿ™ÿµŸÖŸäŸÖ ÿ∞Ÿáÿ®Ÿä/ÿ±ŸÖÿßÿØŸä</div>
        <div>üöÜ <strong>Samaan Nady</strong></div>
      </div>
    </div>
  </div>

  <div class="floating-action" id="floatingBtn" title="ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©">
    ‚öôÔ∏è
    <div class="notification-badge hidden" id="notificationBadge">0</div>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <!-- Enhanced Notification Modal -->
  <div class="enhanced-notification" id="enhancedNotification">
    <div class="notification-icon" id="enhancedNotificationIcon">üîî</div>
    <h2 id="enhancedNotificationTitle">ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±</h2>
    <p id="enhancedNotificationBody">ŸÜÿµ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±</p>
    <div class="notification-actions">
      <button id="enhancedNotificationPrimary" class="notification-btn primary-btn">ŸÖŸàÿßŸÅŸÇ</button>
      <button id="enhancedNotificationSecondary" class="notification-btn secondary-btn">ÿ™ÿ¨ÿßŸáŸÑ</button>
    </div>
  </div>

  <!-- Offline Indicator -->
  <div class="offline-indicator" id="offlineIndicator">
    <span>ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸÅŸä Ÿàÿ∂ÿπ ÿπÿØŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ</span>
  </div>

<script>
// Service Worker Registration for PWA functionality
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('data:text/javascript,' + encodeURIComponent(`
      self.addEventListener('install', event => {
        self.skipWaiting();
      });
      
      self.addEventListener('activate', event => {
        event.waitUntil(clients.claim());
      });
      
      self.addEventListener('push', event => {
        const options = {
          body: event.data ? event.data.text() : 'Train Alert Pro',
          icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
          badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
          tag: 'train-alert',
          requireInteraction: true,
          actions: [
            { action: 'open', title: 'ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ' },
            { action: 'dismiss', title: 'ÿ™ÿ¨ÿßŸáŸÑ' }
          ]
        };
        
        event.waitUntil(
          self.registration.showNotification('Train Alert Pro', options)
        );
      });
      
      self.addEventListener('notificationclick', event => {
        event.notification.close();
        
        if (event.action === 'open') {
          event.waitUntil(
            clients.matchAll({ type: 'window' }).then(clientList => {
              for (let i = 0; i < clientList.length; i++) {
                const client = clientList[i];
                if (client.url === '/' && 'focus' in client) {
                  return client.focus();
                }
              }
              if (clients.openWindow) {
                return clients.openWindow('/');
              }
            })
          );
        }
      });
    `))
    .then(registration => {
      console.log('ServiceWorker registration successful');
      document.getElementById('debugServiceWorker').textContent = 'ŸÖÿ≥ÿ¨ŸÑ';
    })
    .catch(err => {
      console.log('ServiceWorker registration failed: ', err);
      document.getElementById('debugServiceWorker').textContent = 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ';
    });
  });
}

// ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° ŸÑŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑÿÆŸÅŸäŸÅ
const PERFORMANCE_OPTIMIZATIONS = {
  dataSaver: true,
  cacheMapTiles: true,
  limitPositionUpdates: true,
  compressData: true,
  batterySaver: false
};

// ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
let localNotificationSettings = {
  enabled: false,
  permission: 'default', // 'granted', 'denied', 'default'
  arrivalNotifications: true,
  warningNotifications: true,
  continuousNotifications: true,
  enhancedNotifications: true,
  highVolumeNotifications: true
};

// ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
let notificationHistory = [];

/* Stations EXACT ORDER provided by you - ŸÖÿπ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ */
const STATIONS = [
  { name:"ÿßŸÑÿ•ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©", lat:31.2001, lng:29.9187 },
  { name:"ÿ≥ŸäÿØŸä ÿ¨ÿßÿ®ÿ±", lat:31.2058, lng:29.9417 },
  { name:"ÿØŸÖŸÜŸáŸàÿ±", lat:31.0364, lng:30.4707 },
  { name:"ÿ∑ŸÜÿ∑ÿß", lat:30.7866, lng:31.0004 },
  { name:"ÿßŸÑŸÇÿßŸáÿ±ÿ©", lat:30.0444, lng:31.2357 },
  { name:"ÿµÿπŸäÿØ ŸÖÿµÿ±", lat:29.9668, lng:31.2500 },
  { name:"ÿßŸÑÿ¨Ÿäÿ≤ÿ©", lat:30.0131, lng:31.2089 },
  { name:"ÿßŸÑŸàÿßÿ≥ÿ∑Ÿä", lat:27.6950, lng:30.9200 },
  { name:"ÿ®ŸÜŸä ÿ≥ŸàŸäŸÅ", lat:29.0668, lng:31.0988 },
  { name:"ŸÖÿ∫ÿßÿ∫ÿ©", lat:27.9231, lng:30.8400 },
  { name:"ÿßŸÑŸÖŸÜŸäÿß", lat:28.1010, lng:30.7485 },
  { name:"ŸÖŸÑŸàŸä", lat:28.7120, lng:30.8150 },
  { name:"ÿØŸäÿ±Ÿàÿ∑", lat:27.3000, lng:31.4000 },
  { name:"ÿßÿ≥ŸäŸàÿ∑", lat:27.1783, lng:31.1858 },
  { name:"ÿ∑ŸÖÿß", lat:26.9500, lng:31.8000 },
  { name:"ÿ∑Ÿáÿ∑ÿß", lat:26.5700, lng:31.6700 }, // ÿ™ŸÖ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿßÿ≥ŸÖ ŸÖŸÜ "ÿ∑Ÿáÿ™ÿß" ÿ•ŸÑŸâ "ÿ∑Ÿáÿ∑ÿß"
  { name:"ÿ≥ŸàŸáÿßÿ¨", lat:26.5560, lng:31.6956 },
  { name:"ÿ¨ÿ±ÿ¨ÿß", lat:26.2165, lng:31.5294 },
  { name:"ÿßŸÑÿ®ŸÑŸäŸÜÿß", lat:26.2425, lng:32.2850 }, // ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ŸÖÿ≠ÿ≥ŸÜÿ© ÿ®ÿØŸÇÿ©
  { name:"ŸÜÿ¨ÿπ ÿ≠ŸÖÿßÿØŸä", lat:26.1803, lng:31.6958 },
  { name:"ŸÇŸÜÿß", lat:26.1553, lng:32.7160 },
  { name:"ŸÇŸàÿµ", lat:25.9470, lng:32.7180 },
  { name:"ÿßŸÑÿßŸÇÿµÿ±", lat:25.6872, lng:32.6396 },
  { name:"ÿßÿ±ŸÖŸÜÿ™", lat:25.6637, lng:32.5636 },
  { name:"ÿßÿ≥ŸÜÿß", lat:25.2990, lng:32.6420 },
  { name:"ÿßŸÑÿ≥ÿ®ÿßÿπŸäÿ©", lat:25.0500, lng:32.7000 },
  { name:"ÿßÿØŸÅŸà", lat:24.9739, lng:32.8758 },
  { name:"ÿ≥ŸÑŸàÿß", lat:24.8000, lng:32.9000 },
  { name:"ŸÉŸÑÿßÿ®ÿ¥ÿ©", lat:24.5660, lng:32.9000 },
  { name:"ŸÉŸàŸÖ ÿßŸÖÿ®Ÿà", lat:24.4599, lng:32.9450 },
  { name:"ÿØÿ±ÿßŸà", lat:24.3500, lng:32.8610 },
  { name:"ÿßÿ≥ŸàÿßŸÜ", lat:24.0890, lng:32.8998 }
];

/* State */
let map, routeLine, userMarker, trainMarker;
let watchId = null;
let lastPos = null, lastTs = null;
let audioCtx = null, ringTimer = null;
let preWarnedAt = null, arrivedFlag = false;
let routeIndices = [];
let wakeLock = null;
let isOnline = navigator.onLine;
let notificationCount = 0;
let isMainTab = false;
let mapVisible = false;
let isTracking = false;
let networkQuality = 'good'; // good, weak, offline
let trackingState = {
  active: false,
  startIdx: 0,
  destIdx: STATIONS.length - 1,
  wa: '',
  email: ''
};

// Notifications array
let notifications = [];

// ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ°
let positionUpdateInterval = 1000; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ŸÉŸÑ ÿ´ÿßŸÜŸäÿ©
let lastPositionUpdate = 0;

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©
let continuousNotificationInterval = null;
let arrivalNotificationShown = false;
let userConfirmedArrival = false; // ŸÖÿ™ÿ∫Ÿäÿ± ÿ¨ÿØŸäÿØ ŸÑÿ™ÿ™ÿ®ÿπ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑÿ™ÿ™ÿ®ÿπ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
let lastWarningNotificationTime = 0;
let lastArrivalNotificationTime = 0;
let lastContinuousNotificationTime = 0;

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑÿ™ÿ™ÿ®ÿπ ÿØŸÇÿ© GPS
let gpsAccuracy = null;
let lastGpsUpdateTime = null;
let gpsImprovementAttempts = 0;
let gpsImprovementInterval = null;

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑÿ™ÿ™ÿ®ÿπ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©
let batteryLevel = null;
let batteryCharging = null;

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿØŸÇÿ© ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿßÿ™
let stationProximityCheck = {
  lastCheckTime: 0,
  checkInterval: 5000, // 5 ÿ´ŸàÿßŸÜŸç ÿ®ŸäŸÜ ŸÉŸÑ ŸÅÿ≠ÿµ
  arrivalThreshold: 0.3, // 300 ŸÖÿ™ÿ± ŸÉÿπÿ™ÿ®ÿ© ŸÑŸÑŸàÿµŸàŸÑ
  confirmationThreshold: 0.15, // 150 ŸÖÿ™ÿ± ŸÑŸÑÿ™ÿ£ŸÉŸäÿØ
  confirmedStations: new Set() // ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸäŸáÿß
};

/* ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ¨ŸàÿØÿ© ÿßŸÑÿ¥ÿ®ŸÉÿ© */
function monitorNetworkQuality() {
  if (!navigator.onLine) {
    networkQuality = 'offline';
    updateNetworkStatus();
    return;
  }

  // ŸÖÿ≠ÿßŸÉÿßÿ© ŸÇŸäÿßÿ≥ ÿ¨ŸàÿØÿ© ÿßŸÑÿ¥ÿ®ŸÉÿ© (ŸÅŸä ÿ™ÿ∑ÿ®ŸäŸÇ ÿ≠ŸÇŸäŸÇŸä ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Navigation Timing API)
  const startTime = performance.now();
  
  fetch('/', { method: 'HEAD', cache: 'no-cache' })
    .then(() => {
      const latency = performance.now() - startTime;
      if (latency < 500) {
        networkQuality = 'good';
      } else if (latency < 2000) {
        networkQuality = 'weak';
      } else {
        networkQuality = 'offline';
      }
      updateNetworkStatus();
    })
    .catch(() => {
      networkQuality = 'offline';
      updateNetworkStatus();
    });
}

function updateNetworkStatus() {
  const networkStatus = document.getElementById('networkStatus');
  if (!networkStatus) return;
  
  switch(networkQuality) {
    case 'good':
      networkStatus.textContent = 'ÿßÿ™ÿµÿßŸÑ ŸÖŸÖÿ™ÿßÿ≤';
      networkStatus.className = 'network-status';
      break;
    case 'weak':
      networkStatus.textContent = 'ÿßÿ™ÿµÿßŸÑ ÿ∂ÿπŸäŸÅ';
      networkStatus.className = 'network-status weak';
      break;
    case 'offline':
      networkStatus.textContent = 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
      networkStatus.className = 'network-status offline';
      break;
  }
  
  // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
  if (networkQuality === 'weak' || networkQuality === 'offline') {
    PERFORMANCE_OPTIMIZATIONS.dataSaver = true;
    document.getElementById('dataSaverToggle').checked = true;
    applyDataSaverSettings();
  }
}

/* ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ */
function applyDataSaverSettings() {
  if (PERFORMANCE_OPTIMIZATIONS.dataSaver) {
    positionUpdateInterval = 3000; // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ®ÿ∑ÿ£ ŸÑÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    if (map && mapVisible) {
      // ÿ™ŸÇŸÑŸäŸÑ ÿ¨ŸàÿØÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÅŸä Ÿàÿ∂ÿπ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
      map.options.updateWhenIdle = false;
      map.options.updateWhenZooming = false;
    }
  } else {
    positionUpdateInterval = 1000;
    if (map && mapVisible) {
      map.options.updateWhenIdle = true;
      map.options.updateWhenZooming = true;
    }
  }
}

/* Connection status monitoring */
window.addEventListener('online', () => {
  isOnline = true;
  updateConnectionStatus();
  monitorNetworkQuality();
  showToast('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
  document.getElementById('offlineIndicator').classList.remove('show');
});

window.addEventListener('offline', () => {
  isOnline = false;
  networkQuality = 'offline';
  updateConnectionStatus();
  updateNetworkStatus();
  showToast('ÿßŸÜŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ÿå ŸäÿπŸÖŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸä Ÿàÿ∂ÿπ ÿπÿØŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ');
  document.getElementById('offlineIndicator').classList.add('show');
});

function updateConnectionStatus() {
  const statusEl = document.getElementById('connectionStatus');
  if (isOnline) {
    statusEl.textContent = 'ŸÖÿ™ÿµŸÑ';
    statusEl.className = 'status-indicator online';
  } else {
    statusEl.textContent = 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
    statusEl.className = 'status-indicator offline';
  }
}

// ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ GPS
function improveGPSAccuracy() {
  if (!isTracking || gpsAccuracy < 50) return; // GPS ÿ¨ŸäÿØ ÿ®ÿßŸÑŸÅÿπŸÑ
  
  gpsImprovementAttempts++;
  
  // ÿ•ÿπÿßÿØÿ© ÿ∑ŸÑÿ® ÿßŸÑŸÖŸàŸÇÿπ ÿ®ÿØŸÇÿ© ÿ£ÿπŸÑŸâ
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
  }
  
  const highAccuracyOptions = {
    enableHighAccuracy: true,
    maximumAge: 1000, // 1 ÿ´ÿßŸÜŸäÿ© ŸÅŸÇÿ∑
    timeout: 20000     // 20 ÿ´ÿßŸÜŸäÿ©
  };
  
  watchId = navigator.geolocation.watchPosition(
    p => {
      updatePosition(p.coords.latitude, p.coords.longitude, p.coords.accuracy, p.timestamp || Date.now());
      
      // ÿ•ÿ∞ÿß ÿ™ÿ≠ÿ≥ŸÜÿ™ ÿßŸÑÿØŸÇÿ©ÿå ÿ£ŸàŸÇŸÅ ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ
      if (p.coords.accuracy < 50) {
        stopGPSImprovement();
        showToast('ÿ™ŸÖ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿØŸÇÿ© GPS ÿ®ŸÜÿ¨ÿßÿ≠');
      }
    }, 
    err => {
      console.warn('GPS improvement error:', err);
      if (gpsImprovementAttempts >= 3) {
        stopGPSImprovement();
        showToast('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿ≥ŸäŸÜ GPSÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿØŸÇÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©');
      }
    }, 
    highAccuracyOptions
  );
}

function stopGPSImprovement() {
  if (gpsImprovementInterval) {
    clearInterval(gpsImprovementInterval);
    gpsImprovementInterval = null;
  }
  gpsImprovementAttempts = 0;
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© GPS ŸÖÿπ ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™
function updateGpsStatus(accuracy) {
  const gpsStatus = document.getElementById('gpsStatus');
  if (!gpsStatus) return;
  
  gpsAccuracy = accuracy;
  lastGpsUpdateTime = new Date().toLocaleTimeString('ar-EG');
  
  // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
  document.getElementById('debugGpsAccuracy').textContent = accuracy ? `${accuracy.toFixed(0)}ŸÖ` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
  document.getElementById('debugLastUpdate').textContent = lastGpsUpdateTime;
  
  if (!accuracy) {
    gpsStatus.textContent = 'GPS ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
    gpsStatus.className = 'gps-status offline';
    return;
  }
  
  // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ™ÿ®ÿßÿ™ ÿßŸÑÿØŸÇÿ©
  if (accuracy < 10) {
    gpsStatus.textContent = 'GPS ŸÖŸÖÿ™ÿßÿ≤';
    gpsStatus.className = 'gps-status';
    stopGPSImprovement();
  } else if (accuracy < 30) {
    gpsStatus.textContent = 'GPS ÿ¨ŸäÿØ';
    gpsStatus.className = 'gps-status';
    stopGPSImprovement();
  } else if (accuracy < 100) {
    gpsStatus.textContent = 'GPS ÿ∂ÿπŸäŸÅ';
    gpsStatus.className = 'gps-status weak';
    
    // ÿ®ÿØÿ° ÿ™ÿ≠ÿ≥ŸäŸÜ GPS ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸÜÿ¥ÿ∑ÿßŸã
    if (isTracking && !gpsImprovementInterval && gpsImprovementAttempts < 3) {
      gpsImprovementInterval = setInterval(() => {
        improveGPSAccuracy();
      }, 10000); // ŸÉŸÑ 10 ÿ´ŸàÿßŸÜŸç
    }
  } else {
    gpsStatus.textContent = 'GPS ÿ≥Ÿäÿ°';
    gpsStatus.className = 'gps-status offline';
    
    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÅŸàÿ±Ÿäÿ© ŸÑŸÑÿØŸÇÿ© ÿßŸÑÿ≥Ÿäÿ¶ÿ©
    if (isTracking && gpsImprovementAttempts < 3) {
      improveGPSAccuracy();
    }
  }
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©
function updateBatteryStatus(level, charging) {
  const batteryStatus = document.getElementById('batteryStatus');
  if (!batteryStatus) return;
  
  batteryLevel = level;
  batteryCharging = charging;
  
  // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
  document.getElementById('debugBatteryLevel').textContent = `${Math.round(level * 100)}% ${charging ? '(ÿ¥ÿ≠ŸÜ)' : ''}`;
  
  if (!level) {
    batteryStatus.style.display = 'none';
    return;
  }
  
  batteryStatus.style.display = 'flex';
  
  if (level > 0.5) {
    batteryStatus.textContent = 'ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ© ÿ¨ŸäÿØÿ©';
    batteryStatus.className = 'battery-status';
  } else if (level > 0.2) {
    batteryStatus.textContent = 'ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ© ÿ∂ÿπŸäŸÅÿ©';
    batteryStatus.className = 'battery-status low';
  } else {
    batteryStatus.textContent = 'ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ©';
    batteryStatus.className = 'battery-status critical';
  }
}

// ÿØÿßŸÑÿ© ŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©
function monitorBatteryStatus() {
  if ('getBattery' in navigator) {
    navigator.getBattery().then(battery => {
      updateBatteryStatus(battery.level, battery.charging);
      
      battery.addEventListener('levelchange', () => {
        updateBatteryStatus(battery.level, battery.charging);
      });
      
      battery.addEventListener('chargingchange', () => {
        updateBatteryStatus(battery.level, battery.charging);
      });
    });
  }
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ§ÿ¥ÿ± ÿßŸÑŸÇÿ±ÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿ©
function updateProximityIndicator(distance, remaining) {
  const proximityIndicator = document.getElementById('proximityIndicator');
  if (!proximityIndicator) return;
  
  if (remaining === 0 || distance <= 0.6) {
    proximityIndicator.textContent = 'ŸÑŸÇÿØ ŸàÿµŸÑÿ™!';
    proximityIndicator.className = 'proximity-indicator arrival';
    proximityIndicator.style.display = 'flex';
  } else if (remaining <= 2) {
    proximityIndicator.textContent = 'ŸÇÿ±Ÿäÿ® ÿ¨ÿØÿßŸã';
    proximityIndicator.className = 'proximity-indicator warning';
    proximityIndicator.style.display = 'flex';
  } else if (remaining <= 5) {
    proximityIndicator.textContent = 'ŸÇÿ±Ÿäÿ®';
    proximityIndicator.className = 'proximity-indicator';
    proximityIndicator.style.display = 'flex';
  } else {
    proximityIndicator.style.display = 'none';
  }
}

// ÿØÿßŸÑÿ© ŸÑÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function requestNotificationPermission() {
  if (!('Notification' in window)) {
    console.log('Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
    return Promise.resolve(false);
  }
  
  if (Notification.permission === 'granted') {
    localNotificationSettings.enabled = true;
    localNotificationSettings.permission = 'granted';
    updateLocalNotificationStatus();
    return Promise.resolve(true);
  }
  
  if (Notification.permission === 'denied') {
    localNotificationSettings.enabled = false;
    localNotificationSettings.permission = 'denied';
    updateLocalNotificationStatus();
    return Promise.resolve(false);
  }
  
  // ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  return Notification.requestPermission().then(permission => {
    localNotificationSettings.permission = permission;
    localNotificationSettings.enabled = permission === 'granted';
    updateLocalNotificationStatus();
    
    // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸä localStorage
    if (permission === 'granted') {
      localStorage.setItem('notificationsEnabled', 'true');
      localStorage.setItem('notificationPermission', 'granted');
    }
    
    return permission === 'granted';
  });
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ≠ŸÑŸäÿ©
function sendLocalNotification(title, body, options = {}) {
  if (!localNotificationSettings.enabled) {
    console.log('ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
    return false;
  }
  
  try {
    const notification = new Notification(title, {
      body: body,
      icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
      badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
      tag: 'train-alert',
      requireInteraction: options.urgent || false,
      silent: !options.sound,
      ...options
    });
    
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ 7 ÿ´ŸàÿßŸÜŸç ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿπÿßÿ¨ŸÑÿßŸã
    if (!options.urgent) {
      setTimeout(() => {
        notification.close();
      }, 7000);
    }
    
    notification.onclick = () => {
      window.focus();
      notification.close();
    };
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
    addToNotificationHistory(title, body);
    
    console.log('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠:', title);
    return true;
  } catch (error) {
    console.error('Error sending local notification:', error);
    return false;
  }
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπÿ≤ÿ≤ - Ÿáÿ∞Ÿá ŸáŸä ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function sendEnhancedNotification(title, body, icon = 'üîî', options = {}) {
  if (!localNotificationSettings.enabled) {
    console.log('ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
    return false;
  }
  
  // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿπÿ≤ÿ≤ ÿØÿßÿ¶ŸÖÿßŸã
  const enhancedNotification = document.getElementById('enhancedNotification');
  const enhancedIcon = document.getElementById('enhancedNotificationIcon');
  const enhancedTitle = document.getElementById('enhancedNotificationTitle');
  const enhancedBody = document.getElementById('enhancedNotificationBody');
  const primaryBtn = document.getElementById('enhancedNotificationPrimary');
  const secondaryBtn = document.getElementById('enhancedNotificationSecondary');
  
  enhancedIcon.textContent = icon;
  enhancedTitle.textContent = title;
  enhancedBody.textContent = body;
  
  // ÿ™ÿπŸäŸäŸÜ Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
  primaryBtn.onclick = () => {
    enhancedNotification.classList.remove('active');
    if (options.primaryAction) {
      options.primaryAction();
    }
  };
  
  secondaryBtn.onclick = () => {
    enhancedNotification.classList.remove('active');
    if (options.secondaryAction) {
      options.secondaryAction();
    }
  };
  
  enhancedNotification.classList.add('active');
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿ≠ŸÑŸä ÿ£Ÿäÿ∂ÿßŸã
  sendLocalNotification(title, body, options);
  
  // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  addToNotificationHistory(title, body);
  
  // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™ ŸàÿßŸÑÿßŸáÿ™ÿ≤ÿßÿ≤
  if (options.sound) {
    playBeep(options.frequency || 880, options.duration || 200);
  }
  
  if (options.vibrate && document.getElementById('vibrationToggle').checked) {
    navigator.vibrate && navigator.vibrate(options.vibratePattern || [200, 100, 200]);
  }
  
  return true;
}

// ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© ÿßŸÑŸàÿµŸàŸÑ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜÿßŸÅÿ∞ÿ© high-volume-content
function arrivalAction(station){
  console.log('ŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≠ÿ∑ÿ©:', station.name);
  
  arrivedFlag = true;
  arrivalNotificationShown = true;
  
  // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿ≠ÿ∑ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÖŸÜ ÿßŸÑÿ™ÿ™ÿ®ÿπ
  const startStation = STATIONS[trackingState.startIdx].name;
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿµŸàÿ™Ÿä ÿπÿßŸÑŸä ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜÿßŸÅÿ∞ÿ© high-volume-content
  sendHighVolumeNotification(
    `üöâ ŸÑŸÇÿØ ŸàÿµŸÑÿ™ ÿ•ŸÑŸâ ${station.name}!`, 
    `ŸàÿµŸÑÿ™ ŸÖŸÜ ${startStation} ÿ•ŸÑŸâ ${station.name}\n\nüö® ÿ™ŸÜÿ®ŸäŸá ÿπÿßÿ¨ŸÑ üö®\nÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ™ÿπŸÑŸÇÿßÿ™ŸÉ ŸàÿßŸÜÿ≤ŸÑ ÿ®ÿ£ŸÖÿßŸÜ\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
    station
  );
}

// ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿµŸàÿ™Ÿä ÿßŸÑÿπÿßŸÑŸä
function sendHighVolumeNotification(title, body, station) {
  if (!localNotificationSettings.enabled || !localNotificationSettings.highVolumeNotifications) {
    console.log('ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ© ÿßŸÑÿπÿßŸÑŸäÿ© ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©');
    return false;
  }
  
  // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿµŸàÿ™Ÿä ÿßŸÑÿπÿßŸÑŸä
  const highVolumeNotification = document.getElementById('highVolumeNotification');
  const highVolumeTitle = document.getElementById('highVolumeTitle');
  const highVolumeBody = document.getElementById('highVolumeBody');
  const confirmBtn = document.getElementById('highVolumeConfirm');
  const dismissBtn = document.getElementById('highVolumeDismiss');
  
  highVolumeTitle.textContent = title;
  highVolumeBody.textContent = body;
  
  // ÿ•ÿ≤ÿßŸÑÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑŸÇÿØŸäŸÖÿ©
  const newConfirmBtn = confirmBtn.cloneNode(true);
  const newDismissBtn = dismissBtn.cloneNode(true);
  confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
  dismissBtn.parentNode.replaceChild(newDismissBtn, dismissBtn);
  
  // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿ£ÿ≠ÿØÿßÿ´ ÿ¨ÿØŸäÿØÿ©
  newConfirmBtn.addEventListener('click', () => {
    highVolumeNotification.classList.remove('active');
    userConfirmedArrival = true;
    stopContinuousNotifications();
    stopTracking();
    showToast('ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸàÿµŸàŸÑ Ÿàÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ™ÿ®ÿπ');
  });
  
  newDismissBtn.addEventListener('click', () => {
    highVolumeNotification.classList.remove('active');
    showToast('ÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸàÿµŸàŸÑ');
  });
  
  highVolumeNotification.classList.add('active');
  
  // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿπÿßŸÑŸä ÿ¨ÿØÿßŸã
  playHighVolumeSound();
  
  // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸáÿ™ÿ≤ÿßÿ≤ ŸÇŸàŸä
  if (document.getElementById('vibrationToggle').checked) {
    navigator.vibrate && navigator.vibrate([500, 200, 500, 200, 500]);
  }
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿ≠ŸÑŸä ÿ£Ÿäÿ∂ÿßŸã
  sendLocalNotification(
    title, 
    body,
    { urgent: true, sound: false, vibrate: false }
  );
  
  // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  addToNotificationHistory(title, body);
  
  // ÿ®ÿØÿ° ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ≥ÿ™ŸÖÿ±ÿ© ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
  if (localNotificationSettings.enabled && localNotificationSettings.continuousNotifications && !continuousNotificationInterval) {
    continuousNotificationInterval = setInterval(() => {
      if (isTracking && localNotificationSettings.enabled && localNotificationSettings.continuousNotifications && !userConfirmedArrival) {
        // ÿ•ÿπÿßÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿµŸàÿ™Ÿä ÿßŸÑÿπÿßŸÑŸä
        sendHighVolumeNotification(title, body, station);
      }
    }, 30000); // ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
  }
  
  return true;
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿπÿßŸÑŸä ÿ¨ÿØÿßŸã
function playHighVolumeSound() {
  try {
    ensureAudio();
    if (!audioCtx) {
      if (document.getElementById('vibrationToggle').checked) {
        navigator.vibrate && navigator.vibrate([500, 200, 500]);
      }
      return;
    }
    if (!document.getElementById('soundToggle').checked) return;
    
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ∫ŸÖÿ© ÿπÿßŸÑŸäÿ© ŸàŸÖÿ™ŸÉÿ±ÿ±ÿ©
    const playSequence = () => {
      const o1 = audioCtx.createOscillator();
      const g1 = audioCtx.createGain();
      o1.type = 'sine';
      o1.frequency.value = 800;
      g1.gain.value = 0.3;
      o1.connect(g1);
      g1.connect(audioCtx.destination);
      o1.start();
      o1.stop(audioCtx.currentTime + 0.2);
      
      setTimeout(() => {
        const o2 = audioCtx.createOscillator();
        const g2 = audioCtx.createGain();
        o2.type = 'sine';
        o2.frequency.value = 1000;
        g2.gain.value = 0.4;
        o2.connect(g2);
        g2.connect(audioCtx.destination);
        o2.start();
        o2.stop(audioCtx.currentTime + 0.3);
      }, 300);
      
      setTimeout(() => {
        const o3 = audioCtx.createOscillator();
        const g3 = audioCtx.createGain();
        o3.type = 'sine';
        o3.frequency.value = 1200;
        g3.gain.value = 0.5;
        o3.connect(g3);
        g3.connect(audioCtx.destination);
        o3.start();
        o3.stop(audioCtx.currentTime + 0.4);
      }, 700);
    };
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ≥ŸÑÿ≥ŸÑ 3 ŸÖÿ±ÿßÿ™
    playSequence();
    setTimeout(playSequence, 1500);
    setTimeout(playSequence, 3000);
    
    if (document.getElementById('vibrationToggle').checked) {
      navigator.vibrate && navigator.vibrate([500, 200, 500, 200, 500]);
    }
  } catch (e) {
    if (document.getElementById('vibrationToggle').checked) {
      navigator.vibrate && navigator.vibrate([500, 200, 500, 200, 500]);
    }
  }
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ± ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ¨ŸÑ
function addToNotificationHistory(title, body) {
  const notification = {
    id: Date.now(),
    title,
    body,
    time: new Date().toLocaleTimeString('ar-EG'),
    read: false
  };
  
  notificationHistory.unshift(notification);
  
  // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ŸÄ 20 ÿ•ÿ¥ÿπÿßÿ± ŸÅŸÇÿ∑ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ
  if (notificationHistory.length > 20) {
    notificationHistory = notificationHistory.slice(0, 20);
  }
  
  // ÿ≠ŸÅÿ∏ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸä localStorage
  localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
  
  updateNotificationHistoryUI();
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function updateNotificationHistoryUI() {
  const historyList = document.getElementById('notificationHistoryList');
  
  if (notificationHistory.length === 0) {
    historyList.innerHTML = '<div class="notification-history-empty">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ÿπÿØ</div>';
    return;
  }
  
  historyList.innerHTML = '';
  
  notificationHistory.forEach(notification => {
    const item = document.createElement('div');
    item.className = 'notification-history-item';
    item.innerHTML = `
      <div>${notification.title}</div>
      <div class="small">${notification.body}</div>
      <div class="notification-history-time">${notification.time}</div>
    `;
    historyList.appendChild(item);
  });
}

// ÿØÿßŸÑÿ© ŸÑŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function clearNotificationHistory() {
  notificationHistory = [];
  localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
  updateNotificationHistoryUI();
  showToast('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÅŸä ÿßŸÑŸàÿßÿ¨Ÿáÿ©
function updateLocalNotificationStatus() {
  const localNotificationStatus = document.getElementById('localNotificationStatus');
  if (!localNotificationStatus) return;
  
  if (localNotificationSettings.enabled) {
    localNotificationStatus.textContent = 'ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÅÿπŸÑÿ©';
    localNotificationStatus.className = 'local-notification-status';
  } else {
    localNotificationStatus.textContent = 'ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿπÿ∑ŸÑÿ©';
    localNotificationStatus.className = 'local-notification-status disabled';
  }
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function showNotificationPermissionModal() {
  const modal = document.getElementById('notificationPermissionModal');
  modal.style.display = 'flex';
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function hideNotificationPermissionModal() {
  const modal = document.getElementById('notificationPermissionModal');
  modal.style.display = 'none';
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿ®ÿßŸÜÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function showNotificationBanner() {
  const banner = document.getElementById('notificationBanner');
  banner.classList.add('show');
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿÆŸÅÿßÿ° ÿ®ÿßŸÜÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function hideNotificationBanner() {
  const banner = document.getElementById('notificationBanner');
  banner.classList.remove('show');
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿ•ÿ¥ÿπÿßÿ± Toast
function showNotificationToast(title, body, icon = 'üîî') {
  const toast = document.getElementById('notificationToast');
  const toastIcon = document.getElementById('notificationToastIcon');
  const toastTitle = document.getElementById('notificationToastTitle');
  const toastBody = document.getElementById('notificationToastBody');
  
  toastIcon.textContent = icon;
  toastTitle.textContent = title;
  toastBody.textContent = body;
  
  toast.classList.add('show');
  
  // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  addToNotificationHistory(title, body);
  
  // ÿ•ÿ∫ŸÑÿßŸÇ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜŸç
  setTimeout(() => {
    toast.classList.remove('show');
  }, 5000);
}

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿ•ÿ¥ÿπÿßÿ± Toast
function closeNotificationToast() {
  const toast = document.getElementById('notificationToast');
  toast.classList.remove('show');
}

/* Helpers ŸÖÿ≠ÿ≥ŸÜÿ© */
function toRad(v){ return v * Math.PI / 180; }

// ÿØÿßŸÑÿ© Haversine ŸÖÿ≠ÿ≥ŸÜÿ©
function haversineKm(lat1,lon1,lat2,lon2){
  const R = 6371;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

function formatETA(sec){
  if(!isFinite(sec) || sec<=0) return '‚Äî';
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
  return h>0? `${h} ÿ≥ ${m} ÿØ` : `${m} ÿØ`;
}

function showToast(msg, ms=3000){ 
  const t = document.getElementById('toast'); 
  t.textContent = msg; 
  t.classList.remove('hidden'); 
  setTimeout(()=> t.classList.add('hidden'), ms); 
}

/* Audio & vibration ŸÖÿ≠ÿ≥ŸÜÿ© */
function ensureAudio(){ 
  if(!audioCtx){ 
    try{ 
      audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 
    }catch(e){ 
      audioCtx = null; 
    } 
  } 
}

function playBeep(freq=880,dur=200){ 
  try{ 
    ensureAudio(); 
    if(!audioCtx){ 
      if (document.getElementById('vibrationToggle').checked) {
        navigator.vibrate && navigator.vibrate(150); 
      }
      return; 
    } 
    if (!document.getElementById('soundToggle').checked) return;
    
    const o = audioCtx.createOscillator(); 
    const g = audioCtx.createGain(); 
    o.type='sine'; 
    o.frequency.value=freq; 
    g.gain.value=0.0001; 
    o.connect(g); 
    g.connect(audioCtx.destination); 
    const now = audioCtx.currentTime; 
    g.gain.setValueAtTime(0.0001, now); 
    g.gain.exponentialRampToValueAtTime(0.12, now+0.02); 
    g.gain.exponentialRampToValueAtTime(0.0001, now+(dur/1000)); 
    o.start(now); 
    o.stop(now+(dur/1000)); 
    
    if (document.getElementById('vibrationToggle').checked) {
      navigator.vibrate && navigator.vibrate([160,80,160]); 
    }
  }catch(e){ 
    if (document.getElementById('vibrationToggle').checked) {
      navigator.vibrate && navigator.vibrate(200); 
    }
  } 
}

function startRing(){ 
  if(ringTimer) return; 
  playBeep(440,300); 
  ringTimer = setInterval(()=>playBeep(440,300),800); 
}

function stopRing(){ 
  if(ringTimer){ 
    clearInterval(ringTimer); 
    ringTimer = null; 
  } 
}

// ÿØÿßŸÑÿ© ŸÑÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©
function stopContinuousNotifications() {
  if (continuousNotificationInterval) {
    clearInterval(continuousNotificationInterval);
    continuousNotificationInterval = null;
  }
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÜŸáÿßÿ¶Ÿä ÿπŸÜÿØ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ™ÿ®ÿπ
  if (localNotificationSettings.enabled && arrivalNotificationShown) {
    sendEnhancedNotification(
      `‚úÖ ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ™ÿ®ÿπ`, 
      `ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ±ÿ≠ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠\n\nÿ¥ŸÉÿ±ÿßŸã ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸÉ Train Alert Pro\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
      '‚úÖ',
      {
        urgent: false,
        sound: true,
        vibrate: true,
        vibratePattern: [100, 50, 100],
        frequency: 880,
        duration: 200
      }
    );
  }
  
  stopRing();
  arrivedFlag = false;
  userConfirmedArrival = false; // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  
  // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸàÿµŸàŸÑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸÅÿ™Ÿàÿ≠ÿ©
  document.getElementById('arrivalNotificationModal').classList.remove('active');
  document.getElementById('highVolumeNotification').classList.remove('active');
}

/* Map init ŸÖÿπ ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° */
function initMap(){
  if (!mapVisible) return;
  
  const mapContainer = document.getElementById('map');
  const mapError = document.getElementById('mapError');
  
  if (!mapContainer || mapContainer.offsetParent === null) {
    return;
  }
  
  try {
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖŸÉÿ™ÿ®ÿ© Leaflet
    if (typeof L === 'undefined') {
      throw new Error('ŸÖŸÉÿ™ÿ®ÿ© Leaflet ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©');
    }
    
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑÿ£ÿØÿßÿ°
    map = L.map('map', { 
      preferCanvas: true,
      zoomControl: true,
      updateWhenIdle: !PERFORMANCE_OPTIMIZATIONS.dataSaver,
      updateWhenZooming: !PERFORMANCE_OPTIMIZATIONS.dataSaver,
      worldCopyJump: true
    }).setView([STATIONS[Math.floor(STATIONS.length/2)].lat, STATIONS[Math.floor(STATIONS.length/2)].lng], 7);
    
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ∑ÿ®ŸÇÿßÿ™ ÿÆŸÅŸäŸÅÿ© ŸÑŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑÿ∂ÿπŸäŸÅ
    const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 16, // ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿ™ÿµÿ∫Ÿäÿ± ŸÑÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
      updateWhenIdle: !PERFORMANCE_OPTIMIZATIONS.dataSaver,
      updateWhenZooming: !PERFORMANCE_OPTIMIZATIONS.dataSaver
    }).addTo(map);
    
    // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ÿÆÿ∑ÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
    tileLayer.on('tileerror', function(error) {
      console.error('Map tile error:', error);
      if (!mapError.classList.contains('hidden')) return;
      
      mapError.classList.remove('hidden');
      setTimeout(() => {
        mapError.classList.add('hidden');
      }, 5000);
    });
    
    const latlngs = STATIONS.map(s=>[s.lat,s.lng]);
    routeLine = L.polyline(latlngs, { color: '#c9a84a', weight:4, opacity:0.95 }).addTo(map);
    
    // ÿ™ŸÇŸÑŸäŸÑ ÿπÿØÿØ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ©
    STATIONS.forEach((s,i)=> {
      if (i % 3 === 0 || i < 5 || i > STATIONS.length - 5) { // ÿπÿ±ÿ∂ ÿπŸÑÿßŸÖÿßÿ™ ÿ£ŸÇŸÑ
        const marker = L.circleMarker([s.lat,s.lng], { 
          radius:4, 
          fillColor:'#c9a84a', 
          color:'#fff', 
          weight:1, 
          fillOpacity:0.8 
        }).addTo(map);
        
        if (i < 5 || i > STATIONS.length - 5) {
          marker.bindTooltip(`${i+1}. ${s.name}`);
        }
      }
    });
    
    trainMarker = L.marker([STATIONS[0].lat, STATIONS[0].lng], { title:'ŸÇÿ∑ÿßÿ±' }).addTo(map);
    userMarker = L.circleMarker([STATIONS[0].lat, STATIONS[0].lng], { 
      radius:6, 
      fillColor:'#ff5a5f', 
      color:'#fff', 
      weight:1, 
      fillOpacity:1 
    }).addTo(map);
    
    map.fitBounds(latlngs);
    
  } catch (error) {
    console.error('Error initializing map:', error);
    showToast('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©: ' + error.message);
    
    // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿÆÿ∑ÿ£ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    mapError.classList.remove('hidden');
  }
}

// Function to update map visibility
function updateMapVisibility() {
  const rightCol = document.getElementById('rightCol');
  const layout = document.getElementById('layout');
  const mapToggleSetting = document.getElementById('mapToggleSetting');
  
  if (mapVisible) {
    rightCol.classList.add('active');
    layout.classList.remove('no-map');
    if (mapToggleSetting) mapToggleSetting.checked = true;
    
    if (!map) {
      setTimeout(() => {
        initMap();
        if (map) {
          setTimeout(() => {
            map.invalidateSize();
          }, 300);
        }
      }, 100);
    } else {
      setTimeout(() => {
        map.invalidateSize();
      }, 300);
    }
  } else {
    rightCol.classList.remove('active');
    layout.classList.add('no-map');
    if (mapToggleSetting) mapToggleSetting.checked = false;
  }
  
  localStorage.setItem('mapVisible', mapVisible ? 'true' : 'false');
}

// Toggle map visibility
function toggleMapVisibility() {
  mapVisible = !mapVisible;
  updateMapVisibility();
  showToast(mapVisible ? 'ÿ™ŸÖ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©' : 'ÿ™ŸÖ ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
}

// Throttled functions for better performance
function throttle(func, limit) {
  let inThrottle;
  return function() {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  }
}

function setUserMarker(lat,lng){ 
  if(userMarker && map) userMarker.setLatLng([lat,lng]); 
}

function setTrainMarker(lat,lng){ 
  if(trainMarker && map) trainMarker.setLatLng([lat,lng]); 
}

// Throttled panTo for better performance
const panTo = throttle(function(lat,lng){ 
  if (map && mapVisible) {
    map.panTo([lat,lng]);
  }
}, 500); // ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÅÿßÿµŸÑ ÿßŸÑÿ≤ŸÖŸÜŸä ŸÑÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ£ÿØÿßÿ°

/* Build selects & timeline */
function buildSelects(){
  const startSel = document.getElementById('startSelect'), destSel = document.getElementById('destSelect');
  startSel.innerHTML=''; destSel.innerHTML='';
  STATIONS.forEach((s,i)=>{
    const o1 = document.createElement('option'); o1.value = i; o1.textContent = `${i+1} - ${s.name}`; startSel.appendChild(o1);
    const o2 = document.createElement('option'); o2.value = i; o2.textContent = `${i+1} - ${s.name}`; destSel.appendChild(o2);
  });
  startSel.value = 0; destSel.value = STATIONS.length - 1;
}

function buildRoute(){
  const start = +document.getElementById('startSelect').value;
  const dest = +document.getElementById('destSelect').value;
  routeIndices = [];
  if(start === dest) routeIndices = [start];
  else if(start < dest) for(let i=start;i<=dest;i++) routeIndices.push(i);
  else for(let i=start;i>=dest;i--) routeIndices.push(i);
  
  trackingState.startIdx = start;
  trackingState.destIdx = dest;
  
  // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßÿ± ŸÅŸä localStorage
  localStorage.setItem('trackingState', JSON.stringify(trackingState));
  
  renderTimeline();
  const latlngs = routeIndices.map(i=>[STATIONS[i].lat, STATIONS[i].lng]);
  if(latlngs.length && map && mapVisible) {
    try {
      map.fitBounds(latlngs, { padding:[20,20] }); // ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ≠ÿ¥Ÿà ŸÑÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ£ÿØÿßÿ°
    } catch (e) {
      console.log('Map bounds error:', e);
    }
  }
  document.getElementById('routeInfo').textContent = `ÿßŸÑŸÖÿ≥ÿßÿ±: ${STATIONS[start].name} ‚Üí ${STATIONS[dest].name} ¬∑ ŸÖÿ≠ÿ∑ÿßÿ™: ${routeIndices.length}`;
}

function renderTimeline(){
  const t = document.getElementById('timeline'); 
  t.innerHTML = '';
  
  const fragment = document.createDocumentFragment();
  
  routeIndices.forEach((idx,pos)=>{
    const s = STATIONS[idx];
    const el = document.createElement('div'); 
    el.className = 'station'; 
    el.dataset.idx = idx;
    el.innerHTML = `<div class="rail"><div class="dot"></div></div><div class="meta"><div class="name">${s.name}</div><div class="small">#${idx+1}</div></div><div style="font-weight:800;color:var(--muted)">${pos+1}</div>`;
    fragment.appendChild(el);
  });
  
  t.appendChild(fragment);
}

/* Nearest finder ŸÖÿ≠ÿ≥ŸÜ */
function findNearestStation(lat,lng){
  let min = Infinity, idx = 0;
  
  // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸÇÿ∑ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ© ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿßÿ± ŸÑÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ£ÿØÿßÿ°
  const searchStations = routeIndices.length > 0 ? 
    routeIndices.map(i => STATIONS[i]) : 
    STATIONS;
  
  searchStations.forEach((s,i)=>{
    const d = haversineKm(lat,lng,s.lat,s.lng);
    if(d < min){ 
      min = d; 
      idx = STATIONS.indexOf(s);
    }
  });
  return { idx, distKm:min };
}

// ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©
function checkStationProximity(lat, lng, accuracy) {
  const now = Date.now();
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿ±Ÿàÿ± ŸÅÿ™ÿ±ÿ© ŸÉÿßŸÅŸäÿ© ŸÖŸÜÿ∞ ÿ¢ÿÆÿ± ŸÅÿ≠ÿµ
  if (now - stationProximityCheck.lastCheckTime < stationProximityCheck.checkInterval) {
    return false;
  }
  
  stationProximityCheck.lastCheckTime = now;
  
  // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÇÿ±ÿ® ŸÖÿ≠ÿ∑ÿ©
  const nearest = findNearestStation(lat, lng);
  const nearestStation = STATIONS[nearest.idx];
  const distance = nearest.distKm;
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿØŸÇÿ© GPS
  if (accuracy > 100) {
    console.log('ÿØŸÇÿ© GPS ŸÖŸÜÿÆŸÅÿ∂ÿ© ÿ¨ÿØŸãÿßÿå Ÿäÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑ ŸÅÿ≠ÿµ ÿßŸÑŸÇÿ±ÿ®');
    return false;
  }
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ŸÖÿπ ŸÖÿ±ÿßÿπÿßÿ© ÿØŸÇÿ© GPS
  const adjustedDistance = distance - (accuracy / 1000); // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿØŸÇÿ© ŸÖŸÜ ŸÖÿ™ÿ± ÿ•ŸÑŸâ ŸÉŸÖ
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©
  if (adjustedDistance <= stationProximityCheck.arrivalThreshold) {
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿ© ŸáŸä ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸàÿ¨Ÿáÿ©
    const destIndex = +document.getElementById('destSelect').value;
    if (nearest.idx === destIndex) {
      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜŸÜÿß ŸÑŸÖ ŸÜÿ§ŸÉÿØ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ≠ÿ∑ÿ© ŸÖŸÜ ŸÇÿ®ŸÑ
      if (!stationProximityCheck.confirmedStations.has(nearest.idx)) {
        stationProximityCheck.confirmedStations.add(nearest.idx);
        return true;
      }
    }
  }
  
  return false;
}

/* Core update position ŸÖÿπ ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° */
let passedStations = new Set();

function updatePosition(lat,lng,accuracy,ts = Date.now()){
  // ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ¨ŸàÿØÿ© ÿßŸÑÿ¥ÿ®ŸÉÿ©
  const now = Date.now();
  if (now - lastPositionUpdate < positionUpdateInterval) {
    return;
  }
  lastPositionUpdate = now;
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© GPS
  updateGpsStatus(accuracy);
  
  // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
  document.getElementById('debugCurrentLocation').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  
  setUserMarker(lat,lng);
  setTrainMarker(lat,lng);
  panTo(lat,lng);

  const nearest = findNearestStation(lat,lng);
  const nearestGlobal = nearest.idx;
  const inRoutePos = routeIndices.indexOf(nearestGlobal);
  
  // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
  document.getElementById('debugNearestStation').textContent = STATIONS[nearestGlobal].name;
  document.getElementById('debugDistanceToStation').textContent = `${nearest.distKm.toFixed(2)} ŸÉŸÖ`;

  // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™
  document.querySelectorAll('.station').forEach(el => { 
    const idx = parseInt(el.dataset.idx);
    el.classList.remove('active','next','passed','warning'); 
    el.querySelector('.dot').style.background = 'rgba(255,255,255,0.05)';
  });

  // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™ ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ© ÿ®ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿÆÿ∂ÿ±
  if (inRoutePos !== -1) {
    for (let i = 0; i < inRoutePos; i++) {
      const passedIdx = routeIndices[i];
      const passedEl = document.querySelector(`.station[data-idx="${passedIdx}"]`);
      if (passedEl) {
        passedEl.classList.add('passed');
        passedStations.add(passedIdx);
      }
    }
    
    const curIdx = routeIndices[inRoutePos];
    const curEl = document.querySelector(`.station[data-idx="${curIdx}"]`);
    if(curEl){ 
      curEl.classList.add('active'); 
      curEl.querySelector('.dot').style.background = '#fff'; 
    }
    
    const nextPos = inRoutePos + 1;
    if(nextPos < routeIndices.length){
      const nextIdx = routeIndices[nextPos];
      const nextEl = document.querySelector(`.station[data-idx="${nextIdx}"]`);
      if(nextEl){ 
        nextEl.classList.add('next'); 
        nextEl.querySelector('.dot').style.background = 'var(--gold-2)'; 
      }
    }
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÑŸÑŸÖÿ≠ÿ∑ÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ÿ®ÿπÿØ ÿßŸÑŸÖÿ≠ÿ∑ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
    const warningPos = inRoutePos + 2;
    if(warningPos < routeIndices.length){
      const warningIdx = routeIndices[warningPos];
      const warningEl = document.querySelector(`.station[data-idx="${warningIdx}"]`);
      if(warningEl){ 
        warningEl.classList.add('warning'); 
        warningEl.querySelector('.dot').style.background = 'var(--warning)'; 
      }
    }
    
    const progress = ((inRoutePos + 1) / routeIndices.length) * 100;
    document.getElementById('routeProgress').style.width = `${progress}%`;
  } else {
    const elg = document.querySelector(`.station[data-idx="${nearestGlobal}"]`);
    if(elg){ 
      elg.classList.add('next'); 
      elg.querySelector('.dot').style.background = 'var(--gold-2)'; 
    }
  }

  let remaining = 0;
  if(inRoutePos !== -1) remaining = routeIndices.length - 1 - inRoutePos;
  else { const dest = +document.getElementById('destSelect').value; remaining = Math.abs(dest - nearestGlobal); }
  
  // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
  document.getElementById('debugRemainingStations').textContent = remaining;

  const destIndex = +document.getElementById('destSelect').value;
  const remainingKm = haversineKm(lat,lng, STATIONS[destIndex].lat, STATIONS[destIndex].lng);

  let speedKmh = 0;
  if(lastPos && lastTs){
    const dkm = haversineKm(lastPos.lat,lastPos.lng,lat,lng);
    const dt = (ts - lastTs)/1000;
    if(dt > 0) speedKmh = (dkm/dt)*3600;
  }
  const effSpeed = speedKmh > 3 ? speedKmh : 60;
  const etaSec = (remainingKm / effSpeed) * 3600;
  
  document.getElementById('routeInfo').textContent = 
    `ÿ£ŸÇÿ±ÿ®: ${STATIONS[nearestGlobal].name} ¬∑ ŸÖÿ™ÿ®ŸÇŸä: ${remaining} ŸÖÿ≠ÿ∑ÿ© ¬∑ ${remainingKm.toFixed(2)} ŸÉŸÖ ¬∑ ÿ≥ÿ±ÿπÿ©: ${speedKmh>0.2?speedKmh.toFixed(1)+' ŸÉŸÖ/ÿ≥':'‚Äî'} ¬∑ ETA: ${formatETA(etaSec)}`;
  
  // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ§ÿ¥ÿ± ÿßŸÑŸÇÿ±ÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿ©
  updateProximityIndicator(remainingKm, remaining);

  // pre-warn: remaining == 2 - ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑÿ∂ŸÖÿßŸÜ ÿπŸÖŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  const currentTime = Date.now();
  if(remaining === 2 && preWarnedAt !== nearestGlobal && localNotificationSettings.warningNotifications){
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿ±Ÿàÿ± 30 ÿ´ÿßŸÜŸäÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÖŸÜÿ∞ ÿ¢ÿÆÿ± ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ≠ÿ∞Ÿäÿ±
    if (currentTime - lastWarningNotificationTime > 30000) {
      preWarnedAt = nearestGlobal;
      lastWarningNotificationTime = currentTime;
      preWarnAction(STATIONS[nearestGlobal], remainingKm);
    }
  }

  // arrival - ÿ™ÿπÿØŸäŸÑ ŸÑÿ∂ŸÖÿßŸÜ ÿπŸÖŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿßŸÑŸàÿµŸàŸÑ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
  if((remaining === 0 || remainingKm <= 0.6) && !arrivedFlag){
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©
    if (checkStationProximity(lat, lng, accuracy)) {
      arrivedFlag = true;
      lastArrivalNotificationTime = currentTime;
      arrivalAction(STATIONS[destIndex]);
    }
  }
  // ŸÑÿß Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ arrivedFlag ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã

  lastPos = { lat, lng }; lastTs = ts;
}

/* Actions */
function preWarnAction(station, km){
  console.log('ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÇÿ®ŸÑ ŸÖÿ≠ÿ∑ÿ™ŸäŸÜ:', station.name, km);
  
  playBeep(1200,160);
  addNotification(`ŸÇÿ®ŸÑ ŸÖÿ≠ÿ∑ÿ™ŸäŸÜ - ${station.name}`, `ÿ™ÿ®ŸÇŸâ ÿ≠ŸàÿßŸÑŸä ${km.toFixed(2)} ŸÉŸÖ`);
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπÿ≤ÿ≤ ŸÑŸÑÿ™ÿ≠ÿ∞Ÿäÿ±
  sendEnhancedNotification(
    `‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÇÿ®ŸÑ ŸÖÿ≠ÿ∑ÿ™ŸäŸÜ`, 
    `ÿßŸÑŸÇÿ∑ÿßÿ± ŸäŸÇÿ™ÿ±ÿ® ŸÖŸÜ ŸÖÿ≠ÿ∑ÿ© ${station.name}\nÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©: ${km.toFixed(2)} ŸÉŸÖ\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
    '‚ö†Ô∏è',
    {
      sound: true,
      vibrate: true,
      vibratePattern: [100, 50, 100],
      frequency: 1200,
      duration: 160
    }
  );
  
  const el = document.querySelector(`.station[data-idx="${STATIONS.indexOf(station)}"]`);
  if(el) {
    el.animate([
      {transform:'scale(1)', boxShadow:'0 0 0 0 rgba(201,168,74,0.4)'},
      {transform:'scale(1.05)', boxShadow:'0 0 20px 10px rgba(201,168,74,0)'},
      {transform:'scale(1)', boxShadow:'0 0 0 0 rgba(201,168,74,0)'}
    ],{duration:1000});
  }
}

function addNotification(title, body, urgent = false) {
  const notification = {
    id: Date.now(),
    title,
    body,
    time: new Date().toLocaleTimeString('ar-EG'),
    read: false
  };
  
  notifications.unshift(notification);
  incrementNotificationCount();
  addNotificationToList(notification);
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπÿ≤ÿ≤ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿπÿßÿØŸä
  sendEnhancedNotification(title, body, 'üîî', { urgent: urgent });
  
  // ÿ•ÿ∏Ÿáÿßÿ± toast ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
  if (!localNotificationSettings.enabled) {
    showToast(title + (body ? ' ‚Äî ' + body : ''));
  }
}

function addNotificationToList(notification) {
  const notificationsList = document.getElementById('notificationsList');
  const notificationItem = document.createElement('div');
  notificationItem.className = 'notification-item';
  notificationItem.innerHTML = `
    <div>${notification.title}</div>
    <div class="small">${notification.body}</div>
    <div class="notification-time">${notification.time}</div>
  `;
  
  notificationsList.insertBefore(notificationItem, notificationsList.firstChild);
  
  // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ŸÄ 10 ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸÇÿ∑
  if (notificationsList.children.length > 10) {
    notificationsList.removeChild(notificationsList.lastChild);
  }
}

function incrementNotificationCount() {
  notificationCount++;
  const badge = document.getElementById('notificationBadge');
  badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
  badge.classList.remove('hidden');
}

/* Geolocation & tracking ŸÖÿ≠ÿ≥ŸÜ */
function toggleTracking(){
  if(isTracking) {
    stopTracking();
  } else {
    startTracking();
  }
}

function startTracking(){
  if(!('geolocation' in navigator)){ 
    alert('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ'); 
    return; 
  }
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÇÿ®ŸÑ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ
  if (!localNotificationSettings.enabled) {
    showToast('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã');
    showNotificationPermissionModal();
    return;
  }
  
  buildRoute();
  
  isTracking = true;
  isMainTab = true;
  trackingState.active = true;
  
  // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸÅŸä localStorage
  localStorage.setItem('isTracking', 'true');
  localStorage.setItem('trackingState', JSON.stringify(trackingState));
  
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ
  arrivedFlag = false;
  arrivalNotificationShown = false;
  userConfirmedArrival = false;
  
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÖÿ§ŸÇÿ™ÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  lastWarningNotificationTime = 0;
  lastArrivalNotificationTime = 0;
  lastContinuousNotificationTime = 0;
  
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ™ÿ≠ÿ≥ŸäŸÜ GPS
  gpsImprovementAttempts = 0;
  stopGPSImprovement();
  
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÇÿ±ÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ∑ÿßÿ™
  stationProximityCheck.lastCheckTime = 0;
  stationProximityCheck.confirmedStations.clear();
  
  // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  const trackingBtn = document.getElementById('trackingBtn');
  const trackingIcon = document.getElementById('trackingIcon');
  const trackingText = document.getElementById('trackingText');
  
  trackingBtn.classList.add('active');
  trackingIcon.textContent = '‚èπÔ∏è';
  trackingText.textContent = 'ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ™ÿ®ÿπ';
  
  updateTrackingStatusInfo('ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸÜÿ¥ÿ∑ - Ÿäÿ™ŸÖ ÿ™ÿ™ÿ®ÿπ ŸÖŸàŸÇÿπŸÉ');
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπÿ≤ÿ≤ ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ
  const startStation = STATIONS[trackingState.startIdx].name;
  const destStation = STATIONS[trackingState.destIdx].name;
  
  sendEnhancedNotification(
    `üöÄ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ`, 
    `ÿ™ŸÖ ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ±ÿ≠ŸÑÿ© ŸÖŸÜ ${startStation} ÿ•ŸÑŸâ ${destStation}\n\n‚è∞ ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿ°: ${new Date().toLocaleTimeString('ar-EG')}\n\nüìç ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπŸÑÿßŸÖŸÉ ŸÇÿ®ŸÑ ŸÉŸÑ ŸÖÿ≠ÿ∑ÿ©`,
    'üöÄ',
    {
      sound: true,
      vibrate: true,
      vibratePattern: [100, 50, 100],
      frequency: 880,
      duration: 200
    }
  );
  
  if('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied'){
    Notification.requestPermission().then(p => {
      if (p === 'granted') {
        // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸä localStorage
        localStorage.setItem('notificationPermission', 'granted');
        localStorage.setItem('notificationsEnabled', 'true');
      }
    });
  }

  try{ 
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 
    if(audioCtx.state === 'suspended') audioCtx.resume(); 
  }catch(e){}

  tryWakeLock();

  if(watchId) navigator.geolocation.clearWatch(watchId);
  
  // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ
  const geoOptions = {
    enableHighAccuracy: true, // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿØŸÇÿ© ÿßŸÑÿπÿßŸÑŸäÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã
    maximumAge: 5000, // 5 ÿ´ŸàÿßŸÜŸç ŸÅŸÇÿ∑
    timeout: 15000     // 15 ÿ´ÿßŸÜŸäÿ©
  };
  
  watchId = navigator.geolocation.watchPosition(
    p => {
      updatePosition(p.coords.latitude, p.coords.longitude, p.coords.accuracy, p.timestamp || Date.now());
    }, 
    err => {
      console.warn('geo error', err);
      let errorMsg = 'ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ. ';
      switch(err.code) {
        case err.PERMISSION_DENIED:
          errorMsg += 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ.';
          break;
        case err.POSITION_UNAVAILABLE:
          errorMsg += 'ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©.';
          break;
        case err.TIMEOUT:
          errorMsg += 'ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÖŸáŸÑÿ©.';
          break;
      }
      showToast(errorMsg);
      
      // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ÿ≥ŸäŸÜ GPS ÿπŸÜÿØ ÿßŸÑÿÆÿ∑ÿ£
      if (err.code === err.TIMEOUT && gpsImprovementAttempts < 3) {
        setTimeout(() => {
          improveGPSAccuracy();
        }, 2000);
      }
    }, 
    geoOptions
  );
}

function stopTracking(){
  if(watchId){ 
    navigator.geolocation.clearWatch(watchId); 
    watchId = null; 
  }
  
  // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©
  stopContinuousNotifications();
  
  // ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ≠ÿ≥ŸäŸÜ GPS
  stopGPSImprovement();
  
  releaseWakeLock();
  
  isTracking = false;
  trackingState.active = false;
  
  // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸÅŸä localStorage
  localStorage.setItem('isTracking', 'false');
  localStorage.setItem('trackingState', JSON.stringify(trackingState));
  
  // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
  const trackingBtn = document.getElementById('trackingBtn');
  const trackingIcon = document.getElementById('trackingIcon');
  const trackingText = document.getElementById('trackingText');
  
  trackingBtn.classList.remove('active');
  trackingIcon.textContent = 'üöÄ';
  trackingText.textContent = 'ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ™ÿ®ÿπ';
  
  updateTrackingStatusInfo('ÿßŸÑÿ™ÿ™ÿ®ÿπ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑');
  
  isMainTab = false;
}

/* Wake Lock best-effort */
async function tryWakeLock(){
  if('wakeLock' in navigator && !wakeLock){
    try{
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', ()=>{ 
        wakeLock = null; 
      });
    }catch(e){ 
      console.warn('WakeLock failed', e); 
    }
  }
}

async function releaseWakeLock(){
  try{ 
    if(wakeLock){ 
      await wakeLock.release(); 
      wakeLock = null; 
    } 
  }catch(e){}
}

/* Update UI from tracking state */
function updateUIFromTrackingState() {
  document.getElementById('startSelect').value = trackingState.startIdx;
  document.getElementById('destSelect').value = trackingState.destIdx;
  buildRoute();
}

function updateTrackingStatusInfo(message) {
  const trackingStatusInfo = document.getElementById('trackingStatusInfo');
  trackingStatusInfo.innerHTML = `<p>${message}</p>`;
}

function updateSystemStatus() {
  const lastUpdateTime = document.getElementById('lastUpdateTime');
  if (lastUpdateTime) {
    lastUpdateTime.textContent = new Date().toLocaleTimeString('ar-EG');
  }
}

/* Sidebar functionality */
function openSidebar() {
  document.getElementById('sidebar').classList.add('active');
  document.getElementById('overlay').classList.add('active');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('active');
  document.getElementById('overlay').classList.remove('active');
}

/* Test modal functionality */
function closeTestModal() {
  document.getElementById('testNotificationModal').classList.remove('active');
  document.getElementById('overlay').classList.remove('active');
}

/* About modal functionality */
function openAbout() {
  document.getElementById('aboutModal').classList.add('active');
  document.getElementById('overlay').classList.add('active');
}

function closeAbout() {
  document.getElementById('aboutModal').classList.remove('active');
  document.getElementById('overlay').classList.remove('active');
}

/* Theme toggle */
function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  const darkModeToggle = document.getElementById('darkModeToggle');
  if (darkModeToggle) {
    darkModeToggle.checked = newTheme === 'dark';
  }
  
  showToast(newTheme === 'dark' ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä' : 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÜŸáÿßÿ±Ÿä');
}

// ÿØÿßŸÑÿ© ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
function testLocalNotifications() {
  if (!localNotificationSettings.enabled) {
    showToast('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã');
    showNotificationPermissionModal();
    return;
  }
  
  // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±
  const testModal = document.getElementById('testNotificationModal');
  const testBtn = document.getElementById('testLocalNotificationsBtn');
  const progressBar = document.getElementById('testProgressBar');
  const testStatus = document.getElementById('testStatus');
  
  testModal.classList.add('active');
  testBtn.disabled = true;
  
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ ŸàÿßŸÑÿ≠ÿßŸÑÿ©
  progressBar.style.width = '0%';
  testStatus.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...';
  
  // ŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑÿ™ŸÇÿØŸÖ
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += 20;
    progressBar.style.width = `${progress}%`;
    
    if (progress >= 100) {
      clearInterval(progressInterval);
    }
  }, 200);
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿπÿ≤ÿ≤ÿ©
  const success = sendEnhancedNotification(
    'üì± ÿ±ÿ≥ÿßŸÑÿ© ÿßÿÆÿ™ÿ®ÿßÿ±', 
    `Ÿáÿ∞Ÿá ÿ±ÿ≥ÿßŸÑÿ© ÿßÿÆÿ™ÿ®ÿßÿ± ŸÖŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ Train Alert Pro\n\nÿ•ÿ∞ÿß ŸàÿµŸÑÿ™ŸÉ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿå ŸÅŸáÿ∞ÿß ŸäÿπŸÜŸä ÿ£ŸÜ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸÜÿ®ŸäŸá ŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ŸÖÿ´ÿßŸÑŸä!\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}\n\nüìç ÿßŸÑÿ≠ÿßŸÑÿ©: ŸäÿπŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠`,
    'üì±',
    {
      sound: true,
      vibrate: true,
      vibratePattern: [200, 100, 200],
      frequency: 880,
      duration: 200
    }
  );
  
  setTimeout(() => {
    clearInterval(progressInterval);
    progressBar.style.width = '100%';
    
    if (success) {
      testStatus.textContent = '‚úÖ ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™';
      testStatus.style.color = 'var(--success)';
      
      showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠');
    } else {
      testStatus.textContent = '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ - ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™';
      testStatus.style.color = 'var(--danger)';
      showToast('ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± - ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
    }
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≤ÿ± ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜŸç
    setTimeout(() => {
      testBtn.disabled = false;
    }, 3000);
  }, 1000);
}

// ÿØŸàÿßŸÑ ÿßÿÆÿ™ÿ®ÿßÿ± ÿ£ŸÜŸàÿßÿπ ŸÖÿÆÿ™ŸÑŸÅÿ© ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function testNormalNotification() {
  if (!localNotificationSettings.enabled) {
    showToast('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã');
    return;
  }
  
  sendEnhancedNotification(
    'üì± ÿ•ÿ¥ÿπÿßÿ± ÿπÿßÿØŸä', 
    `Ÿáÿ∞ÿß ÿ•ÿ¥ÿπÿßÿ± ÿπÿßÿØŸä ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
    'üì±',
    {
      sound: true,
      vibrate: true,
      vibratePattern: [100, 50, 100],
      frequency: 880,
      duration: 200
    }
  );
  
  showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿπÿßÿØŸä');
}

function testWarningNotification() {
  if (!localNotificationSettings.enabled) {
    showToast('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã');
    return;
  }
  
  sendEnhancedNotification(
    '‚ö†Ô∏è ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ≠ÿ∞Ÿäÿ±', 
    `Ÿáÿ∞ÿß ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÇÿ®ŸÑ ŸÖÿ≠ÿ∑ÿ™ŸäŸÜ ŸÖŸÜ ÿßŸÑŸàÿµŸàŸÑ\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
    '‚ö†Ô∏è',
    {
      sound: true,
      vibrate: true,
      vibratePattern: [100, 50, 100],
      frequency: 1200,
      duration: 160
    }
  );
  
  showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ≠ÿ∞Ÿäÿ±');
}

function testArrivalNotification() {
  if (!localNotificationSettings.enabled) {
    showToast('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã');
    return;
  }
  
  sendEnhancedNotification(
    'üöâ ÿ•ÿ¥ÿπÿßÿ± ŸàÿµŸàŸÑ', 
    `Ÿáÿ∞ÿß ÿ•ÿ¥ÿπÿßÿ± ŸàÿµŸàŸÑ ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ©\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
    'üöâ',
    {
      urgent: true,
      sound: true,
      vibrate: true,
      vibratePattern: [200, 100, 200, 100, 200],
      frequency: 440,
      duration: 300
    }
  );
  
  showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸàÿµŸàŸÑ');
}

function testHighVolumeNotification() {
  if (!localNotificationSettings.enabled) {
    showToast('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã');
    return;
  }
  
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿµŸàÿ™Ÿä ÿπÿßŸÑŸä
  sendHighVolumeNotification(
    'üöâ ÿ•ÿ¥ÿπÿßÿ± ÿµŸàÿ™Ÿä ÿπÿßŸÑŸä', 
    `Ÿáÿ∞ÿß ÿ•ÿ¥ÿπÿßÿ± ÿµŸàÿ™Ÿä ÿπÿßŸÑŸä ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≠ÿ∑ÿ© ŸÖÿπ ÿµŸàÿ™ ÿπÿßŸÑŸä ÿ¨ÿØÿßŸã\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
    { name: 'ŸÖÿ≠ÿ∑ÿ© ÿßÿÆÿ™ÿ®ÿßÿ±' }
  );
  
  showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿµŸàÿ™Ÿä ÿπÿßŸÑŸä');
}

function testEnhancedNotification() {
  if (!localNotificationSettings.enabled) {
    showToast('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã');
    return;
  }
  
  sendEnhancedNotification(
    'üîî ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπÿ≤ÿ≤', 
    `Ÿáÿ∞ÿß ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπÿ≤ÿ≤ ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±\n\nŸäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿÆŸäÿßÿ±ÿßÿ™ ÿ™ŸÅÿßÿπŸÑŸäÿ© Ÿàÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿµŸàÿ™Ÿäÿ© ŸàÿßŸáÿ™ÿ≤ÿßÿ≤\n\n‚è∞ ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-EG')}`,
    'üîî',
    {
      sound: true,
      vibrate: true,
      vibratePattern: [200, 100, 200],
      frequency: 880,
      duration: 200,
      primaryAction: () => {
        showToast('ÿ™ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ≤ÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä');
      },
      secondaryAction: () => {
        showToast('ÿ™ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ≤ÿ± ÿßŸÑÿ´ÿßŸÜŸàŸä');
      }
    }
  );
  
  showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿπÿ≤ÿ≤');
}

/* UI wiring & persistence */
document.getElementById('mapControlBtn').addEventListener('click', toggleMapVisibility);

document.getElementById('menuBtn').addEventListener('click', openSidebar);
document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
document.getElementById('overlay').addEventListener('click', () => {
  closeSidebar();
  closeAbout();
  closeTestModal();
  // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸàÿµŸàŸÑ ÿ£Ÿäÿ∂ÿßŸã
  document.getElementById('arrivalNotificationModal').classList.remove('active');
  document.getElementById('highVolumeNotification').classList.remove('active');
});

// Test modal
document.getElementById('closeTestModal').addEventListener('click', closeTestModal);

// About modal
document.getElementById('aboutLink').addEventListener('click', (e) => {
  e.preventDefault();
  openAbout();
});
document.getElementById('closeAbout').addEventListener('click', closeAbout);

// Tracking button
document.getElementById('trackingBtn').addEventListener('click', toggleTracking);

document.getElementById('startSelect').addEventListener('change', buildRoute);
document.getElementById('destSelect').addEventListener('change', buildRoute);

// Sidebar settings
document.getElementById('mapToggleSetting').addEventListener('change', (e) => {
  mapVisible = e.target.checked;
  updateMapVisibility();
  localStorage.setItem('mapVisible', mapVisible ? 'true' : 'false');
});

document.getElementById('notificationsToggle').addEventListener('change', (e) => {
  localStorage.setItem('notificationsEnabled', e.target.checked);
});

document.getElementById('soundToggle').addEventListener('change', (e) => {
  localStorage.setItem('soundEnabled', e.target.checked);
});

document.getElementById('vibrationToggle').addEventListener('change', (e) => {
  localStorage.setItem('vibrationEnabled', e.target.checked);
});

document.getElementById('darkModeToggle').addEventListener('change', (e) => {
  const newTheme = e.target.checked ? 'dark' : 'light';
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
});

document.getElementById('dataSaverToggle').addEventListener('change', (e) => {
  PERFORMANCE_OPTIMIZATIONS.dataSaver = e.target.checked;
  localStorage.setItem('dataSaverEnabled', e.target.checked);
  applyDataSaverSettings();
  showToast(e.target.checked ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™' : 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ Ÿàÿ∂ÿπ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
});

document.getElementById('batterySaverToggle').addEventListener('change', (e) => {
  PERFORMANCE_OPTIMIZATIONS.batterySaver = e.target.checked;
  localStorage.setItem('batterySaverEnabled', e.target.checked);
  
  if (e.target.checked) {
    positionUpdateInterval = 5000; // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ®ÿ∑ÿ£ ŸÑÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©
    showToast('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©');
  } else {
    positionUpdateInterval = PERFORMANCE_OPTIMIZATIONS.dataSaver ? 3000 : 1000;
    showToast('ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ Ÿàÿ∂ÿπ ÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©');
  }
});

// Local notifications settings
document.getElementById('localNotificationsToggle').addEventListener('change', (e) => {
  localNotificationSettings.enabled = e.target.checked;
  localStorage.setItem('localNotificationsEnabled', e.target.checked);
  updateLocalNotificationStatus();
  
  if (e.target.checked && Notification.permission === 'default') {
    showNotificationPermissionModal();
  }
  
  showToast(e.target.checked ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©' : 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©');
});

// Notification type toggles
document.getElementById('arrivalNotificationsToggle').addEventListener('change', (e) => {
  localNotificationSettings.arrivalNotifications = e.target.checked;
  localStorage.setItem('arrivalNotificationsEnabled', e.target.checked);
  showToast(e.target.checked ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ' : 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ');
});

document.getElementById('warningNotificationsToggle').addEventListener('change', (e) => {
  localNotificationSettings.warningNotifications = e.target.checked;
  localStorage.setItem('warningNotificationsEnabled', e.target.checked);
  showToast(e.target.checked ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±' : 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±');
});

document.getElementById('continuousNotificationsToggle').addEventListener('change', (e) => {
  localNotificationSettings.continuousNotifications = e.target.checked;
  localStorage.setItem('continuousNotificationsEnabled', e.target.checked);
  showToast(e.target.checked ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©' : 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©');
});

document.getElementById('enhancedNotificationsToggle').addEventListener('change', (e) => {
  localNotificationSettings.enhancedNotifications = e.target.checked;
  localStorage.setItem('enhancedNotificationsEnabled', e.target.checked);
  showToast(e.target.checked ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿπÿ≤ÿ≤ÿ©' : 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿπÿ≤ÿ≤ÿ©');
});

document.getElementById('highVolumeNotificationsToggle').addEventListener('change', (e) => {
  localNotificationSettings.highVolumeNotifications = e.target.checked;
  localStorage.setItem('highVolumeNotificationsEnabled', e.target.checked);
  showToast(e.target.checked ? 'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©' : 'ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©');
});

document.getElementById('testLocalNotificationsBtn').addEventListener('click', testLocalNotifications);

// Test notification buttons
document.getElementById('testNormalNotificationBtn').addEventListener('click', testNormalNotification);
document.getElementById('testWarningNotificationBtn').addEventListener('click', testWarningNotification);
document.getElementById('testArrivalNotificationBtn').addEventListener('click', testArrivalNotification);
document.getElementById('testHighVolumeNotificationBtn').addEventListener('click', testHighVolumeNotification);
document.getElementById('testEnhancedNotificationBtn').addEventListener('click', testEnhancedNotification);

// Clear notifications history
document.getElementById('clearNotificationsBtn').addEventListener('click', clearNotificationHistory);

// Floating button for quick settings
document.getElementById('floatingBtn').addEventListener('click', () => {
  const badge = document.getElementById('notificationBadge');
  badge.classList.add('hidden');
  notificationCount = 0;
  openSidebar();
});

// Retry map button
document.getElementById('retryMapBtn').addEventListener('click', () => {
  document.getElementById('mapError').classList.add('hidden');
  initMap();
});

// Enhanced notification buttons
document.getElementById('enhancedNotificationPrimary').addEventListener('click', () => {
  document.getElementById('enhancedNotification').classList.remove('active');
});

document.getElementById('enhancedNotificationSecondary').addEventListener('click', () => {
  document.getElementById('enhancedNotification').classList.remove('active');
});

// Notification banner button
document.getElementById('notificationBannerButton').addEventListener('click', () => {
  hideNotificationBanner();
  showNotificationPermissionModal();
});

// Notification toast close button
document.getElementById('notificationToastClose').addEventListener('click', closeNotificationToast);

// ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
document.getElementById('allowNotificationsBtn').addEventListener('click', () => {
  const statusEl = document.getElementById('notificationPermissionStatus');
  
  statusEl.textContent = 'ÿ¨ÿßÿ±Ÿä ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ...';
  statusEl.className = 'notification-permission-status info';
  statusEl.style.display = 'block';
  
  requestNotificationPermission().then(success => {
    if (success) {
      statusEl.textContent = '‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!';
      statusEl.className = 'notification-permission-status success';
      
      setTimeout(() => {
        hideNotificationPermissionModal();
      }, 2000);
    } else {
      statusEl.textContent = '‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ŸÖŸÜÿ≠ ÿßŸÑÿ•ÿ∞ŸÜ. ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑÿßÿ≠ŸÇÿßŸã ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠';
      statusEl.className = 'notification-permission-status error';
      
      setTimeout(() => {
        hideNotificationPermissionModal();
        showToast('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™. ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑŸáÿß ŸÑÿßÿ≠ŸÇÿßŸã ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠');
      }, 3000);
    }
  });
});

document.getElementById('laterNotificationsBtn').addEventListener('click', () => {
  hideNotificationPermissionModal();
  showToast('ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑÿßÿ≠ŸÇÿßŸã ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ');
});

// ÿØÿßŸÑÿ© ŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
function restoreSavedState() {
  // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  const savedNotificationsEnabled = localStorage.getItem('notificationsEnabled');
  if (savedNotificationsEnabled !== null) {
    document.getElementById('notificationsToggle').checked = savedNotificationsEnabled === 'true';
  }
  
  const savedLocalNotificationsEnabled = localStorage.getItem('localNotificationsEnabled');
  if (savedLocalNotificationsEnabled !== null) {
    document.getElementById('localNotificationsToggle').checked = savedLocalNotificationsEnabled === 'true';
    localNotificationSettings.enabled = savedLocalNotificationsEnabled === 'true';
  }
  
  const savedArrivalNotificationsEnabled = localStorage.getItem('arrivalNotificationsEnabled');
  if (savedArrivalNotificationsEnabled !== null) {
    document.getElementById('arrivalNotificationsToggle').checked = savedArrivalNotificationsEnabled === 'true';
    localNotificationSettings.arrivalNotifications = savedArrivalNotificationsEnabled === 'true';
  }
  
  const savedWarningNotificationsEnabled = localStorage.getItem('warningNotificationsEnabled');
  if (savedWarningNotificationsEnabled !== null) {
    document.getElementById('warningNotificationsToggle').checked = savedWarningNotificationsEnabled === 'true';
    localNotificationSettings.warningNotifications = savedWarningNotificationsEnabled === 'true';
  }
  
  const savedContinuousNotificationsEnabled = localStorage.getItem('continuousNotificationsEnabled');
  if (savedContinuousNotificationsEnabled !== null) {
    document.getElementById('continuousNotificationsToggle').checked = savedContinuousNotificationsEnabled === 'true';
    localNotificationSettings.continuousNotifications = savedContinuousNotificationsEnabled === 'true';
  }
  
  const savedEnhancedNotificationsEnabled = localStorage.getItem('enhancedNotificationsEnabled');
  if (savedEnhancedNotificationsEnabled !== null) {
    document.getElementById('enhancedNotificationsToggle').checked = savedEnhancedNotificationsEnabled === 'true';
    localNotificationSettings.enhancedNotifications = savedEnhancedNotificationsEnabled === 'true';
  }
  
  const savedHighVolumeNotificationsEnabled = localStorage.getItem('highVolumeNotificationsEnabled');
  if (savedHighVolumeNotificationsEnabled !== null) {
    document.getElementById('highVolumeNotificationsToggle').checked = savedHighVolumeNotificationsEnabled === 'true';
    localNotificationSettings.highVolumeNotifications = savedHighVolumeNotificationsEnabled === 'true';
  }
  
  // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ
  const savedSoundEnabled = localStorage.getItem('soundEnabled');
  if (savedSoundEnabled !== null) {
    document.getElementById('soundToggle').checked = savedSoundEnabled === 'true';
  }
  
  const savedVibrationEnabled = localStorage.getItem('vibrationEnabled');
  if (savedVibrationEnabled !== null) {
    document.getElementById('vibrationToggle').checked = savedVibrationEnabled === 'true';
  }
  
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    document.body.setAttribute('data-theme', savedTheme);
    document.getElementById('darkModeToggle').checked = savedTheme === 'dark';
  }
  
  const savedMapVisible = localStorage.getItem('mapVisible');
  if (savedMapVisible !== null) {
    mapVisible = savedMapVisible === 'true';
    document.getElementById('mapToggleSetting').checked = mapVisible;
  }
  
  const savedDataSaverEnabled = localStorage.getItem('dataSaverEnabled');
  if (savedDataSaverEnabled !== null) {
    document.getElementById('dataSaverToggle').checked = savedDataSaverEnabled === 'true';
    PERFORMANCE_OPTIMIZATIONS.dataSaver = savedDataSaverEnabled === 'true';
  }
  
  const savedBatterySaverEnabled = localStorage.getItem('batterySaverEnabled');
  if (savedBatterySaverEnabled !== null) {
    document.getElementById('batterySaverToggle').checked = savedBatterySaverEnabled === 'true';
    PERFORMANCE_OPTIMIZATIONS.batterySaver = savedBatterySaverEnabled === 'true';
  }
  
  // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ™ÿ®ÿπ
  const savedIsTracking = localStorage.getItem('isTracking');
  const savedTrackingState = localStorage.getItem('trackingState');
  
  if (savedTrackingState) {
    try {
      trackingState = JSON.parse(savedTrackingState);
      updateUIFromTrackingState();
    } catch (e) {
      console.error('Error parsing saved tracking state:', e);
    }
  }
  
  // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  const savedNotificationHistory = localStorage.getItem('notificationHistory');
  if (savedNotificationHistory) {
    try {
      notificationHistory = JSON.parse(savedNotificationHistory);
      updateNotificationHistoryUI();
    } catch (e) {
      console.error('Error parsing saved notification history:', e);
      notificationHistory = [];
    }
  }
  
  // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ∞ŸÜ ÿ®ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  const savedNotificationPermission = localStorage.getItem('notificationPermission');
  if (savedNotificationPermission === 'granted') {
    localNotificationSettings.permission = 'granted';
    localNotificationSettings.enabled = document.getElementById('localNotificationsToggle').checked;
    updateLocalNotificationStatus();
  }
  
  // ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ°
  applyDataSaverSettings();
  
  // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸÜÿ¥ÿ∑ÿßŸã ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©ÿå ÿßÿ≥ÿ£ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ Ÿäÿ±ŸäÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ™Ÿá
  if (savedIsTracking === 'true' && trackingState.active) {
    // ŸÑÿß ŸÜÿπŸäÿØ ÿßŸÑÿ™ÿ™ÿ®ÿπ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿÆÿµŸàÿµŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    // ŸàŸÑŸÉŸÜ ŸÜÿπÿ±ÿ∂ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿÆŸäÿßÿ± ÿßÿ≥ÿ™ÿπÿßÿØÿ™Ÿá
    setTimeout(() => {
      if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©ÿü')) {
        startTracking();
      }
    }, 2000);
  }
}

/* Init app */
function init(){
  // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ£ŸàŸÑÿßŸã
  restoreSavedState();
  
  // ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸàÿ±ÿßŸã ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
  if ('Notification' in window && Notification.permission === 'default') {
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ®ÿßŸÜÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ£ŸàŸÑÿßŸã
    setTimeout(() => {
      showNotificationBanner();
    }, 1000);
    
    // ÿ´ŸÖ ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜŸç
    setTimeout(() => {
      hideNotificationBanner();
      showNotificationPermissionModal();
    }, 4000);
  } else if ('Notification' in window && Notification.permission === 'granted') {
    localNotificationSettings.enabled = true;
    localNotificationSettings.permission = 'granted';
    updateLocalNotificationStatus();
  }
  
  // ŸÖÿ≠ÿßŸÉÿßÿ© ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
  let progress = 0;
  const loadingInterval = setInterval(() => {
    progress += 10;
    document.getElementById('loadingProgress').style.width = `${progress}%`;
    if (progress >= 100) {
      clearInterval(loadingInterval);
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
      }, 500);
    }
  }, 100);
  
  buildSelects();
  updateMapVisibility();
  updateLocalNotificationStatus();
  
  buildRoute();
  
  // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ÿπÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©
  addNotification('ŸÜÿ∏ÿßŸÖ ŸÖÿ≠ÿ≥ŸÜ ŸÑŸÑÿ£ÿØÿßÿ°', 'ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸäÿπŸÖŸÑ ÿ®ŸÉŸÅÿßÿ°ÿ© ÿ≠ÿ™Ÿâ ŸÖÿπ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿßŸÑÿ∂ÿπŸäŸÅ');
  addNotification('üöÜ Train Alert Pro ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ', 'ÿßÿÆÿ™ÿ± ŸÖÿ≠ÿ∑ÿ© ÿßŸÑŸÇŸäÿßŸÖ ŸàÿßŸÑŸàÿµŸàŸÑ ŸÑÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ');
  
  const obs = new MutationObserver(()=> {
    const active = document.querySelector('.station.active');
    if(active && window.innerWidth <= 900) active.scrollIntoView({ behavior:'smooth', block:'center' });
  });
  obs.observe(document.getElementById('timeline'), { childList:true, subtree:true, attributes:true, attributeFilter:['class'] });
  
  updateConnectionStatus();
  monitorNetworkQuality();
  monitorBatteryStatus();
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ®ÿßŸÜÿ™ÿ∏ÿßŸÖ
  setInterval(updateSystemStatus, 30000);
  updateSystemStatus();
  
  // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
  if (!navigator.onLine) {
    document.getElementById('offlineIndicator').classList.add('show');
  }
}

window.addEventListener('load', init);

// ŸÖŸÜÿπ ÿßŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿπÿ±ÿ∂Ÿä ÿπŸÜÿØ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ÿ™ÿ®ÿπ
window.addEventListener('beforeunload', (e) => {
  if (watchId) {
    e.preventDefault();
    e.returnValue = 'ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸäÿπŸÖŸÑÿå ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ∫ÿßÿØÿ±ÿ©ÿü';
    return e.returnValue;
  }
});

// ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ±ÿ§Ÿäÿ© ŸÑŸÖŸàÿßÿµŸÑÿ© ÿßŸÑÿ™ÿ™ÿ®ÿπ ÿπŸÜÿØŸÖÿß ŸÑÿß ÿ™ŸÉŸàŸÜ ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ®ŸàŸäÿ® ŸÖÿ±ÿ¶Ÿäÿ©
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && trackingState.active) {
    showToast('ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ÿπŸàÿØÿ™ŸÉ! ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸäÿπŸÖŸÑ');
    
    if (!isMainTab) {
      updateUIFromTrackingState();
    }
  }
});

// ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ™ÿ±ŸÉŸäÿ≤ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ∂ŸÖÿßŸÜ ÿ≠ÿßŸÑÿ© ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©
window.addEventListener('focus', () => {
  if (trackingState.active && !isMainTab) {
    updateUIFromTrackingState();
    showToast('ÿßŸÑÿ™ÿ™ÿ®ÿπ ŸäÿπŸÖŸÑ ŸÅŸä ÿ™ÿ®ŸàŸäÿ® ÿ¢ÿÆÿ±');
  }
});

// ÿ™ŸÅÿπŸäŸÑ Service Worker ŸÑŸÑÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('data:text/javascript,' + encodeURIComponent(`
      self.addEventListener('install', event => {
        self.skipWaiting();
      });
      
      self.addEventListener('activate', event => {
        event.waitUntil(clients.claim());
      });
      
      self.addEventListener('push', event => {
        const options = {
          body: event.data ? event.data.text() : 'Train Alert Pro',
          icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
          badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"%3E%3Cdefs%3E%3ClinearGradient id="a" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%23c9a84a"/%3E%3Cstop offset="100%25" style="stop-color:%23e0c77b"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="32" height="32" rx="6" fill="%230b0f12"/%3E%3Crect x="4" y="4" width="24" height="24" rx="4" fill="url(%23a)"/%3E%3Ctext x="16" y="22" font-family="Arial,sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="%230b0f12"%3ESN%3C/text%3E%3C/svg%3E',
          tag: 'train-alert',
          requireInteraction: true,
          actions: [
            { action: 'open', title: 'ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ' },
            { action: 'dismiss', title: 'ÿ™ÿ¨ÿßŸáŸÑ' }
          ]
        };
        
        event.waitUntil(
          self.registration.showNotification('Train Alert Pro', options)
        );
      });
      
      self.addEventListener('notificationclick', event => {
        event.notification.close();
        
        if (event.action === 'open') {
          event.waitUntil(
            clients.matchAll({ type: 'window' }).then(clientList => {
              for (let i = 0; i < clientList.length; i++) {
                const client = clientList[i];
                if (client.url === '/' && 'focus' in client) {
                  return client.focus();
                }
              }
              if (clients.openWindow) {
                return clients.openWindow('/');
              }
            })
          );
        }
      });
    `))
    .then(registration => {
      console.log('ServiceWorker registration successful');
      document.getElementById('debugServiceWorker').textContent = 'ŸÖÿ≥ÿ¨ŸÑ';
    })
    .catch(err => {
      console.log('ServiceWorker registration failed: ', err);
      document.getElementById('debugServiceWorker').textContent = 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ';
    });
  });
}
</script>
</body>
</html>
